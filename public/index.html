<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dog Meal Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --accent-1: #6366f1;
            --accent-2: #8b5cf6;
            --accent-3: #d946ef;
            --accent-4: #f472b6;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            overflow-x: hidden;
        }

        /* Aurora Background */
        .aurora {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .aurora-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s ease-in-out infinite;
        }

        .aurora-blob:nth-child(1) {
            width: 600px;
            height: 600px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            top: -200px;
            left: -100px;
            animation-delay: 0s;
        }

        .aurora-blob:nth-child(2) {
            width: 500px;
            height: 500px;
            background: linear-gradient(135deg, #d946ef, #f472b6);
            top: 50%;
            right: -150px;
            animation-delay: -5s;
        }

        .aurora-blob:nth-child(3) {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, #06b6d4, #6366f1);
            bottom: -100px;
            left: 30%;
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(50px, 50px) rotate(5deg); }
            50% { transform: translate(0, 100px) rotate(0deg); }
            75% { transform: translate(-50px, 50px) rotate(-5deg); }
        }

        /* Glass Cards */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--glass-shadow);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Layout */
        .app-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            text-align: center;
            padding: 40px 20px;
            color: white;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.4);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, #c7d2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            margin-top: 8px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 8px;
            padding: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 14px 28px;
            border: none;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 16px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: white;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        .nav-tab span {
            font-size: 1.2rem;
        }

        /* Main Content */
        .main-content {
            padding: 32px;
        }

        .tab-panel {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .section-title {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title span {
            font-size: 1.5rem;
        }

        /* Forms */
        .form-card {
            padding: 28px;
            margin-bottom: 32px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            font-weight: 500;
        }

        input, select {
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-1);
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        select {
            cursor: pointer;
        }

        select option {
            background: #1e293b;
            color: white;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: white;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.5);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 12px;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        /* Dog Card */
        .dog-card {
            padding: 24px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .dog-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-1);
        }

        .dog-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-1), var(--accent-3));
        }

        .dog-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .dog-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .dog-info h3 {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .dog-info p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .dog-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 4px;
        }

        /* Ingredient Card */
        .ingredient-card {
            padding: 20px;
            transition: all 0.3s;
        }

        .ingredient-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-2);
        }

        .ingredient-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .ingredient-header h3 {
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .ingredient-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-usda {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-user {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .nutrient-bars {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nutrient-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nutrient-bar label {
            width: 70px;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .bar-track {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .bar-fill.protein { background: linear-gradient(90deg, #ef4444, #f97316); }
        .bar-fill.fat { background: linear-gradient(90deg, #f59e0b, #eab308); }
        .bar-fill.carbs { background: linear-gradient(90deg, #10b981, #22c55e); }

        .nutrient-bar span {
            width: 50px;
            text-align: right;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }

        /* Recipe Card */
        .recipe-card {
            padding: 24px;
            transition: all 0.3s;
        }

        .recipe-card:hover {
            transform: translateY(-2px);
        }

        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .recipe-header h3 {
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .meals-badge {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            padding: 6px 14px;
            border-radius: 20px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .recipe-ingredients {
            margin-top: 16px;
        }

        .recipe-ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .recipe-ingredient-item:last-child {
            border-bottom: none;
        }

        .recipe-ingredient-item span {
            color: rgba(255, 255, 255, 0.8);
        }

        .recipe-ingredient-item strong {
            color: var(--accent-1);
            font-weight: 600;
        }

        /* Search */
        .search-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .search-input {
            flex: 1;
            padding: 16px 20px;
            padding-left: 48px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            color: white;
            font-size: 1rem;
            position: relative;
        }

        .search-wrapper {
            flex: 1;
            position: relative;
        }

        .search-wrapper::before {
            content: 'üîç';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        /* Search Results */
        .search-results {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-1) transparent;
        }

        .search-result {
            padding: 16px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-result:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent-1);
            transform: translateX(4px);
        }

        .search-result h4 {
            color: white;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .search-result p {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
        }

        /* Plan Results */
        .plan-result {
            margin-top: 32px;
        }

        .plan-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 32px;
            padding: 24px;
        }

        .plan-dog-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .plan-dog-info h2 {
            color: white;
            font-size: 1.75rem;
            margin-bottom: 4px;
        }

        .plan-dog-info p {
            color: rgba(255, 255, 255, 0.6);
        }

        .calorie-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .calorie-card {
            padding: 24px;
            text-align: center;
        }

        .calorie-card .value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .calorie-card .label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .calorie-card.highlight {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
        }

        .calorie-card.highlight .value {
            background: none;
            -webkit-text-fill-color: white;
            color: white;
        }

        .calorie-card.highlight .label {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Portions Table */
        .portions-section {
            margin-bottom: 32px;
        }

        .portions-section h3 {
            color: white;
            font-size: 1.25rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .portion-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
        }

        .portion-item .name {
            color: white;
            font-weight: 500;
        }

        .portion-amounts {
            display: flex;
            gap: 24px;
        }

        .portion-amount {
            text-align: right;
        }

        .portion-amount .value {
            color: var(--accent-1);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .portion-amount .label {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.75rem;
        }

        /* Warnings */
        .warnings-section {
            padding: 20px;
            border-radius: 16px;
            margin-top: 24px;
        }

        .warnings-section.has-warnings {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .warnings-section.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .warnings-section h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .warnings-section.has-warnings h4 {
            color: var(--warning);
        }

        .warnings-section.success h4 {
            color: var(--success);
        }

        .warnings-section ul {
            margin-left: 24px;
        }

        .warnings-section li {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state span {
            font-size: 64px;
            display: block;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 40px;
            color: rgba(255, 255, 255, 0.7);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-1);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .toast.info {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .main-content {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                justify-content: flex-start;
            }

            .calorie-breakdown {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-1);
            border-radius: 4px;
        }

        /* Recipe Builder */
        .recipe-builder {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 24px;
        }

        @media (max-width: 900px) {
            .recipe-builder {
                grid-template-columns: 1fr;
            }
        }

        .builder-section {
            padding: 24px;
        }

        .builder-section h3 {
            color: white;
            margin-bottom: 16px;
            font-size: 1.1rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        /* Nutrient Donut */
        .macro-display {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
        }

        .macro-item {
            text-align: center;
        }

        .macro-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            margin: 0 auto 8px;
        }

        .macro-circle.kcal { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .macro-circle.protein { background: linear-gradient(135deg, #ef4444, #f97316); }
        .macro-circle.fat { background: linear-gradient(135deg, #f59e0b, #eab308); }
        .macro-circle.carbs { background: linear-gradient(135deg, #10b981, #22c55e); }

        .macro-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
        }

        /* Unit Toggle */
        .unit-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .unit-btn {
            padding: 8px 20px;
            font-size: 0.9rem;
        }

        .unit-btn.active {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            border-color: transparent;
        }

        /* Card Actions */
        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-edit {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .btn-edit:hover {
            background: rgba(99, 102, 241, 0.3);
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal h3 {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 24px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }

        /* Ingredient Guide Styles */
        .filter-btn {
            padding: 8px 16px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            color: white;
        }

        .ingredient-category {
            margin-bottom: 15px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .category-header:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .category-header h3 {
            color: white;
            font-size: 1.1rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expand-icon {
            color: white;
            font-size: 1.5rem;
            transition: transform 0.3s;
        }

        .category-header.expanded .expand-icon {
            transform: rotate(45deg);
        }

        .category-content {
            display: none;
            padding: 15px;
            gap: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }

        .category-content.show {
            display: grid;
        }

        .ingredient-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            gap: 15px;
        }

        .ingredient-info h4 {
            color: white;
            font-size: 1rem;
            margin: 0 0 5px 0;
        }

        .ingredient-info p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            margin: 0;
            line-height: 1.4;
        }

        .ingredient-info .warning-text {
            color: #fbbf24;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        /* Simulator Styles */
        .adjustment-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .adjustment-row label {
            flex: 1;
            color: white;
            font-weight: 500;
        }

        .adjustment-row .current-value {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .adjustment-row input {
            width: 100px;
        }

        /* Nutrient Bar Styles */
        .nutrient-bar-container {
            margin-bottom: 15px;
        }

        .nutrient-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            color: white;
            font-size: 0.9rem;
        }

        .nutrient-bar-track {
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .nutrient-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 0.75rem;
            color: white;
            font-weight: bold;
        }

        .nutrient-bar-fill.excellent { background: linear-gradient(90deg, #10b981, #059669); }
        .nutrient-bar-fill.good { background: linear-gradient(90deg, #22c55e, #16a34a); }
        .nutrient-bar-fill.caution { background: linear-gradient(90deg, #eab308, #ca8a04); }
        .nutrient-bar-fill.bad { background: linear-gradient(90deg, #f97316, #ea580c); }
        .nutrient-bar-fill.dangerous { background: linear-gradient(90deg, #ef4444, #dc2626); }

        .nutrient-bar-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: white;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.excellent { background: #10b981; color: white; }
        .status-badge.good { background: #22c55e; color: white; }
        .status-badge.caution { background: #eab308; color: black; }
        .status-badge.bad { background: #f97316; color: white; }
        .status-badge.dangerous { background: #ef4444; color: white; }

        /* Overall Status Card */
        .status-card-large {
            text-align: center;
            padding: 30px;
        }

        .status-card-large .status-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .status-card-large h3 {
            color: white;
            margin-bottom: 10px;
        }

        .status-card-large p {
            color: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body>
    <!-- Aurora Background -->
    <div class="aurora">
        <div class="aurora-blob"></div>
        <div class="aurora-blob"></div>
        <div class="aurora-blob"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <div class="app-container">
        <div class="container">
            <!-- Header -->
            <header>
                <div class="logo">
                    <div class="logo-icon">üêï</div>
                </div>
                <h1>Dog Meal Planner</h1>
                <p>Precision nutrition for your best friend</p>
                <div class="unit-toggle" style="margin-top: 16px;">
                    <span style="color: rgba(255,255,255,0.7); margin-right: 12px;">Weight Unit:</span>
                    <button class="btn btn-secondary unit-btn active" data-unit="kg" onclick="setWeightUnit('kg')">kg</button>
                    <button class="btn btn-secondary unit-btn" data-unit="lbs" onclick="setWeightUnit('lbs')">lbs</button>
                </div>
            </header>

            <!-- Navigation -->
            <nav class="nav-tabs glass">
                <button class="nav-tab active" data-tab="dogs"><span>üêï</span> Dogs</button>
                <button class="nav-tab" data-tab="tracking"><span>üìä</span> Tracking</button>
                <button class="nav-tab" data-tab="ingredients"><span>ü•©</span> Ingredients</button>
                <button class="nav-tab" data-tab="recipes"><span>üìã</span> Recipes</button>
                <button class="nav-tab" data-tab="planner"><span>üçΩÔ∏è</span> Meal Planner</button>
                <button class="nav-tab" data-tab="guide"><span>üìö</span> Ingredient Guide</button>
                <button class="nav-tab" data-tab="simulator"><span>üî¨</span> What If</button>
            </nav>

            <!-- Main Content -->
            <main class="main-content glass">
                <!-- Dogs Tab -->
                <div id="dogs" class="tab-panel active">
                    <div class="section-header">
                        <h2 class="section-title"><span>üêï</span> Your Dogs</h2>
                    </div>

                    <div class="form-card glass-dark">
                        <form id="dog-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Name</label>
                                    <input type="text" id="dog-name" required placeholder="e.g., Buddy">
                                </div>
                                <div class="form-group">
                                    <label>Breed (optional)</label>
                                    <input type="text" id="dog-breed" placeholder="e.g., Golden Retriever">
                                </div>
                                <div class="form-group">
                                    <label>Current Weight (<span class="weight-unit-label">kg</span>)</label>
                                    <input type="number" id="dog-weight" step="0.1" required placeholder="e.g., 25">
                                </div>
                                <div class="form-group">
                                    <label>Target Weight (<span class="weight-unit-label">kg</span>)</label>
                                    <input type="number" id="dog-target-weight" step="0.1" placeholder="Leave empty if at ideal weight">
                                </div>
                                <div class="form-group">
                                    <label>Age (years)</label>
                                    <input type="number" id="dog-age" step="0.1" required placeholder="e.g., 3">
                                </div>
                                <div class="form-group">
                                    <label>Life Stage</label>
                                    <select id="dog-life-stage">
                                        <option value="puppy">Puppy (under 1 year)</option>
                                        <option value="adult" selected>Adult (1-7 years)</option>
                                        <option value="senior">Senior (7+ years)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Activity Level</label>
                                    <select id="dog-activity">
                                        <option value="low">Low - Senior or sedentary</option>
                                        <option value="moderate" selected>Moderate - Regular walks</option>
                                        <option value="high">High - Very active</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Target Daily Kcal (optional)</label>
                                    <input type="number" id="dog-target-kcal" step="1" placeholder="Override calculated MER">
                                </div>
                                <div class="form-group">
                                    <label>Sex</label>
                                    <select id="dog-sex">
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Neutered/Spayed</label>
                                    <select id="dog-neutered">
                                        <option value="true">Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label>Notes (allergies, medical conditions, etc.)</label>
                                    <textarea id="dog-notes" rows="2" placeholder="Any special dietary needs or medical conditions"></textarea>
                                </div>
                            </div>
                            <div class="quick-actions">
                                <button type="submit" class="btn btn-primary">
                                    <span>‚ûï</span> Add Dog
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="dogs-list" class="cards-grid">
                        <div class="empty-state">
                            <span>üêï</span>
                            <p>No dogs added yet. Add your first furry friend above!</p>
                        </div>
                    </div>
                </div>

                <!-- Tracking Tab -->
                <div id="tracking" class="tab-panel">
                    <div class="section-header">
                        <h2 class="section-title"><span>üìä</span> Daily Tracking</h2>
                    </div>

                    <!-- Dog Selector for Tracking -->
                    <div class="form-card glass-dark" style="margin-bottom: 24px;">
                        <div class="form-group">
                            <label>Select Dog</label>
                            <select id="tracking-dog-select" onchange="loadTrackingData()">
                                <option value="">Select a dog...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Daily Summary Card -->
                    <div id="daily-summary" class="glass-dark" style="padding: 24px; border-radius: 16px; margin-bottom: 24px; display: none;">
                        <h3 style="color: white; margin-bottom: 16px;">Today's Summary</h3>
                        <div class="dog-stats" style="margin-bottom: 16px;">
                            <div class="stat-box">
                                <div class="stat-value" id="summary-target">--</div>
                                <div class="stat-label">Target kcal</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="summary-fed">--</div>
                                <div class="stat-label">Fed today</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="summary-remaining">--</div>
                                <div class="stat-label">Remaining</div>
                            </div>
                        </div>
                        <div id="summary-status" style="text-align: center; padding: 12px; border-radius: 8px;"></div>
                    </div>

                    <!-- Log Meal Form -->
                    <div class="form-card glass-dark" style="margin-bottom: 24px;">
                        <h3 style="color: white; margin-bottom: 16px;">Log a Meal</h3>
                        <form id="feeding-log-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Meal Type</label>
                                    <select id="log-meal-type">
                                        <option value="breakfast">Breakfast</option>
                                        <option value="lunch">Lunch</option>
                                        <option value="dinner">Dinner</option>
                                        <option value="snack">Snack/Treat</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Calories (kcal)</label>
                                    <input type="number" id="log-kcal" step="1" required placeholder="e.g., 250">
                                </div>
                                <div class="form-group">
                                    <label>Recipe (optional)</label>
                                    <select id="log-recipe">
                                        <option value="">No recipe</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <input type="text" id="log-notes" placeholder="Optional notes">
                                </div>
                            </div>
                            <div class="quick-actions">
                                <button type="submit" class="btn btn-primary">
                                    <span>üìù</span> Log Meal
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Today's Meals -->
                    <div class="form-card glass-dark" style="margin-bottom: 24px;">
                        <h3 style="color: white; margin-bottom: 16px;">Today's Meals</h3>
                        <div id="todays-meals-list"></div>
                    </div>

                    <!-- Weight Log Section -->
                    <div class="form-card glass-dark" style="margin-bottom: 24px;">
                        <h3 style="color: white; margin-bottom: 16px;">Log Weight</h3>
                        <form id="weight-log-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Weight (<span class="weight-unit-label">kg</span>)</label>
                                    <input type="number" id="log-weight" step="0.1" required placeholder="Current weight">
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <input type="text" id="weight-log-notes" placeholder="Optional notes">
                                </div>
                            </div>
                            <div class="quick-actions">
                                <button type="submit" class="btn btn-secondary">
                                    <span>‚öñÔ∏è</span> Log Weight
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Weight History -->
                    <div class="form-card glass-dark">
                        <h3 style="color: white; margin-bottom: 16px;">Weight History</h3>
                        <div id="weight-history-list"></div>
                    </div>
                </div>

                <!-- Ingredients Tab -->
                <div id="ingredients" class="tab-panel">
                    <div class="section-header">
                        <h2 class="section-title"><span>ü•©</span> Ingredients</h2>
                    </div>

                    <div class="form-card glass-dark">
                        <h3 style="color: white; margin-bottom: 16px;">üîç Search USDA Database</h3>
                        <div class="search-container">
                            <div class="search-wrapper">
                                <input type="text" id="ingredient-search" class="search-input" placeholder="Search for ingredients (e.g., chicken breast, beef liver)">
                            </div>
                            <button class="btn btn-primary" onclick="searchIngredients()">Search</button>
                        </div>
                        <div id="search-results" class="search-results"></div>
                    </div>

                    <div class="form-card glass-dark">
                        <h3 style="color: white; margin-bottom: 16px;">‚úèÔ∏è Add Custom Ingredient</h3>
                        <form id="ingredient-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Name</label>
                                    <input type="text" id="ing-name" required placeholder="e.g., Homemade Beef Mix">
                                </div>
                                <div class="form-group">
                                    <label>Calories (per 100g)</label>
                                    <input type="number" id="ing-kcal" step="0.1" required placeholder="e.g., 250">
                                </div>
                                <div class="form-group">
                                    <label>Protein (g per 100g)</label>
                                    <input type="number" id="ing-protein" step="0.1" placeholder="e.g., 26">
                                </div>
                                <div class="form-group">
                                    <label>Fat (g per 100g)</label>
                                    <input type="number" id="ing-fat" step="0.1" placeholder="e.g., 15">
                                </div>
                                <div class="form-group">
                                    <label>Carbs (g per 100g)</label>
                                    <input type="number" id="ing-carbs" step="0.1" placeholder="e.g., 0">
                                </div>
                            </div>
                            <div class="quick-actions">
                                <button type="submit" class="btn btn-primary">
                                    <span>‚ûï</span> Add Ingredient
                                </button>
                            </div>
                        </form>
                    </div>

                    <h3 class="section-title" style="margin-bottom: 20px;"><span>üì¶</span> Saved Ingredients</h3>
                    <div id="ingredients-list" class="cards-grid">
                        <div class="empty-state">
                            <span>ü•©</span>
                            <p>No ingredients saved yet. Search USDA or add custom ingredients!</p>
                        </div>
                    </div>
                </div>

                <!-- Recipes Tab -->
                <div id="recipes" class="tab-panel">
                    <div class="section-header">
                        <h2 class="section-title"><span>üìã</span> Recipes</h2>
                    </div>

                    <div class="recipe-builder">
                        <div class="builder-section glass-dark">
                            <h3>üÜï Create New Recipe</h3>
                            <form id="recipe-form">
                                <div class="form-group">
                                    <label>Recipe Name</label>
                                    <input type="text" id="recipe-name" required placeholder="e.g., Chicken & Rice Bowl">
                                </div>
                                <div class="form-group">
                                    <label>Meals per Day</label>
                                    <select id="recipe-meals">
                                        <option value="1">1 meal</option>
                                        <option value="2" selected>2 meals</option>
                                        <option value="3">3 meals</option>
                                        <option value="4">4 meals</option>
                                    </select>
                                </div>
                                <div class="quick-actions">
                                    <button type="submit" class="btn btn-primary">Create Recipe</button>
                                </div>
                            </form>
                        </div>

                        <div class="builder-section glass-dark">
                            <h3>‚ûï Add Ingredient to Recipe</h3>
                            <div class="form-group">
                                <label>Select Recipe</label>
                                <select id="recipe-select"></select>
                            </div>
                            <div class="form-group">
                                <label>Select Ingredient</label>
                                <select id="recipe-ingredient-select"></select>
                            </div>
                            <div class="form-group">
                                <label>Amount (grams)</label>
                                <input type="number" id="recipe-ingredient-grams" placeholder="e.g., 150">
                            </div>
                            <div class="quick-actions">
                                <button class="btn btn-success" onclick="addIngredientToRecipe()">Add to Recipe</button>
                            </div>
                        </div>
                    </div>

                    <h3 class="section-title" style="margin: 32px 0 20px;"><span>üìö</span> Your Recipes</h3>
                    <div id="recipes-list" class="cards-grid">
                        <div class="empty-state">
                            <span>üìã</span>
                            <p>No recipes created yet. Create your first recipe above!</p>
                        </div>
                    </div>
                </div>

                <!-- Meal Planner Tab -->
                <div id="planner" class="tab-panel">
                    <div class="section-header">
                        <h2 class="section-title"><span>üçΩÔ∏è</span> Meal Planner</h2>
                    </div>

                    <div class="form-card glass-dark">
                        <h3 style="color: white; margin-bottom: 20px;">Calculate Feeding Plan</h3>
                        <form id="plan-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Select Dog</label>
                                    <select id="plan-dog" required></select>
                                </div>
                                <div class="form-group">
                                    <label>Select Recipe</label>
                                    <select id="plan-recipe" required></select>
                                </div>
                                <div class="form-group">
                                    <label>Kibble Calories (daily)</label>
                                    <input type="number" id="plan-kibble" value="0" min="0" placeholder="0 for homemade only">
                                </div>
                                <div class="form-group">
                                    <label>Treat Calories (daily)</label>
                                    <input type="number" id="plan-treats" value="0" min="0" placeholder="Account for treats">
                                </div>
                                <div class="form-group">
                                    <label>Prep Days (batch size)</label>
                                    <input type="number" id="plan-days" value="7" min="1" max="30" placeholder="Days to prep">
                                </div>
                            </div>
                            <div class="quick-actions">
                                <button type="submit" class="btn btn-primary">
                                    <span>üßÆ</span> Calculate Batch Plan
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="plan-result"></div>
                </div>

                <!-- Ingredient Guide Tab -->
                <div id="guide" class="tab-panel">
                    <div class="section-header">
                        <h2 class="section-title"><span>üìö</span> Ingredient Guide</h2>
                        <p style="color: rgba(255,255,255,0.7); margin-top: 8px;">Learn about dog-friendly ingredients and their health benefits</p>
                    </div>

                    <!-- Category Filter -->
                    <div class="category-filter" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="filter-btn active" data-category="all">All</button>
                        <button class="filter-btn" data-category="proteins">Proteins</button>
                        <button class="filter-btn" data-category="vegetables">Vegetables</button>
                        <button class="filter-btn" data-category="fruits">Fruits</button>
                        <button class="filter-btn" data-category="grains">Grains</button>
                        <button class="filter-btn" data-category="oils">Fats & Oils</button>
                        <button class="filter-btn" data-category="supplements">Supplements</button>
                    </div>

                    <!-- Proteins Section -->
                    <div class="ingredient-category" data-category="proteins">
                        <div class="category-header glass-dark" onclick="toggleCategory(this)">
                            <h3><span>ü•©</span> Proteins (Meats, Fish, Eggs, Organs)</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Beef (lean)</h4>
                                    <p>Muscle building, iron, B12, zinc for immune health</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Beef, ground, lean')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Chicken</h4>
                                    <p>Lean protein, glucosamine for joints, B vitamins</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Chicken, breast')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Turkey</h4>
                                    <p>Low-fat protein, selenium, tryptophan for calm</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Turkey, ground')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Lamb</h4>
                                    <p>Iron-rich, good for dogs with chicken allergies</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Lamb, ground')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Salmon</h4>
                                    <p>Omega-3 for coat/skin, brain health, anti-inflammatory</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Salmon, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Sardines</h4>
                                    <p>Omega-3, calcium (with bones), CoQ10 for heart</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Sardines, canned')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Eggs</h4>
                                    <p>Complete protein, biotin for coat, choline for brain</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Egg, whole, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Beef Liver</h4>
                                    <p class="warning-text">Vitamin A powerhouse, iron, B12 - feed sparingly (max 5% of diet)</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Beef liver, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Beef Heart</h4>
                                    <p>Taurine for heart health, CoQ10, B vitamins</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Beef heart, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Duck</h4>
                                    <p>Novel protein for allergies, rich in iron and amino acids</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Duck, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Venison</h4>
                                    <p>Novel protein for allergies, very lean</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Venison, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Cod</h4>
                                    <p>Lean white fish, iodine for thyroid</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Cod, cooked')">+ Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Vegetables Section -->
                    <div class="ingredient-category" data-category="vegetables">
                        <div class="category-header glass-dark" onclick="toggleCategory(this)">
                            <h3><span>ü•¶</span> Vegetables</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Broccoli</h4>
                                    <p>Fiber, vitamin C, cancer-fighting sulforaphane</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Broccoli, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Carrots</h4>
                                    <p>Beta-carotene for eyes, fiber, dental health</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Carrots, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Green Beans</h4>
                                    <p>Low-cal fiber, vitamins K & C, weight management</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Green beans, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Peas</h4>
                                    <p>Protein, fiber, vitamins A/K, lutein for eyes</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Peas, green, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Sweet Potato</h4>
                                    <p>Fiber, beta-carotene, vitamin B6, digestive health</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Sweet potato, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Pumpkin</h4>
                                    <p>Digestive aid, fiber for diarrhea/constipation</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Pumpkin, canned')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Spinach</h4>
                                    <p class="warning-text">Iron, antioxidants - limit due to oxalates</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Spinach, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Zucchini</h4>
                                    <p>Low-cal, potassium, vitamin C</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Zucchini, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Butternut Squash</h4>
                                    <p>Beta-carotene, fiber, potassium</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Butternut squash, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Celery</h4>
                                    <p>Fresh breath, vitamins A/C/K, low calorie</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Celery, raw')">+ Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Fruits Section -->
                    <div class="ingredient-category" data-category="fruits">
                        <div class="category-header glass-dark" onclick="toggleCategory(this)">
                            <h3><span>ü´ê</span> Fruits</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Blueberries</h4>
                                    <p>Antioxidant superfood, brain health, UTI prevention</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Blueberries, raw')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Cranberries</h4>
                                    <p>Urinary tract health, prevents bacteria adhesion</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Cranberries, raw')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Apples (no seeds)</h4>
                                    <p>Fiber, vitamins A/C, dental cleaning</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Apples, raw')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Bananas</h4>
                                    <p class="warning-text">Potassium, B6, fiber - high sugar, use sparingly</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Bananas, raw')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Watermelon (no seeds)</h4>
                                    <p>Hydration, vitamins A/B6/C, lycopene</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Watermelon, raw')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Strawberries</h4>
                                    <p>Vitamin C, fiber, teeth-whitening enzymes</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Strawberries, raw')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Cantaloupe</h4>
                                    <p>Beta-carotene, fiber, hydration</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Cantaloupe, raw')">+ Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Grains Section -->
                    <div class="ingredient-category" data-category="grains">
                        <div class="category-header glass-dark" onclick="toggleCategory(this)">
                            <h3><span>üåæ</span> Grains & Starches</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>White Rice</h4>
                                    <p>Easy to digest, good for upset stomach</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Rice, white, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Brown Rice</h4>
                                    <p>Fiber, B vitamins, manganese</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Rice, brown, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Oatmeal</h4>
                                    <p>Fiber, soothes skin allergies, B vitamins</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Oatmeal, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Quinoa</h4>
                                    <p>Complete protein, fiber, magnesium</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Quinoa, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Potato (cooked only)</h4>
                                    <p class="warning-text">Vitamin C, B6, potassium - NEVER feed raw!</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Potatoes, boiled')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Lentils</h4>
                                    <p>Protein, fiber, iron, folate</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Lentils, cooked')">+ Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Fats & Oils Section -->
                    <div class="ingredient-category" data-category="oils">
                        <div class="category-header glass-dark" onclick="toggleCategory(this)">
                            <h3><span>ü´í</span> Healthy Fats & Oils</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Salmon Oil</h4>
                                    <p>Omega-3 EPA/DHA, coat shine, joint health</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Fish oil, salmon')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Coconut Oil</h4>
                                    <p>MCTs for energy, skin health, antibacterial</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Coconut oil')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Flaxseed Oil</h4>
                                    <p>Plant omega-3 (ALA), fiber, coat health</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Flaxseed oil')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Olive Oil</h4>
                                    <p>Healthy fats, vitamin E, antioxidants</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Olive oil')">+ Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Supplements Section -->
                    <div class="ingredient-category" data-category="supplements">
                        <div class="category-header glass-dark" onclick="toggleCategory(this)">
                            <h3><span>‚ú®</span> Supplements & Superfoods</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Chia Seeds</h4>
                                    <p>Omega-3, fiber, calcium, protein</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Chia seeds')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Hemp Seeds</h4>
                                    <p>Complete protein, omega-3/6, GLA</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Hemp seeds')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Flax Seeds (ground)</h4>
                                    <p>Omega-3, fiber, lignans - must be ground to absorb</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Flaxseed, ground')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Turmeric</h4>
                                    <p>Anti-inflammatory curcumin, joint support</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Turmeric, ground')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Local Honey</h4>
                                    <p class="warning-text">Allergy relief, antibacterial - use sparingly (high sugar)</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Honey')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Parsley</h4>
                                    <p>Fresh breath, vitamins A/C/K, antioxidants</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Parsley, fresh')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Eggshell Powder</h4>
                                    <p>Calcium supplement - 1,800mg calcium per teaspoon</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Eggshell powder')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Pumpkin Seeds</h4>
                                    <p>Zinc, natural anti-parasitic properties</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Pumpkin seeds')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <div class="ingredient-info">
                                    <h4>Bone Broth</h4>
                                    <p>Joint support, gut healing, hydration</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Bone broth')">+ Add</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- What If Simulator Tab -->
                <div id="simulator" class="tab-panel">
                    <div class="section-header">
                        <h2 class="section-title"><span>üî¨</span> What If Simulator</h2>
                        <p style="color: rgba(255,255,255,0.7); margin-top: 8px;">See how ingredient changes affect your dog's nutrition</p>
                    </div>

                    <div class="form-card glass-dark">
                        <h3 style="color: white; margin-bottom: 20px;">Select Dog & Recipe</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Dog</label>
                                <select id="sim-dog" required onchange="loadSimulatorRecipe()"></select>
                            </div>
                            <div class="form-group">
                                <label>Select Recipe</label>
                                <select id="sim-recipe" required onchange="loadSimulatorRecipe()"></select>
                            </div>
                        </div>
                    </div>

                    <div id="simulator-content" style="display: none;">
                        <!-- Current Nutrition Overview -->
                        <div class="form-card glass-dark" style="margin-top: 20px;">
                            <h3 style="color: white; margin-bottom: 15px;">üìä Current Nutritional Profile</h3>
                            <div id="current-nutrition-display"></div>
                        </div>

                        <!-- Ingredient Adjustments -->
                        <div class="form-card glass-dark" style="margin-top: 20px;">
                            <h3 style="color: white; margin-bottom: 15px;">üîß Adjust Ingredients</h3>
                            <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">Change amounts below and click "Simulate" to see the impact</p>
                            <div id="ingredient-adjustments"></div>
                            <div class="quick-actions" style="margin-top: 20px;">
                                <button type="button" class="btn btn-primary" onclick="runSimulation()">
                                    <span>üî¨</span> Simulate Changes
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetSimulator()">
                                    <span>‚Ü∫</span> Reset
                                </button>
                            </div>
                        </div>

                        <!-- Simulation Results -->
                        <div id="simulation-results" style="display: none;">
                            <!-- Overall Status -->
                            <div id="overall-status-card" class="form-card glass-dark" style="margin-top: 20px;"></div>

                            <!-- Macro Pie Chart -->
                            <div class="form-card glass-dark" style="margin-top: 20px;">
                                <h3 style="color: white; margin-bottom: 15px;">ü•ß Macro Distribution</h3>
                                <div style="max-width: 400px; margin: 0 auto;">
                                    <canvas id="macro-chart"></canvas>
                                </div>
                            </div>

                            <!-- Nutrient Bars -->
                            <div class="form-card glass-dark" style="margin-top: 20px;">
                                <h3 style="color: white; margin-bottom: 15px;">üìà Nutrient Levels vs AAFCO Requirements</h3>
                                <div id="nutrient-bars"></div>
                            </div>

                            <!-- What Changed Summary -->
                            <div id="change-summary" class="form-card glass-dark" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add to Recipe Modal -->
    <div class="modal-overlay" id="add-to-recipe-modal">
        <div class="modal">
            <h3>Add to Recipe</h3>
            <p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">
                Adding: <strong id="add-ingredient-name"></strong>
            </p>
            <div class="form-group">
                <label>Select Recipe</label>
                <select id="modal-recipe-select" required></select>
            </div>
            <div class="form-group">
                <label>Amount (grams)</label>
                <input type="number" id="modal-ingredient-grams" value="100" min="1" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddToRecipeModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addIngredientToRecipe()">Add to Recipe</button>
            </div>
        </div>
    </div>

    <!-- Edit Dog Modal -->
    <div class="modal-overlay" id="edit-dog-modal">
        <div class="modal">
            <h3>Edit Dog</h3>
            <form id="edit-dog-form">
                <input type="hidden" id="edit-dog-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="edit-dog-name" required>
                </div>
                <div class="form-group">
                    <label>Breed</label>
                    <input type="text" id="edit-dog-breed" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label>Current Weight (<span class="weight-unit-label">kg</span>)</label>
                    <input type="number" id="edit-dog-weight" step="0.1" required>
                </div>
                <div class="form-group">
                    <label>Target Weight (<span class="weight-unit-label">kg</span>)</label>
                    <input type="number" id="edit-dog-target-weight" step="0.1" placeholder="Leave empty for no target">
                </div>
                <div class="form-group">
                    <label>Age (years)</label>
                    <input type="number" id="edit-dog-age" step="0.1" required>
                </div>
                <div class="form-group">
                    <label>Life Stage</label>
                    <select id="edit-dog-life-stage">
                        <option value="puppy">Puppy</option>
                        <option value="adult">Adult</option>
                        <option value="senior">Senior</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Activity Level</label>
                    <select id="edit-dog-activity">
                        <option value="low">Low</option>
                        <option value="moderate">Moderate</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Target Daily Kcal (optional)</label>
                    <input type="number" id="edit-dog-target-kcal" step="1" placeholder="Override calculated MER">
                </div>
                <div class="form-group">
                    <label>Sex</label>
                    <select id="edit-dog-sex">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Neutered/Spayed</label>
                    <select id="edit-dog-neutered">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="edit-dog-notes" rows="2" placeholder="Allergies, medical conditions, etc."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-dog-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Ingredient Modal -->
    <div class="modal-overlay" id="edit-ingredient-modal">
        <div class="modal">
            <h3>Edit Ingredient</h3>
            <form id="edit-ingredient-form">
                <input type="hidden" id="edit-ingredient-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="edit-ingredient-name" required>
                </div>
                <div class="form-group">
                    <label>Calories (per 100g)</label>
                    <input type="number" id="edit-ingredient-kcal" step="0.1" required>
                </div>
                <div class="form-group">
                    <label>Protein (g per 100g)</label>
                    <input type="number" id="edit-ingredient-protein" step="0.1">
                </div>
                <div class="form-group">
                    <label>Fat (g per 100g)</label>
                    <input type="number" id="edit-ingredient-fat" step="0.1">
                </div>
                <div class="form-group">
                    <label>Carbs (g per 100g)</label>
                    <input type="number" id="edit-ingredient-carbs" step="0.1">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-ingredient-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Recipe Modal -->
    <div class="modal-overlay" id="edit-recipe-modal">
        <div class="modal">
            <h3>Edit Recipe</h3>
            <form id="edit-recipe-form">
                <input type="hidden" id="edit-recipe-id">
                <div class="form-group">
                    <label>Recipe Name</label>
                    <input type="text" id="edit-recipe-name" required>
                </div>
                <div class="form-group">
                    <label>Meals per Day</label>
                    <select id="edit-recipe-meals">
                        <option value="1">1 meal</option>
                        <option value="2">2 meals</option>
                        <option value="3">3 meals</option>
                        <option value="4">4 meals</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-recipe-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal-overlay" id="confirm-delete-modal">
        <div class="modal">
            <h3>Confirm Delete</h3>
            <p id="delete-message" style="color: rgba(255,255,255,0.8); margin-bottom: 24px;">Are you sure you want to delete this item?</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('confirm-delete-modal')">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // Weight unit state
        let currentWeightUnit = localStorage.getItem('weightUnit') || 'kg';
        const KG_TO_LBS = 2.20462;
        const LBS_TO_KG = 0.453592;

        // Weight conversion functions
        function kgToLbs(kg) { return Math.round(kg * KG_TO_LBS * 100) / 100; }
        function lbsToKg(lbs) { return Math.round(lbs * LBS_TO_KG * 100) / 100; }
        function displayWeight(kg) {
            if (currentWeightUnit === 'lbs') {
                return `${kgToLbs(kg).toFixed(1)} lbs`;
            }
            return `${kg.toFixed(1)} kg`;
        }
        function inputToKg(value) {
            if (currentWeightUnit === 'lbs') {
                return lbsToKg(value);
            }
            return value;
        }
        function kgToInput(kg) {
            if (currentWeightUnit === 'lbs') {
                return kgToLbs(kg);
            }
            return kg;
        }

        // Set weight unit
        function setWeightUnit(unit) {
            currentWeightUnit = unit;
            localStorage.setItem('weightUnit', unit);
            document.querySelectorAll('.unit-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.unit === unit);
            });
            document.querySelectorAll('.weight-unit-label').forEach(el => {
                el.textContent = unit;
            });
            // Reload displays
            loadDogs();
        }

        // Initialize unit toggle
        function initWeightUnit() {
            document.querySelectorAll('.unit-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.unit === currentWeightUnit);
            });
            document.querySelectorAll('.weight-unit-label').forEach(el => {
                el.textContent = currentWeightUnit;
            });
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Tab switching
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        // Initial load
        initWeightUnit();
        loadDogs();
        loadIngredients();
        loadRecipes();

        // Dog form
        document.getElementById('dog-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;

            const weightInput = parseFloat(document.getElementById('dog-weight').value);
            const targetWeightInput = document.getElementById('dog-target-weight').value;
            const targetKcalInput = document.getElementById('dog-target-kcal').value;

            const data = {
                name: document.getElementById('dog-name').value,
                breed: document.getElementById('dog-breed').value || null,
                weight_kg: inputToKg(weightInput),
                target_weight_kg: targetWeightInput ? inputToKg(parseFloat(targetWeightInput)) : null,
                target_daily_kcal: targetKcalInput ? parseFloat(targetKcalInput) : null,
                age_years: parseFloat(document.getElementById('dog-age').value),
                life_stage: document.getElementById('dog-life-stage').value,
                activity_level: document.getElementById('dog-activity').value,
                neutered: document.getElementById('dog-neutered').value === 'true',
                sex: document.getElementById('dog-sex').value,
                notes: document.getElementById('dog-notes').value || null
            };

            try {
                const res = await fetch(`${API_BASE}/dog`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    e.target.reset();
                    loadDogs();
                    showToast(`${data.name} added successfully!`, 'success');
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Error adding dog', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
            btn.disabled = false;
        });

        async function loadDogs() {
            try {
                const res = await fetch(`${API_BASE}/dog`);
                const dogs = await res.json();
                const list = document.getElementById('dogs-list');
                const planSelect = document.getElementById('plan-dog');
                const trackingSelect = document.getElementById('tracking-dog-select');

                if (dogs.length === 0) {
                    list.innerHTML = `<div class="empty-state"><span>üêï</span><p>No dogs added yet. Add your first furry friend above!</p></div>`;
                    planSelect.innerHTML = '<option value="">Add a dog first</option>';
                    trackingSelect.innerHTML = '<option value="">Add a dog first</option>';
                    return;
                }

                list.innerHTML = dogs.map(dog => {
                    const breedInfo = dog.breed ? ` ¬∑ ${dog.breed}` : '';
                    const targetInfo = dog.target_weight_kg ? ` (target: ${displayWeight(dog.target_weight_kg)})` : '';
                    const dailyKcal = dog.target_daily_kcal || dog.mer || '‚Äî';
                    const lifeStageLabel = dog.life_stage ? dog.life_stage.charAt(0).toUpperCase() + dog.life_stage.slice(1) : '';

                    return `
                    <div class="dog-card glass-dark">
                        <div class="dog-header">
                            <div class="dog-avatar">üêï</div>
                            <div class="dog-info">
                                <h3>${dog.name}</h3>
                                <p>${displayWeight(dog.weight_kg)}${targetInfo}${breedInfo}</p>
                                <p style="font-size: 0.85rem; opacity: 0.7;">${dog.age_years} years ¬∑ ${lifeStageLabel} ¬∑ ${dog.activity_level}</p>
                            </div>
                        </div>
                        <div class="dog-stats">
                            <div class="stat-box">
                                <div class="stat-value">${dog.rer?.toFixed(0) || '‚Äî'}</div>
                                <div class="stat-label">RER</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${dog.mer?.toFixed(0) || '‚Äî'}</div>
                                <div class="stat-label">MER</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${typeof dailyKcal === 'number' ? dailyKcal.toFixed(0) : dailyKcal}</div>
                                <div class="stat-label">Daily kcal</div>
                            </div>
                        </div>
                        ${dog.notes ? `<p style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">üìù ${dog.notes}</p>` : ''}
                        <div class="card-actions">
                            <button class="btn btn-sm btn-edit" onclick="editDog(${dog.id})">Edit</button>
                            <button class="btn btn-sm btn-delete" onclick="confirmDeleteDog(${dog.id}, '${dog.name}')">Delete</button>
                        </div>
                    </div>
                `}).join('');

                const dogOptions = dogs.map(d => `<option value="${d.id}">${d.name} (${displayWeight(d.weight_kg)})</option>`).join('');
                planSelect.innerHTML = dogOptions;
                trackingSelect.innerHTML = '<option value="">Select a dog...</option>' + dogOptions;
            } catch (err) {
                console.error('Error loading dogs:', err);
            }
        }

        // Edit dog
        async function editDog(dogId) {
            try {
                const res = await fetch(`${API_BASE}/dog/${dogId}`);
                const dog = await res.json();

                document.getElementById('edit-dog-id').value = dog.id;
                document.getElementById('edit-dog-name').value = dog.name;
                document.getElementById('edit-dog-breed').value = dog.breed || '';
                document.getElementById('edit-dog-weight').value = kgToInput(dog.weight_kg).toFixed(1);
                document.getElementById('edit-dog-target-weight').value = dog.target_weight_kg ? kgToInput(dog.target_weight_kg).toFixed(1) : '';
                document.getElementById('edit-dog-target-kcal').value = dog.target_daily_kcal || '';
                document.getElementById('edit-dog-age').value = dog.age_years;
                document.getElementById('edit-dog-life-stage').value = dog.life_stage || 'adult';
                document.getElementById('edit-dog-activity').value = dog.activity_level;
                document.getElementById('edit-dog-sex').value = dog.sex;
                document.getElementById('edit-dog-neutered').value = dog.neutered.toString();
                document.getElementById('edit-dog-notes').value = dog.notes || '';

                openModal('edit-dog-modal');
            } catch (err) {
                showToast('Error loading dog data', 'error');
            }
        }

        // Edit dog form submit
        document.getElementById('edit-dog-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dogId = document.getElementById('edit-dog-id').value;
            const weightInput = parseFloat(document.getElementById('edit-dog-weight').value);
            const targetWeightInput = document.getElementById('edit-dog-target-weight').value;
            const targetKcalInput = document.getElementById('edit-dog-target-kcal').value;

            const data = {
                name: document.getElementById('edit-dog-name').value,
                breed: document.getElementById('edit-dog-breed').value || null,
                weight_kg: inputToKg(weightInput),
                target_weight_kg: targetWeightInput ? inputToKg(parseFloat(targetWeightInput)) : 0,
                target_daily_kcal: targetKcalInput ? parseFloat(targetKcalInput) : 0,
                age_years: parseFloat(document.getElementById('edit-dog-age').value),
                life_stage: document.getElementById('edit-dog-life-stage').value,
                activity_level: document.getElementById('edit-dog-activity').value,
                sex: document.getElementById('edit-dog-sex').value,
                neutered: document.getElementById('edit-dog-neutered').value === 'true',
                notes: document.getElementById('edit-dog-notes').value || null
            };

            try {
                const res = await fetch(`${API_BASE}/dog/${dogId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeModal('edit-dog-modal');
                    loadDogs();
                    showToast('Dog updated successfully!', 'success');
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Error updating dog', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        // Delete dog
        function confirmDeleteDog(dogId, dogName) {
            document.getElementById('delete-message').textContent = `Are you sure you want to delete ${dogName}?`;
            document.getElementById('confirm-delete-btn').onclick = () => deleteDog(dogId);
            openModal('confirm-delete-modal');
        }

        async function deleteDog(dogId) {
            try {
                const res = await fetch(`${API_BASE}/dog/${dogId}`, { method: 'DELETE' });
                if (res.ok) {
                    closeModal('confirm-delete-modal');
                    loadDogs();
                    showToast('Dog deleted successfully!', 'success');
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Error deleting dog', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        // Ingredient search
        async function searchIngredients() {
            const query = document.getElementById('ingredient-search').value;
            if (!query) return;

            const results = document.getElementById('search-results');
            results.innerHTML = `<div class="loading"><div class="spinner"></div> Searching USDA database...</div>`;

            try {
                const res = await fetch(`${API_BASE}/ingredient/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();

                // Check for API error response
                if (!res.ok) {
                    results.innerHTML = `<div class="empty-state" style="padding: 20px;"><p>Error: ${data.detail || 'Search failed'}</p></div>`;
                    return;
                }

                // API returns array directly with snake_case keys
                if (Array.isArray(data) && data.length > 0) {
                    results.innerHTML = data.slice(0, 8).map(item => {
                        const escapedDesc = item.description.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        return `
                        <div class="search-result" onclick="importFromUSDA('${item.fdc_id}', '${escapedDesc}')">
                            <h4>${item.description}</h4>
                            <p>USDA ${item.data_type || 'Food'} ¬∑ Click to import</p>
                        </div>
                    `}).join('');
                } else {
                    results.innerHTML = `<div class="empty-state" style="padding: 20px;"><p>No results found. Try a different search term.</p></div>`;
                }
            } catch (err) {
                console.error('USDA search error:', err);
                results.innerHTML = `<div class="empty-state" style="padding: 20px;"><p>Search failed: ${err.message || 'Unknown error'}</p></div>`;
            }
        }

        async function importFromUSDA(fdcId, name) {
            showToast('Importing ingredient...', 'info');
            try {
                const res = await fetch(`${API_BASE}/ingredient/from-usda`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fdc_id: fdcId })
                });
                if (res.ok) {
                    document.getElementById('search-results').innerHTML = '';
                    document.getElementById('ingredient-search').value = '';
                    loadIngredients();
                    showToast('Ingredient imported!', 'success');
                } else {
                    showToast('Import failed', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        // Custom ingredient form
        document.getElementById('ingredient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('ing-name').value,
                kcal_per_100g: parseFloat(document.getElementById('ing-kcal').value),
                protein_g_per_100g: parseFloat(document.getElementById('ing-protein').value) || 0,
                fat_g_per_100g: parseFloat(document.getElementById('ing-fat').value) || 0,
                carbs_g_per_100g: parseFloat(document.getElementById('ing-carbs').value) || 0,
                source_type: 'USER'
            };

            try {
                const res = await fetch(`${API_BASE}/ingredient/manual`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    e.target.reset();
                    loadIngredients();
                    showToast('Ingredient added!', 'success');
                } else {
                    showToast('Error adding ingredient', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        async function loadIngredients() {
            try {
                const res = await fetch(`${API_BASE}/ingredient`);
                const ingredients = await res.json();
                const list = document.getElementById('ingredients-list');
                const recipeSelect = document.getElementById('recipe-ingredient-select');

                if (ingredients.length === 0) {
                    list.innerHTML = `<div class="empty-state"><span>ü•©</span><p>No ingredients saved yet. Search USDA or add custom ingredients!</p></div>`;
                    recipeSelect.innerHTML = '<option value="">Add ingredients first</option>';
                    return;
                }

                list.innerHTML = ingredients.map(ing => `
                    <div class="ingredient-card glass-dark">
                        <div class="ingredient-header">
                            <h3>${ing.name}</h3>
                            <span class="ingredient-badge ${ing.source_type === 'USDA' ? 'badge-usda' : 'badge-user'}">${ing.source_type}</span>
                        </div>
                        <div class="macro-display">
                            <div class="macro-item">
                                <div class="macro-circle kcal">${ing.kcal_per_100g?.toFixed(0) || 0}</div>
                                <div class="macro-label">kcal</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-circle protein">${ing.protein_g_per_100g?.toFixed(0) || 0}g</div>
                                <div class="macro-label">Protein</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-circle fat">${ing.fat_g_per_100g?.toFixed(0) || 0}g</div>
                                <div class="macro-label">Fat</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-circle carbs">${ing.carbs_g_per_100g?.toFixed(0) || 0}g</div>
                                <div class="macro-label">Carbs</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-edit" onclick="editIngredient(${ing.id})">Edit</button>
                            <button class="btn btn-sm btn-delete" onclick="confirmDeleteIngredient(${ing.id}, '${ing.name.replace(/'/g, "\\'")}')">Delete</button>
                        </div>
                    </div>
                `).join('');

                recipeSelect.innerHTML = ingredients.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
            } catch (err) {
                console.error('Error loading ingredients:', err);
            }
        }

        // Edit ingredient
        async function editIngredient(ingredientId) {
            try {
                const res = await fetch(`${API_BASE}/ingredient/${ingredientId}`);
                const ing = await res.json();

                document.getElementById('edit-ingredient-id').value = ing.id;
                document.getElementById('edit-ingredient-name').value = ing.name;
                document.getElementById('edit-ingredient-kcal').value = ing.kcal_per_100g || 0;
                document.getElementById('edit-ingredient-protein').value = ing.protein_g_per_100g || 0;
                document.getElementById('edit-ingredient-fat').value = ing.fat_g_per_100g || 0;
                document.getElementById('edit-ingredient-carbs').value = ing.carbs_g_per_100g || 0;

                openModal('edit-ingredient-modal');
            } catch (err) {
                showToast('Error loading ingredient data', 'error');
            }
        }

        // Edit ingredient form submit
        document.getElementById('edit-ingredient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const ingredientId = document.getElementById('edit-ingredient-id').value;

            const data = {
                name: document.getElementById('edit-ingredient-name').value,
                kcal_per_100g: parseFloat(document.getElementById('edit-ingredient-kcal').value) || 0,
                protein_g_per_100g: parseFloat(document.getElementById('edit-ingredient-protein').value) || 0,
                fat_g_per_100g: parseFloat(document.getElementById('edit-ingredient-fat').value) || 0,
                carbs_g_per_100g: parseFloat(document.getElementById('edit-ingredient-carbs').value) || 0
            };

            try {
                const res = await fetch(`${API_BASE}/ingredient/${ingredientId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeModal('edit-ingredient-modal');
                    loadIngredients();
                    showToast('Ingredient updated successfully!', 'success');
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Error updating ingredient', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        // Delete ingredient
        function confirmDeleteIngredient(ingredientId, ingredientName) {
            document.getElementById('delete-message').textContent = `Are you sure you want to delete ${ingredientName}?`;
            document.getElementById('confirm-delete-btn').onclick = () => deleteIngredient(ingredientId);
            openModal('confirm-delete-modal');
        }

        async function deleteIngredient(ingredientId) {
            try {
                const res = await fetch(`${API_BASE}/ingredient/${ingredientId}`, { method: 'DELETE' });
                if (res.ok) {
                    closeModal('confirm-delete-modal');
                    loadIngredients();
                    showToast('Ingredient deleted successfully!', 'success');
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Error deleting ingredient', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        // Recipe form
        document.getElementById('recipe-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('recipe-name').value,
                meals_per_day: parseInt(document.getElementById('recipe-meals').value)
            };

            try {
                const res = await fetch(`${API_BASE}/recipe`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    e.target.reset();
                    loadRecipes();
                    showToast('Recipe created!', 'success');
                }
            } catch (err) {
                showToast('Error creating recipe', 'error');
            }
        });

        async function addIngredientToRecipe() {
            const recipeId = document.getElementById('recipe-select').value;
            const ingredientId = document.getElementById('recipe-ingredient-select').value;
            const grams = parseFloat(document.getElementById('recipe-ingredient-grams').value);

            if (!recipeId || !ingredientId || !grams) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/recipe/${recipeId}/ingredient`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ingredient_id: parseInt(ingredientId), grams: grams })
                });
                if (res.ok) {
                    document.getElementById('recipe-ingredient-grams').value = '';
                    loadRecipes();
                    showToast('Ingredient added to recipe!', 'success');
                }
            } catch (err) {
                showToast('Error adding ingredient', 'error');
            }
        }

        async function loadRecipes() {
            try {
                const res = await fetch(`${API_BASE}/recipe`);
                const recipes = await res.json();
                const list = document.getElementById('recipes-list');
                const recipeSelect = document.getElementById('recipe-select');
                const planRecipeSelect = document.getElementById('plan-recipe');

                if (recipes.length === 0) {
                    list.innerHTML = `<div class="empty-state"><span>üìã</span><p>No recipes created yet. Create your first recipe above!</p></div>`;
                    recipeSelect.innerHTML = '<option value="">Create a recipe first</option>';
                    planRecipeSelect.innerHTML = '<option value="">Create a recipe first</option>';
                    return;
                }

                const fullRecipes = await Promise.all(
                    recipes.map(r => fetch(`${API_BASE}/recipe/${r.id}`).then(res => res.json()))
                );

                list.innerHTML = fullRecipes.map(recipe => `
                    <div class="recipe-card glass-dark">
                        <div class="recipe-header">
                            <h3>${recipe.name}</h3>
                            <span class="meals-badge">${recipe.meals_per_day} meals/day</span>
                        </div>
                        ${recipe.ingredients && recipe.ingredients.length > 0 ? `
                            <div class="recipe-ingredients">
                                ${recipe.ingredients.map(i => `
                                    <div class="recipe-ingredient-item">
                                        <span>${i.ingredient_name || i.name}</span>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <strong>${i.grams}g</strong>
                                            <button class="btn btn-sm btn-delete" style="padding: 4px 8px;" onclick="removeIngredientFromRecipe(${recipe.id}, ${i.ingredient_id})">‚úï</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `<div class="empty-state" style="padding: 20px;"><p>No ingredients yet</p></div>`}
                        <div class="card-actions">
                            <button class="btn btn-sm btn-edit" onclick="editRecipe(${recipe.id})">Edit</button>
                            <button class="btn btn-sm btn-delete" onclick="confirmDeleteRecipe(${recipe.id}, '${recipe.name.replace(/'/g, "\\'")}')">Delete</button>
                        </div>
                    </div>
                `).join('');

                const options = recipes.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
                recipeSelect.innerHTML = options;
                planRecipeSelect.innerHTML = options;
            } catch (err) {
                console.error('Error loading recipes:', err);
            }
        }

        // Remove ingredient from recipe
        async function removeIngredientFromRecipe(recipeId, ingredientId) {
            try {
                const res = await fetch(`${API_BASE}/recipe/${recipeId}/ingredient/${ingredientId}`, { method: 'DELETE' });
                if (res.ok) {
                    loadRecipes();
                    showToast('Ingredient removed from recipe!', 'success');
                } else {
                    showToast('Error removing ingredient', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        // Edit recipe
        async function editRecipe(recipeId) {
            try {
                const res = await fetch(`${API_BASE}/recipe/${recipeId}`);
                const recipe = await res.json();

                document.getElementById('edit-recipe-id').value = recipe.id;
                document.getElementById('edit-recipe-name').value = recipe.name;
                document.getElementById('edit-recipe-meals').value = recipe.meals_per_day;

                openModal('edit-recipe-modal');
            } catch (err) {
                showToast('Error loading recipe data', 'error');
            }
        }

        // Edit recipe form submit
        document.getElementById('edit-recipe-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const recipeId = document.getElementById('edit-recipe-id').value;

            const data = {
                name: document.getElementById('edit-recipe-name').value,
                meals_per_day: parseInt(document.getElementById('edit-recipe-meals').value)
            };

            try {
                const res = await fetch(`${API_BASE}/recipe/${recipeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    closeModal('edit-recipe-modal');
                    loadRecipes();
                    showToast('Recipe updated successfully!', 'success');
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Error updating recipe', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        // Delete recipe
        function confirmDeleteRecipe(recipeId, recipeName) {
            document.getElementById('delete-message').textContent = `Are you sure you want to delete ${recipeName}?`;
            document.getElementById('confirm-delete-btn').onclick = () => deleteRecipe(recipeId);
            openModal('confirm-delete-modal');
        }

        async function deleteRecipe(recipeId) {
            try {
                const res = await fetch(`${API_BASE}/recipe/${recipeId}`, { method: 'DELETE' });
                if (res.ok) {
                    closeModal('confirm-delete-modal');
                    loadRecipes();
                    showToast('Recipe deleted successfully!', 'success');
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Error deleting recipe', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        // Feeding plan
        document.getElementById('plan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                dog_id: parseInt(document.getElementById('plan-dog').value),
                recipe_id: parseInt(document.getElementById('plan-recipe').value),
                kibble_kcal: parseFloat(document.getElementById('plan-kibble').value) || 0,
                treats_kcal: parseFloat(document.getElementById('plan-treats').value) || 0,
                num_days: parseInt(document.getElementById('plan-days').value) || 7
            };

            const resultDiv = document.getElementById('plan-result');
            resultDiv.innerHTML = `<div class="loading"><div class="spinner"></div> Calculating optimal feeding plan...</div>`;

            try {
                const res = await fetch(`${API_BASE}/plan/compute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const plan = await res.json();

                if (res.ok) {
                    resultDiv.innerHTML = `
                        <div class="plan-header glass-dark">
                            <div class="plan-dog-avatar">üêï</div>
                            <div class="plan-dog-info">
                                <h2>Batch Meal Plan for ${plan.dog_name || 'Your Dog'}</h2>
                                <p>${plan.num_days} day batch using ${plan.recipe_name || 'selected recipe'}</p>
                            </div>
                        </div>

                        <!-- Batch Summary -->
                        <div class="calorie-breakdown">
                            <div class="calorie-card glass-dark highlight">
                                <div class="value">${plan.total_meals || '‚Äî'}</div>
                                <div class="label">Meal Containers</div>
                            </div>
                            <div class="calorie-card glass-dark">
                                <div class="value">${plan.grams_per_container?.toFixed(0) || '‚Äî'}g</div>
                                <div class="label">Per Container</div>
                            </div>
                            <div class="calorie-card glass-dark">
                                <div class="value">${plan.per_meal_kcal?.toFixed(0) || '‚Äî'}</div>
                                <div class="label">kcal/meal</div>
                            </div>
                            <div class="calorie-card glass-dark">
                                <div class="value">${plan.target_kcal?.toFixed(0) || '‚Äî'}</div>
                                <div class="label">kcal/day target</div>
                            </div>
                        </div>

                        <!-- Container Instructions -->
                        <div class="form-card glass-dark" style="margin-bottom: 20px; padding: 20px;">
                            <h3 style="color: white; margin-bottom: 15px;">üì¶ How to Prep</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1.1em; margin-bottom: 10px;">
                                <strong>1.</strong> Cook/prep all ingredients using the batch amounts below
                            </p>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1.1em; margin-bottom: 10px;">
                                <strong>2.</strong> Mix everything together thoroughly
                            </p>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1.1em; margin-bottom: 10px;">
                                <strong>3.</strong> Divide into <strong>${plan.total_meals}</strong> containers of <strong>${plan.grams_per_container?.toFixed(0)}g</strong> each
                            </p>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1.1em;">
                                <strong>4.</strong> Feed <strong>${plan.meals_per_day}</strong> container(s) per day (${plan.per_meal_kcal?.toFixed(0)} kcal each)
                            </p>
                        </div>

                        ${plan.ingredient_portions && plan.ingredient_portions.length > 0 ? `
                            <div class="portions-section">
                                <h3><span>üõí</span> Batch Ingredients (${plan.num_days} days)</h3>
                                ${plan.ingredient_portions.map(p => `
                                    <div class="portion-item glass-dark">
                                        <span class="name">${p.ingredient_name}</span>
                                        <div class="portion-amounts">
                                            <div class="portion-amount" style="background: rgba(138, 43, 226, 0.3);">
                                                <div class="value">${p.total_grams_batch?.toFixed(0)}g</div>
                                                <div class="label">TOTAL BATCH</div>
                                            </div>
                                            <div class="portion-amount">
                                                <div class="value">${p.grams_per_day?.toFixed(1)}g</div>
                                                <div class="label">per day</div>
                                            </div>
                                            <div class="portion-amount">
                                                <div class="value">${p.grams_per_meal?.toFixed(1)}g</div>
                                                <div class="label">per meal</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <!-- Nutrition Summary -->
                        ${plan.nutrient_totals ? `
                            <div class="form-card glass-dark" style="margin-top: 20px; padding: 20px;">
                                <h3 style="color: white; margin-bottom: 15px;">üìä Daily Nutrition (per ${plan.homemade_kcal?.toFixed(0)} kcal)</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                                    <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                        <div style="font-size: 1.2em; font-weight: bold; color: white;">${plan.nutrient_totals.protein_g?.toFixed(1)}g</div>
                                        <div style="font-size: 0.8em; color: rgba(255,255,255,0.7);">Protein</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                        <div style="font-size: 1.2em; font-weight: bold; color: white;">${plan.nutrient_totals.fat_g?.toFixed(1)}g</div>
                                        <div style="font-size: 0.8em; color: rgba(255,255,255,0.7);">Fat</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                        <div style="font-size: 1.2em; font-weight: bold; color: white;">${plan.nutrient_totals.carbs_g?.toFixed(1)}g</div>
                                        <div style="font-size: 0.8em; color: rgba(255,255,255,0.7);">Carbs</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                        <div style="font-size: 1.2em; font-weight: bold; color: white;">${plan.nutrient_totals.calcium_mg?.toFixed(0)}mg</div>
                                        <div style="font-size: 0.8em; color: rgba(255,255,255,0.7);">Calcium</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                        <div style="font-size: 1.2em; font-weight: bold; color: white;">${plan.nutrient_totals.phosphorus_mg?.toFixed(0)}mg</div>
                                        <div style="font-size: 0.8em; color: rgba(255,255,255,0.7);">Phosphorus</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${plan.warnings && plan.warnings.length > 0 ? `
                            <div class="warnings-section has-warnings">
                                <h4>‚ö†Ô∏è AAFCO Warnings</h4>
                                <ul>
                                    ${plan.warnings.map(w => `<li>${w}</li>`).join('')}
                                </ul>
                                <p style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-top: 10px;">Consider adding supplements to address deficiencies.</p>
                            </div>
                        ` : `
                            <div class="warnings-section success">
                                <h4>‚úì Nutritionally Complete</h4>
                                <p style="color: rgba(255,255,255,0.8);">This meal plan meets AAFCO nutritional guidelines for adult dogs.</p>
                            </div>
                        `}
                    `;
                    showToast('Batch meal plan calculated!', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="warnings-section has-warnings"><h4>‚ö†Ô∏è Error</h4><p style="color: rgba(255,255,255,0.8);">${plan.detail || 'Could not calculate plan. Make sure you have a dog, recipe, and ingredients set up.'}</p></div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="warnings-section has-warnings"><h4>‚ö†Ô∏è Error</h4><p style="color: rgba(255,255,255,0.8);">Connection error. Please try again.</p></div>`;
            }
        });

        // Enter key for search
        document.getElementById('ingredient-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchIngredients();
            }
        });

        // ==================== Tracking Functions ====================

        async function loadTrackingData() {
            const dogId = document.getElementById('tracking-dog-select').value;
            if (!dogId) {
                document.getElementById('daily-summary').style.display = 'none';
                document.getElementById('todays-meals-list').innerHTML = '<p style="color: rgba(255,255,255,0.5);">Select a dog to view tracking data</p>';
                document.getElementById('weight-history-list').innerHTML = '';
                return;
            }

            // Load daily summary
            try {
                const summaryRes = await fetch(`${API_BASE}/log/summary/today/${dogId}`);
                if (summaryRes.ok) {
                    const summary = await summaryRes.json();
                    document.getElementById('daily-summary').style.display = 'block';
                    document.getElementById('summary-target').textContent = summary.target_kcal.toFixed(0);
                    document.getElementById('summary-fed').textContent = summary.total_kcal_fed.toFixed(0);
                    document.getElementById('summary-remaining').textContent = summary.remaining_kcal.toFixed(0);

                    const statusEl = document.getElementById('summary-status');
                    if (summary.on_track) {
                        statusEl.style.background = 'rgba(16, 185, 129, 0.2)';
                        statusEl.style.color = '#10b981';
                        statusEl.innerHTML = '‚úì On track! ' + (summary.remaining_kcal > 0 ? `${summary.remaining_kcal.toFixed(0)} kcal remaining` : 'Daily target reached');
                    } else {
                        statusEl.style.background = 'rgba(245, 158, 11, 0.2)';
                        statusEl.style.color = '#f59e0b';
                        statusEl.innerHTML = '‚ö†Ô∏è Over daily target by ' + (summary.total_kcal_fed - summary.target_kcal).toFixed(0) + ' kcal';
                    }
                }
            } catch (err) {
                console.error('Error loading summary:', err);
            }

            // Load today's meals
            try {
                const mealsRes = await fetch(`${API_BASE}/log/feeding/today/${dogId}`);
                if (mealsRes.ok) {
                    const meals = await mealsRes.json();
                    const mealsList = document.getElementById('todays-meals-list');
                    if (meals.length === 0) {
                        mealsList.innerHTML = '<p style="color: rgba(255,255,255,0.5);">No meals logged today</p>';
                    } else {
                        mealsList.innerHTML = meals.map(meal => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
                                <div>
                                    <strong style="color: white;">${meal.meal_type || 'Meal'}</strong>
                                    <span style="color: rgba(255,255,255,0.6); margin-left: 12px;">${meal.kcal_fed} kcal</span>
                                    ${meal.recipe_name ? `<span style="color: rgba(255,255,255,0.4); margin-left: 8px;">(${meal.recipe_name})</span>` : ''}
                                </div>
                                <button class="btn btn-sm btn-delete" onclick="deleteFeedingLog(${meal.id})">‚úï</button>
                            </div>
                        `).join('');
                    }
                }
            } catch (err) {
                console.error('Error loading meals:', err);
            }

            // Load weight history
            try {
                const weightRes = await fetch(`${API_BASE}/log/weight/dog/${dogId}?limit=10`);
                if (weightRes.ok) {
                    const weights = await weightRes.json();
                    const weightList = document.getElementById('weight-history-list');
                    if (weights.length === 0) {
                        weightList.innerHTML = '<p style="color: rgba(255,255,255,0.5);">No weight history</p>';
                    } else {
                        weightList.innerHTML = weights.map(w => {
                            const date = new Date(w.logged_at).toLocaleDateString();
                            return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
                                <div>
                                    <strong style="color: white;">${displayWeight(w.weight_kg)}</strong>
                                    <span style="color: rgba(255,255,255,0.4); margin-left: 12px;">${date}</span>
                                    ${w.notes ? `<span style="color: rgba(255,255,255,0.5); margin-left: 8px;">- ${w.notes}</span>` : ''}
                                </div>
                            </div>
                        `}).join('');
                    }
                }
            } catch (err) {
                console.error('Error loading weight history:', err);
            }

            // Populate recipe select for logging
            try {
                const recipesRes = await fetch(`${API_BASE}/recipe`);
                if (recipesRes.ok) {
                    const recipes = await recipesRes.json();
                    document.getElementById('log-recipe').innerHTML = '<option value="">No recipe</option>' +
                        recipes.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
                }
            } catch (err) {
                console.error('Error loading recipes:', err);
            }
        }

        // Feeding log form
        document.getElementById('feeding-log-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dogId = document.getElementById('tracking-dog-select').value;
            if (!dogId) {
                showToast('Please select a dog first', 'error');
                return;
            }

            const recipeId = document.getElementById('log-recipe').value;
            const data = {
                dog_id: parseInt(dogId),
                recipe_id: recipeId ? parseInt(recipeId) : null,
                meal_type: document.getElementById('log-meal-type').value,
                kcal_fed: parseFloat(document.getElementById('log-kcal').value),
                notes: document.getElementById('log-notes').value || null
            };

            try {
                const res = await fetch(`${API_BASE}/log/feeding`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    document.getElementById('log-kcal').value = '';
                    document.getElementById('log-notes').value = '';
                    loadTrackingData();
                    showToast('Meal logged successfully!', 'success');
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Error logging meal', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        // Weight log form
        document.getElementById('weight-log-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dogId = document.getElementById('tracking-dog-select').value;
            if (!dogId) {
                showToast('Please select a dog first', 'error');
                return;
            }

            const weightInput = parseFloat(document.getElementById('log-weight').value);
            const data = {
                dog_id: parseInt(dogId),
                weight_kg: inputToKg(weightInput),
                notes: document.getElementById('weight-log-notes').value || null
            };

            try {
                const res = await fetch(`${API_BASE}/log/weight`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (res.ok) {
                    document.getElementById('log-weight').value = '';
                    document.getElementById('weight-log-notes').value = '';
                    loadTrackingData();
                    loadDogs(); // Refresh dog list as weight is updated
                    showToast('Weight logged successfully!', 'success');
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Error logging weight', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        });

        async function deleteFeedingLog(logId) {
            try {
                const res = await fetch(`${API_BASE}/log/feeding/${logId}`, { method: 'DELETE' });
                if (res.ok) {
                    loadTrackingData();
                    showToast('Meal log deleted', 'success');
                } else {
                    showToast('Error deleting log', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        // ==================== Ingredient Guide Functions ====================

        function toggleCategory(header) {
            header.classList.toggle('expanded');
            const content = header.nextElementSibling;
            content.classList.toggle('show');
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const category = btn.dataset.category;
                document.querySelectorAll('.ingredient-category').forEach(cat => {
                    if (category === 'all' || cat.dataset.category === category) {
                        cat.style.display = 'block';
                    } else {
                        cat.style.display = 'none';
                    }
                });
            });
        });

        // Add to recipe modal
        let selectedIngredientName = '';

        function openAddToRecipeModal(ingredientName) {
            selectedIngredientName = ingredientName;
            document.getElementById('add-ingredient-name').textContent = ingredientName;
            document.getElementById('add-to-recipe-modal').classList.add('active');
            loadRecipesForModal();
        }

        function closeAddToRecipeModal() {
            document.getElementById('add-to-recipe-modal').classList.remove('active');
        }

        async function loadRecipesForModal() {
            try {
                const res = await fetch(`${API_BASE}/recipe`);
                const recipes = await res.json();
                const select = document.getElementById('modal-recipe-select');
                select.innerHTML = recipes.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            } catch (err) {
                console.error('Error loading recipes:', err);
            }
        }

        async function addIngredientToRecipe() {
            const recipeId = document.getElementById('modal-recipe-select').value;
            const grams = parseFloat(document.getElementById('modal-ingredient-grams').value);

            if (!recipeId || !grams) {
                showToast('Please select a recipe and enter amount', 'error');
                return;
            }

            // First search for the ingredient in USDA
            try {
                showToast('Searching for ingredient...', 'info');
                const searchRes = await fetch(`${API_BASE}/ingredient/search?q=${encodeURIComponent(selectedIngredientName)}`);
                const searchResults = await searchRes.json();

                if (searchResults.length > 0) {
                    // Import from USDA
                    const importRes = await fetch(`${API_BASE}/ingredient/from-usda`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fdc_id: searchResults[0].fdc_id })
                    });

                    if (importRes.ok) {
                        const ingredient = await importRes.json();
                        // Add to recipe
                        const addRes = await fetch(`${API_BASE}/recipe/${recipeId}/ingredient`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ingredient_id: ingredient.id, grams: grams })
                        });

                        if (addRes.ok) {
                            showToast(`Added ${selectedIngredientName} to recipe!`, 'success');
                            closeAddToRecipeModal();
                            loadRecipes();
                        } else {
                            const err = await addRes.json();
                            showToast(err.detail || 'Error adding to recipe', 'error');
                        }
                    } else {
                        showToast('Error importing ingredient', 'error');
                    }
                } else {
                    showToast('Ingredient not found in USDA database', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        // ==================== What If Simulator Functions ====================

        let simulatorData = {
            dog: null,
            recipe: null,
            originalAmounts: {},
            currentAmounts: {}
        };

        let macroChart = null;

        // Populate simulator dropdowns
        async function populateSimulatorDropdowns() {
            try {
                const [dogsRes, recipesRes] = await Promise.all([
                    fetch(`${API_BASE}/dog`),
                    fetch(`${API_BASE}/recipe`)
                ]);
                const dogs = await dogsRes.json();
                const recipes = await recipesRes.json();

                const dogSelect = document.getElementById('sim-dog');
                const recipeSelect = document.getElementById('sim-recipe');

                dogSelect.innerHTML = '<option value="">Select a dog...</option>' +
                    dogs.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

                recipeSelect.innerHTML = '<option value="">Select a recipe...</option>' +
                    recipes.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            } catch (err) {
                console.error('Error loading simulator data:', err);
            }
        }

        async function loadSimulatorRecipe() {
            const dogId = document.getElementById('sim-dog').value;
            const recipeId = document.getElementById('sim-recipe').value;

            if (!dogId || !recipeId) {
                document.getElementById('simulator-content').style.display = 'none';
                return;
            }

            try {
                const [dogRes, recipeRes] = await Promise.all([
                    fetch(`${API_BASE}/dog/${dogId}`),
                    fetch(`${API_BASE}/recipe/${recipeId}`)
                ]);

                simulatorData.dog = await dogRes.json();
                simulatorData.recipe = await recipeRes.json();

                // Build adjustment inputs
                const adjustmentsDiv = document.getElementById('ingredient-adjustments');
                simulatorData.originalAmounts = {};
                simulatorData.currentAmounts = {};

                if (simulatorData.recipe.ingredients.length === 0) {
                    adjustmentsDiv.innerHTML = '<p style="color: rgba(255,255,255,0.7);">This recipe has no ingredients. Add some first!</p>';
                    document.getElementById('simulator-content').style.display = 'block';
                    return;
                }

                adjustmentsDiv.innerHTML = simulatorData.recipe.ingredients.map(ing => {
                    simulatorData.originalAmounts[ing.ingredient_id] = ing.grams;
                    simulatorData.currentAmounts[ing.ingredient_id] = ing.grams;
                    return `
                        <div class="adjustment-row">
                            <label>${ing.ingredient_name}</label>
                            <span class="current-value">Current: ${ing.grams}g</span>
                            <input type="number" id="adj-${ing.ingredient_id}" value="${ing.grams}" min="0" step="1">
                            <span>g</span>
                        </div>
                    `;
                }).join('');

                document.getElementById('simulator-content').style.display = 'block';
                document.getElementById('simulation-results').style.display = 'none';

                // Show current nutrition
                await showCurrentNutrition();

            } catch (err) {
                console.error('Error loading recipe:', err);
                showToast('Error loading data', 'error');
            }
        }

        async function showCurrentNutrition() {
            // Calculate a simple meal plan to get current nutrition
            try {
                const res = await fetch(`${API_BASE}/plan/compute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dog_id: simulatorData.dog.id,
                        recipe_id: simulatorData.recipe.id,
                        kibble_kcal: 0,
                        treats_kcal: 0,
                        num_days: 1
                    })
                });

                if (res.ok) {
                    const plan = await res.json();
                    const display = document.getElementById('current-nutrition-display');
                    display.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                <div style="font-size: 1.2em; font-weight: bold; color: white;">${plan.target_kcal?.toFixed(0)}</div>
                                <div style="font-size: 0.8em; color: rgba(255,255,255,0.7);">Target kcal</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                <div style="font-size: 1.2em; font-weight: bold; color: white;">${plan.nutrient_totals.protein_g?.toFixed(1)}g</div>
                                <div style="font-size: 0.8em; color: rgba(255,255,255,0.7);">Protein</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                <div style="font-size: 1.2em; font-weight: bold; color: white;">${plan.nutrient_totals.fat_g?.toFixed(1)}g</div>
                                <div style="font-size: 0.8em; color: rgba(255,255,255,0.7);">Fat</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                                <div style="font-size: 1.2em; font-weight: bold; color: white;">${plan.nutrient_totals.carbs_g?.toFixed(1)}g</div>
                                <div style="font-size: 0.8em; color: rgba(255,255,255,0.7);">Carbs</div>
                            </div>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error showing current nutrition:', err);
            }
        }

        async function runSimulation() {
            // Collect current amounts
            const adjustments = [];
            simulatorData.recipe.ingredients.forEach(ing => {
                const input = document.getElementById(`adj-${ing.ingredient_id}`);
                const newGrams = parseFloat(input.value) || 0;
                simulatorData.currentAmounts[ing.ingredient_id] = newGrams;
                adjustments.push({
                    ingredient_id: ing.ingredient_id,
                    new_grams: newGrams
                });
            });

            try {
                const res = await fetch(`${API_BASE}/plan/simulate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dog_id: simulatorData.dog.id,
                        recipe_id: simulatorData.recipe.id,
                        ingredient_adjustments: adjustments
                    })
                });

                if (res.ok) {
                    const result = await res.json();
                    displaySimulationResults(result);
                } else {
                    const err = await res.json();
                    showToast(err.detail || 'Simulation failed', 'error');
                }
            } catch (err) {
                showToast('Connection error', 'error');
            }
        }

        function displaySimulationResults(result) {
            document.getElementById('simulation-results').style.display = 'block';

            // Overall status card
            const statusIcons = {
                excellent: 'üåü',
                good: '‚úÖ',
                caution: '‚ö†Ô∏è',
                bad: '‚ö†Ô∏è',
                dangerous: 'üö®'
            };
            const statusMessages = {
                excellent: 'Excellent! This meal is well-balanced and meets all nutritional requirements.',
                good: 'Good! This meal meets minimum requirements.',
                caution: 'Caution: Some nutrients are approaching limits.',
                bad: 'Warning: Some nutrients are deficient.',
                dangerous: 'DANGER: Some nutrients exceed safe limits!'
            };

            document.getElementById('overall-status-card').innerHTML = `
                <div class="status-card-large">
                    <div class="status-icon">${statusIcons[result.overall_status]}</div>
                    <h3>Overall Status: <span class="status-badge ${result.overall_status}">${result.overall_status.toUpperCase()}</span></h3>
                    <p>${statusMessages[result.overall_status]}</p>
                </div>
            `;

            // Macro pie chart
            const ctx = document.getElementById('macro-chart').getContext('2d');
            if (macroChart) macroChart.destroy();

            const macros = result.after;
            const totalMacroG = macros.protein_g + macros.fat_g + macros.carbs_g;

            macroChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Protein', 'Fat', 'Carbs'],
                    datasets: [{
                        data: [macros.protein_g, macros.fat_g, macros.carbs_g],
                        backgroundColor: ['#8b5cf6', '#f59e0b', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.raw;
                                    const pct = ((value / totalMacroG) * 100).toFixed(1);
                                    return `${context.label}: ${value.toFixed(1)}g (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Nutrient bars
            const barsHtml = result.nutrient_status.map(ns => {
                const pct = Math.min(ns.percent_of_min, 200);
                const displayPct = ns.percent_of_min > 100 ? Math.min(ns.percent_of_min, 150) : ns.percent_of_min;
                return `
                    <div class="nutrient-bar-container">
                        <div class="nutrient-bar-label">
                            <span>${ns.nutrient}</span>
                            <span class="status-badge ${ns.status}">${ns.status}</span>
                        </div>
                        <div class="nutrient-bar-track">
                            <div class="nutrient-bar-fill ${ns.status}" style="width: ${Math.min(displayPct, 100)}%">
                                ${ns.percent_of_min.toFixed(0)}%
                            </div>
                            <div class="nutrient-bar-marker" style="left: 100%;" title="100% of minimum"></div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('nutrient-bars').innerHTML = barsHtml;

            // Change summary
            const changes = [];
            const before = result.before;
            const after = result.after;

            if (Math.abs(after.kcal - before.kcal) > 1) {
                const diff = after.kcal - before.kcal;
                changes.push(`Calories: ${diff > 0 ? '+' : ''}${diff.toFixed(0)} kcal (now ${after.kcal.toFixed(0)} kcal)`);
            }
            if (Math.abs(after.protein_g - before.protein_g) > 0.5) {
                const diff = after.protein_g - before.protein_g;
                changes.push(`Protein: ${diff > 0 ? '+' : ''}${diff.toFixed(1)}g (now ${after.protein_g.toFixed(1)}g)`);
            }
            if (Math.abs(after.fat_g - before.fat_g) > 0.5) {
                const diff = after.fat_g - before.fat_g;
                changes.push(`Fat: ${diff > 0 ? '+' : ''}${diff.toFixed(1)}g (now ${after.fat_g.toFixed(1)}g)`);
            }

            document.getElementById('change-summary').innerHTML = `
                <h3 style="color: white; margin-bottom: 15px;">üìä What Changed</h3>
                ${changes.length > 0 ? `
                    <ul style="color: rgba(255,255,255,0.9); margin: 0; padding-left: 20px;">
                        ${changes.map(c => `<li style="margin-bottom: 8px;">${c}</li>`).join('')}
                    </ul>
                ` : '<p style="color: rgba(255,255,255,0.7);">No significant changes detected.</p>'}
                ${result.warnings.length > 0 ? `
                    <div style="margin-top: 15px; padding: 10px; background: rgba(239, 68, 68, 0.2); border-radius: 8px;">
                        <strong style="color: #ef4444;">Warnings:</strong>
                        <ul style="color: #fca5a5; margin: 5px 0 0 0; padding-left: 20px;">
                            ${result.warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                ${result.recommendations.length > 0 ? `
                    <div style="margin-top: 15px; padding: 10px; background: rgba(16, 185, 129, 0.2); border-radius: 8px;">
                        <strong style="color: #10b981;">Recommendations:</strong>
                        <ul style="color: #6ee7b7; margin: 5px 0 0 0; padding-left: 20px;">
                            ${result.recommendations.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        }

        function resetSimulator() {
            simulatorData.recipe.ingredients.forEach(ing => {
                const input = document.getElementById(`adj-${ing.ingredient_id}`);
                input.value = simulatorData.originalAmounts[ing.ingredient_id];
            });
            document.getElementById('simulation-results').style.display = 'none';
            showToast('Reset to original amounts', 'info');
        }

        // Initialize simulator dropdowns when tab is shown
        document.querySelector('[data-tab="simulator"]').addEventListener('click', populateSimulatorDropdowns);
    </script>
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
