<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fresh Pup - Dog Meal Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Base Surfaces */
            --bg-app: #F8F6F2;
            --bg-secondary: #FAF9F6;
            --bg-card: #FFFFFF;
            --border-divider: #E8E6E1;

            /* Text Colors */
            --text-primary: #2E2E2E;
            --text-secondary: #6B6B6B;
            --text-muted: #9A9A9A;

            /* Primary Brand (Sage Green) */
            --primary: #7BAE8E;
            --primary-pressed: #6A9C7D;
            --primary-soft: #A9C8B7;
            --primary-tint: #E6F0EB;

            /* Accent (Warm Amber) */
            --accent: #F2C57C;
            --accent-pressed: #E0B366;
            --accent-soft: #FBF1DD;

            /* UI Neutrals */
            --progress-track: #EDEDED;
            --disabled: #DADADA;
            --icon-inactive: #A8A8A8;

            /* Status Colors */
            --success: #7BAE8E;
            --warning: #F2C57C;
            --danger: #D9896C;
            --status-excellent: #7BAE8E;
            --status-good: #A9C8B7;
            --status-caution: #F2C57C;
            --status-bad: #E8A87C;
            --status-dangerous: #D9896C;

            /* Legacy support - map old variables */
            --accent-1: #7BAE8E;
            --accent-2: #6A9C7D;
            --accent-3: #A9C8B7;
            --accent-4: #E6F0EB;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            background: var(--bg-app);
            overflow-x: hidden;
            color: var(--text-primary);
        }

        /* Aurora Background - hidden for light theme */
        .aurora {
            display: none;
        }

        /* Cards - Clean white style */
        .glass {
            background: var(--bg-card);
            border: 1px solid var(--border-divider);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .glass-dark {
            background: var(--bg-secondary);
            border: 1px solid var(--border-divider);
            border-radius: 16px;
        }

        /* Layout */
        .app-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-primary);
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .logo-icon {
            width: 64px;
            height: 64px;
            background: var(--primary);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            box-shadow: 0 4px 12px rgba(123, 174, 142, 0.3);
        }

        .app-logo {
            max-width: 350px;
            height: auto;
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.1));
        }

        header h1 {
            font-size: 3rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-top: 8px;
        }

        /* Navigation Tabs */
        .nav-container {
            position: relative;
            margin-bottom: 24px;
        }

        .nav-tabs {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            padding: 8px;
            padding-bottom: 12px;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .nav-tabs::-webkit-scrollbar {
            height: 6px;
        }

        .nav-tabs::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }

        .nav-tabs::-webkit-scrollbar-thumb {
            background: var(--primary-soft);
            border-radius: 3px;
        }

        .nav-tabs::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .nav-scroll-indicator {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 60px;
            background: linear-gradient(to right, transparent, var(--bg-app));
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            opacity: 1;
            transition: opacity 0.3s;
            border-radius: 0 16px 16px 0;
        }

        .nav-scroll-indicator.hidden {
            opacity: 0;
        }

        .nav-scroll-indicator::after {
            content: "‚Ä∫";
            color: var(--text-secondary);
            font-size: 1.8rem;
            font-weight: 300;
            animation: scrollHint 1.5s ease-in-out infinite;
        }

        @keyframes scrollHint {
            0%, 100% { transform: translateX(0); opacity: 0.5; }
            50% { transform: translateX(4px); opacity: 1; }
        }

        .nav-tab {
            padding: 14px 28px;
            border: none;
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border-divider);
            flex-shrink: 0;
        }

        .nav-tab:hover {
            background: var(--primary-tint);
            color: var(--text-primary);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(123, 174, 142, 0.3);
        }

        .nav-tab span {
            font-size: 1.2rem;
        }

        /* Main Content */
        .main-content {
            padding: 32px;
            background: var(--bg-card);
        }

        .tab-panel {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Recipe Sub-Navigation */
        .sub-nav-btn {
            padding: 10px 16px;
            font-size: 0.85rem;
        }

        .sub-nav-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .recipe-subsection {
            display: none;
        }

        .recipe-subsection.active {
            display: block;
        }

        /* PRO Gate Overlay */
        .pro-gate-overlay {
            padding: 40px 20px;
        }

        /* Onboarding Wizard */
        .onboard-step {
            display: none;
        }

        .onboard-step.active {
            display: block;
        }

        .onboard-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--border-divider);
            transition: all 0.3s;
        }

        .onboard-dot.active {
            background: var(--primary);
            width: 24px;
            border-radius: 5px;
        }

        .onboard-dot.completed {
            background: var(--primary-soft);
        }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .section-title {
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title span {
            font-size: 1.5rem;
        }

        /* Forms */
        .form-card {
            padding: 28px;
            margin-bottom: 32px;
            background: var(--bg-card);
            border: 1px solid var(--border-divider);
            border-radius: 16px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        input, select {
            padding: 14px 18px;
            background: var(--bg-card);
            border: 1px solid var(--border-divider);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        input::placeholder {
            color: var(--text-muted);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-card);
            box-shadow: 0 0 0 3px rgba(123, 174, 142, 0.2);
        }

        select {
            cursor: pointer;
        }

        select option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(123, 174, 142, 0.3);
        }

        .btn-primary:hover {
            background: var(--primary-pressed);
            box-shadow: 0 4px 12px rgba(123, 174, 142, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-divider);
        }

        .btn-secondary:hover {
            background: var(--border-divider);
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--primary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--disabled);
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 12px;
        }

        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        /* Dog Card */
        .dog-card {
            padding: 24px;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            background: var(--bg-card);
            border: 1px solid var(--border-divider);
        }

        .dog-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(123, 174, 142, 0.15);
        }

        .dog-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
        }

        .dog-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .dog-avatar {
            width: 60px;
            height: 60px;
            background: var(--primary-tint);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .dog-info h3 {
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .dog-info p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .dog-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-box {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-divider);
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 4px;
        }

        /* Ingredient Card */
        .ingredient-card {
            padding: 20px;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            min-height: 280px;
            background: var(--bg-card);
            border: 1px solid var(--border-divider);
        }

        .ingredient-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(123, 174, 142, 0.15);
        }

        .ingredient-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            gap: 10px;
        }

        .ingredient-header h3 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.3;
            word-break: break-word;
            flex: 1;
        }

        .ingredient-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .badge-usda {
            background: var(--primary-tint);
            color: var(--primary);
        }

        .badge-user {
            background: var(--accent-soft);
            color: var(--accent-pressed);
        }

        /* Checkbox Ingredient List */
        .ingredient-checkbox-list {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 12px;
            background: var(--bg-secondary);
            padding: 10px;
            border: 1px solid var(--border-divider);
        }

        .ingredient-checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.2s;
            border: 1px solid var(--border-divider);
        }

        .ingredient-checkbox-item:hover {
            border-color: var(--primary-soft);
        }

        .ingredient-checkbox-item.checked {
            background: var(--primary-tint);
            border-color: var(--primary);
        }

        .ingredient-checkbox-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: var(--primary);
            cursor: pointer;
            flex-shrink: 0;
        }

        .ingredient-checkbox-info {
            flex: 1;
            min-width: 0;
        }

        .ingredient-checkbox-name {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.95rem;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ingredient-checkbox-macros {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .category-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-right: 8px;
        }

        /* Softer category colors for light theme */
        .category-protein { background: #FDEAEA; color: #B85450; }
        .category-carbs { background: #FEF6E6; color: #B8860B; }
        .category-veggies { background: #E8F5E9; color: #4A7C4E; }
        .category-vegetables { background: #E8F5E9; color: #4A7C4E; }
        .category-fruits { background: #E0F7FA; color: #00838F; }
        .category-fats { background: #E3F2FD; color: #1565C0; }
        .category-seeds { background: #FFF8E1; color: #F9A825; }
        .category-supplements { background: var(--primary-tint); color: var(--primary-pressed); }
        .category-other { background: #F5F5F5; color: #757575; }

        /* Food Pyramid Visualization */
        .food-pyramid {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 4px;
        }

        .pyramid-level {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .pyramid-level:hover {
            transform: scale(1.02);
        }

        .pyramid-level .emoji { font-size: 1.2rem; }
        .pyramid-level .label { flex: 1; }
        .pyramid-level .percent { font-weight: 800; min-width: 50px; text-align: right; }

        .pyramid-protein { background: linear-gradient(135deg, rgba(239, 68, 68, 0.4), rgba(220, 38, 38, 0.4)); width: 95%; }
        .pyramid-carbs { background: linear-gradient(135deg, rgba(251, 191, 36, 0.4), rgba(245, 158, 11, 0.4)); width: 75%; }
        .pyramid-vegetables { background: linear-gradient(135deg, rgba(34, 197, 94, 0.4), rgba(22, 163, 74, 0.4)); width: 70%; }
        .pyramid-fruits { background: linear-gradient(135deg, rgba(168, 85, 247, 0.4), rgba(147, 51, 234, 0.4)); width: 50%; }
        .pyramid-fats { background: linear-gradient(135deg, rgba(59, 130, 246, 0.4), rgba(37, 99, 235, 0.4)); width: 40%; }
        .pyramid-seeds { background: linear-gradient(135deg, rgba(234, 179, 8, 0.4), rgba(202, 138, 4, 0.4)); width: 35%; }
        .pyramid-supplements { background: linear-gradient(135deg, rgba(236, 72, 153, 0.4), rgba(219, 39, 119, 0.4)); width: 30%; }
        .pyramid-other { background: linear-gradient(135deg, rgba(156, 163, 175, 0.4), rgba(107, 114, 128, 0.4)); width: 30%; }

        .nutrient-bars {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nutrient-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nutrient-bar label {
            width: 70px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .bar-track {
            flex: 1;
            height: 8px;
            background: var(--progress-track);
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .bar-fill.protein { background: #D9896C; }
        .bar-fill.fat { background: var(--accent); }
        .bar-fill.carbs { background: var(--primary); }

        .nutrient-bar span {
            width: 50px;
            text-align: right;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Recipe Card */
        .recipe-card {
            padding: 24px;
            transition: all 0.2s;
            background: var(--bg-card);
            border: 1px solid var(--border-divider);
        }

        .recipe-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(123, 174, 142, 0.15);
        }

        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .recipe-header h3 {
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 700;
        }

        .meals-badge {
            background: var(--primary);
            padding: 6px 14px;
            border-radius: 20px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .recipe-ingredients {
            margin-top: 16px;
        }

        .recipe-ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-divider);
        }

        .recipe-ingredient-item:last-child {
            border-bottom: none;
        }

        .recipe-ingredient-item span {
            color: var(--text-secondary);
        }

        .recipe-ingredient-item strong {
            color: var(--accent-1);
            font-weight: 600;
        }

        /* Search */
        .search-container {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .search-input {
            flex: 1;
            padding: 16px 20px;
            padding-left: 48px;
            background: var(--bg-card);
            border: 2px solid var(--border-divider);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 1rem;
            position: relative;
        }

        .search-wrapper {
            flex: 1;
            position: relative;
        }

        .search-wrapper::before {
            content: 'üîç';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        /* Search Results */
        .search-results {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-1) transparent;
        }

        .search-result {
            padding: 16px;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-divider);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-result:hover {
            background: var(--primary-tint);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .search-result h4 {
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .search-result p {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Plan Results */
        .plan-result {
            margin-top: 32px;
        }

        .plan-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 32px;
            padding: 24px;
        }

        .plan-dog-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .plan-dog-info h2 {
            color: white;
            font-size: 1.75rem;
            margin-bottom: 4px;
        }

        .plan-dog-info p {
            color: var(--text-secondary);
        }

        .calorie-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .calorie-card {
            padding: 24px;
            text-align: center;
        }

        .calorie-card .value {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-1), var(--accent-3));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .calorie-card .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 4px;
        }

        .calorie-card.highlight {
            background: var(--primary);
        }

        .calorie-card.highlight .value {
            background: none;
            -webkit-text-fill-color: white;
            color: white;
        }

        .calorie-card.highlight .label {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Portions Table */
        .portions-section {
            margin-bottom: 32px;
        }

        .portions-section h3 {
            color: var(--text-primary);
            font-size: 1.25rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .portion-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-divider);
            border-radius: 12px;
        }

        .portion-item .name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .portion-amounts {
            display: flex;
            gap: 24px;
        }

        .portion-amount {
            text-align: right;
        }

        .portion-amount .value {
            color: var(--accent-1);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .portion-amount .label {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        /* Warnings */
        .warnings-section {
            padding: 20px;
            border-radius: 16px;
            margin-top: 24px;
        }

        .warnings-section.has-warnings {
            background: var(--accent-soft);
            border: 1px solid var(--accent);
        }

        .warnings-section.success {
            background: var(--primary-tint);
            border: 1px solid var(--primary-soft);
        }

        .warnings-section h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .warnings-section.has-warnings h4 {
            color: var(--warning);
        }

        .warnings-section.success h4 {
            color: var(--success);
        }

        .warnings-section ul {
            margin-left: 24px;
        }

        .warnings-section li {
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state span {
            font-size: 64px;
            display: block;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-divider);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .toast.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .toast.info {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .main-content {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                justify-content: flex-start;
            }

            .calorie-breakdown {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-soft);
            border-radius: 4px;
        }

        /* Recipe Builder */
        .recipe-builder {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 24px;
        }

        @media (max-width: 900px) {
            .recipe-builder {
                grid-template-columns: 1fr;
            }
        }

        .builder-section {
            padding: 24px;
        }

        .builder-section h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-size: 1.1rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        /* Nutrient Donut */
        .macro-display {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 15px 10px;
            background: var(--bg-secondary);
            border-radius: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .macro-item {
            text-align: center;
        }

        .macro-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            color: white;
            margin: 0 auto 6px;
        }

        .macro-circle.kcal { background: linear-gradient(135deg, #0ea5e9, #06b6d4); }
        .macro-circle.protein { background: linear-gradient(135deg, #ef4444, #f97316); }
        .macro-circle.fat { background: linear-gradient(135deg, #f59e0b, #eab308); }
        .macro-circle.carbs { background: linear-gradient(135deg, #10b981, #22c55e); }

        .macro-label {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* Unit Toggle */
        .unit-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .unit-btn {
            padding: 8px 20px;
            font-size: 0.9rem;
        }

        .unit-btn.active {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            border-color: transparent;
        }

        /* Card Actions */
        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border-divider);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-edit {
            background: var(--primary-tint);
            color: var(--primary-pressed);
            border: 1px solid var(--primary-soft);
        }

        .btn-edit:hover {
            background: var(--primary-soft);
        }

        .btn-delete {
            background: #FEE2E2;
            color: #B91C1C;
            border: 1px solid #FECACA;
        }

        .btn-delete:hover {
            background: #FECACA;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-divider);
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal h3 {
            color: var(--text-primary);
            font-size: 1.5rem;
            margin-bottom: 24px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            justify-content: flex-end;
        }

        /* Ingredient Guide Styles */
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid var(--border-divider);
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: var(--primary-tint);
            color: var(--text-primary);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .ingredient-category {
            margin-bottom: 15px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            border-radius: 12px;
            transition: all 0.3s;
        }

        .category-header:hover {
            background: var(--primary-tint);
        }

        .category-header h3 {
            color: var(--text-primary);
            font-size: 1.1rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expand-icon {
            color: var(--text-secondary);
            font-size: 1.5rem;
            transition: transform 0.3s;
        }

        .category-header.expanded .expand-icon {
            transform: rotate(45deg);
        }

        .category-content {
            display: none;
            padding: 15px;
            gap: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .category-content.show {
            display: grid;
        }

        .ingredient-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px;
            border-radius: 16px;
            gap: 15px;
        }

        .ingredient-card img {
            width: 100%;
            max-width: 220px;
            height: auto;
            object-fit: contain;
            border-radius: 16px;
            flex-shrink: 0;
        }

        .ingredient-info {
            flex: 1;
            width: 100%;
        }

        .ingredient-info h4 {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 8px 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .ingredient-info p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin: 0;
            line-height: 1.5;
        }

        .ingredient-info .warning-text {
            color: #fbbf24;
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        /* Simulator Styles */
        .adjustment-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .adjustment-row label {
            flex: 1;
            color: var(--text-primary);
            font-weight: 500;
        }

        .adjustment-row .current-value {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .adjustment-row input {
            width: 100px;
        }

        /* Nutrient Bar Styles */
        .nutrient-bar-container {
            margin-bottom: 15px;
        }

        .nutrient-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .nutrient-bar-track {
            height: 24px;
            background: var(--progress-track);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .nutrient-bar-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 0.75rem;
            color: white;
            font-weight: bold;
        }

        .nutrient-bar-fill.excellent { background: linear-gradient(90deg, #10b981, #059669); }
        .nutrient-bar-fill.good { background: linear-gradient(90deg, #22c55e, #16a34a); }
        .nutrient-bar-fill.caution { background: linear-gradient(90deg, #eab308, #ca8a04); }
        .nutrient-bar-fill.bad { background: linear-gradient(90deg, #f97316, #ea580c); }
        .nutrient-bar-fill.dangerous { background: linear-gradient(90deg, #ef4444, #dc2626); }

        .nutrient-bar-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: white;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.excellent { background: var(--primary-tint); color: var(--primary-pressed); }
        .status-badge.good { background: #E8F5E9; color: #4A7C4E; }
        .status-badge.caution { background: var(--accent-soft); color: #8B6914; }
        .status-badge.bad { background: #FFF3E0; color: #E65100; }
        .status-badge.dangerous { background: #FFEBEE; color: #C62828; }

        /* Overall Status Card */
        .status-card-large {
            text-align: center;
            padding: 30px;
        }

        .status-card-large .status-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .status-card-large h3 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .status-card-large p {
            color: var(--text-secondary);
        }

        /* Dangerous Foods Section */
        .danger-section {
            margin-top: 30px;
            padding: 25px;
            border-radius: 20px;
            background: #FEF2F2;
            border: 1px solid #FECACA;
        }

        .danger-section-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .danger-section-header h2 {
            color: #B91C1C;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .danger-section-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .danger-tier {
            margin-bottom: 20px;
            padding: 20px;
            border-radius: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-divider);
        }

        .danger-tier-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-divider);
        }

        .danger-tier-header h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0;
        }

        .tier-deadly .danger-tier-header h3 { color: #dc2626; }
        .tier-very-dangerous .danger-tier-header h3 { color: #f97316; }
        .tier-toxic .danger-tier-header h3 { color: #eab308; }
        .tier-harmful .danger-tier-header h3 { color: #0ea5e9; }
        .tier-info .danger-tier-header h3 { color: #3b82f6; }

        .danger-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .danger-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--bg-secondary);
            border-radius: 10px;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .danger-item.skull::before { content: '‚ò†Ô∏è'; }
        .danger-item.warning::before { content: '‚ö†Ô∏è'; }
        .danger-item.caution::before { content: '‚ö°'; }
        .danger-item.no::before { content: '‚ùå'; }
        .danger-item.maybe::before { content: 'üü°'; }

        .danger-note {
            margin-top: 12px;
            padding: 12px 15px;
            background: #FEF2F2;
            border-left: 3px solid #DC2626;
            border-radius: 0 10px 10px 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .danger-note.info {
            background: rgba(59, 130, 246, 0.15);
            border-left-color: #3b82f6;
        }

        .symptoms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .symptom-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: rgba(239, 68, 68, 0.2);
            border-radius: 10px;
            font-size: 0.9rem;
            color: white;
            font-weight: 500;
        }

        .symptom-item::before { content: 'üö®'; }

        /* Sticky Disclaimer */
        .sticky-disclaimer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-divider);
            padding: 12px 20px;
            text-align: center;
            z-index: 1000;
            font-size: 0.85rem;
            color: var(--text-secondary);
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.06);
        }

        .sticky-disclaimer strong {
            color: var(--accent-pressed);
        }

        /* Add padding to body so content isn't hidden behind disclaimer */
        .app-container {
            padding-bottom: 60px;
        }

        /* About Section Styles */
        .about-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .about-hero-img {
            width: 100%;
            max-height: 500px;
            object-fit: cover;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            margin-bottom: 40px;
        }

        .about-heading {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            text-align: center;
            margin-bottom: 40px;
        }

        .about-text {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.9;
        }

        .about-text p {
            margin-bottom: 24px;
        }

        .about-text .emphasis {
            color: var(--text-primary);
            font-weight: 600;
        }

        .about-text .emotional {
            font-style: italic;
            color: var(--text-secondary);
        }

        .about-quote {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary);
            text-align: center;
            padding: 30px 20px;
            margin: 40px 0;
            border-left: 4px solid var(--primary);
            background: var(--primary-tint);
            border-radius: 0 16px 16px 0;
        }

        .about-closing-img {
            width: 100%;
            max-height: 600px;
            object-fit: cover;
            border-radius: 20px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            margin-top: 40px;
        }

        .about-cta {
            text-align: center;
            margin-top: 40px;
            padding: 30px;
            background: var(--primary-tint);
            border-radius: 20px;
            border: 1px solid var(--primary-soft);
        }

        .about-cta p {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        @media (max-width: 768px) {
            .about-heading {
                font-size: 2rem;
            }
            .about-text {
                font-size: 1rem;
            }
            .about-quote {
                font-size: 1.1rem;
            }
        }

        /* Pro Badge & Upgrade Modal Styles */
        .pro-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--accent);
            color: #5D4A1F;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 6px rgba(242, 197, 124, 0.3);
        }

        .pro-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(242, 197, 124, 0.4);
        }

        .pro-badge-inline {
            vertical-align: middle;
        }

        .pro-badge-small {
            background: var(--accent);
            color: #5D4A1F;
            font-size: 0.55rem;
            font-weight: 700;
            padding: 2px 5px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-left: 4px;
            vertical-align: middle;
        }

        #upgrade-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        #upgrade-modal.active {
            display: flex;
        }

        .upgrade-modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-divider);
            border-radius: 20px;
            padding: 40px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease-out;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upgrade-modal-content h2 {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .upgrade-modal-content > p {
            color: var(--text-secondary);
            margin-bottom: 25px;
        }

        .pro-benefits {
            list-style: none;
            padding: 0;
            margin: 0 0 30px 0;
            text-align: left;
        }

        .pro-benefits li {
            color: var(--text-primary);
            padding: 12px 0;
            border-bottom: 1px solid var(--border-divider);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pro-benefits li:last-child {
            border-bottom: none;
        }

        .pro-benefits li::before {
            content: "‚úì";
            color: var(--primary);
            font-weight: bold;
            font-size: 1.1rem;
        }

        .btn-upgrade {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .btn-upgrade:hover {
            background: var(--primary-pressed);
            box-shadow: 0 4px 12px rgba(123, 174, 142, 0.3);
        }

        .upgrade-modal-content .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-divider);
            color: var(--text-secondary);
            width: 100%;
        }

        .upgrade-modal-content .btn-secondary:hover {
            background: var(--border-divider);
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <!-- Aurora Background -->
    <div class="aurora">
        <div class="aurora-blob"></div>
        <div class="aurora-blob"></div>
        <div class="aurora-blob"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <div class="app-container">
        <div class="container">
            <!-- Header -->
            <header>
                <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">
                    <div class="logo">
                        <img src="images/Logo.png" alt="Fresh Pup" class="app-logo">
                    </div>
                    <!-- Auth Button -->
                    <div id="auth-container">
                        <button id="auth-btn" class="btn btn-secondary" onclick="showAuthModal()" style="display: flex; align-items: center; gap: 8px;">
                            <span>üë§</span> <span id="auth-btn-text">Sign In / Sign Up</span>
                        </button>
                        <div id="user-menu" style="display: none; position: relative;">
                            <button class="btn btn-secondary" onclick="toggleUserMenu()" style="display: flex; align-items: center; gap: 8px;">
                                <img id="user-avatar-display" src="" alt="" style="width: 24px; height: 24px; border-radius: 50%; display: none;">
                                <span id="user-avatar-fallback">üë§</span>
                                <span id="user-email-display">User</span> <span>‚ñº</span>
                            </button>
                            <div id="user-dropdown" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 8px; background: var(--bg-card); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 180px; z-index: 1000;">
                                <button onclick="showProfileModal()" style="width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; cursor: pointer; color: var(--text-primary); font-size: 0.95rem; border-bottom: 1px solid var(--border-divider);">
                                    Profile
                                </button>
                                <button onclick="signOut()" style="width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; cursor: pointer; color: var(--text-primary); font-size: 0.95rem;">
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <p>Precision nutrition for your best friend</p>
                <div class="unit-toggle" style="margin-top: 16px;">
                    <span style="color: var(--text-secondary); margin-right: 12px;">Weight Unit:</span>
                    <button class="btn btn-secondary unit-btn active" data-unit="kg" onclick="setWeightUnit('kg')">kg</button>
                    <button class="btn btn-secondary unit-btn" data-unit="lbs" onclick="setWeightUnit('lbs')">lbs</button>
                </div>
            </header>

            <!-- Navigation - 5 Main Tabs -->
            <div class="nav-container">
                <nav class="nav-tabs glass" id="nav-tabs">
                    <button class="nav-tab active" data-tab="home"><span>üè†</span> Home</button>
                    <button class="nav-tab" data-tab="recipes"><span>üìã</span> Recipes</button>
                    <button class="nav-tab" data-tab="history"><span>üìä</span> History <span class="pro-badge-small">PRO</span></button>
                    <button class="nav-tab" data-tab="settings"><span>‚öôÔ∏è</span> Settings</button>
                    <button class="nav-tab" data-tab="about"><span>üêï</span> About</button>
                </nav>
            </div>

            <!-- Main Content -->
            <main class="main-content glass">
                <!-- HOME Tab -->
                <div id="home" class="tab-panel active">
                    <!-- No Dog State -->
                    <div id="home-no-dog" class="empty-state" style="display: none;">
                        <span>üêï</span>
                        <p>Welcome to Fresh Pup!</p>
                        <p style="margin-top: 8px; color: var(--text-secondary);">Add your dog in Settings to get started.</p>
                        <button class="btn btn-primary" style="margin-top: 16px;" onclick="switchTab('settings')">
                            <span>‚öôÔ∏è</span> Go to Settings
                        </button>
                    </div>

                    <!-- Dog Dashboard (shown when dog exists) -->
                    <div id="home-dashboard" style="display: none;">
                        <!-- Dog Profile Card -->
                        <div class="home-profile-card glass-dark" style="padding: 24px; margin-bottom: 24px; display: flex; align-items: center; gap: 20px;">
                            <div class="dog-avatar" style="width: 80px; height: 80px; border-radius: 50%; background: var(--primary-tint); display: flex; align-items: center; justify-content: center; font-size: 2.5rem;">
                                üêï
                            </div>
                            <div class="dog-info" style="flex: 1;">
                                <h2 id="home-dog-name" style="color: var(--text-primary); font-size: 1.5rem; margin-bottom: 4px;">Dog Name</h2>
                                <p id="home-dog-details" style="color: var(--text-secondary); font-size: 0.9rem;">Weight ‚Ä¢ Age ‚Ä¢ Activity</p>
                            </div>
                            <select id="home-dog-selector" class="form-control" style="width: auto; min-width: 150px;" onchange="selectHomeDog(this.value)">
                            </select>
                        </div>

                        <!-- Daily Calories Dashboard -->
                        <div class="home-calories-card glass-dark" style="padding: 24px; margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="color: var(--text-primary); font-size: 1.1rem;">Today's Calories</h3>
                                <span id="home-calorie-status" class="status-badge excellent">On Track</span>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 12px;">
                                <span id="home-calories-fed" style="font-size: 2.5rem; font-weight: 700; color: var(--primary);">0</span>
                                <span style="color: var(--text-secondary); font-size: 1.1rem;">/ <span id="home-calories-target">0</span> kcal</span>
                            </div>
                            <div class="nutrient-bar-track" style="height: 12px; margin-bottom: 8px;">
                                <div id="home-calorie-bar" class="nutrient-bar-fill excellent" style="width: 0%;"></div>
                            </div>
                            <p id="home-calories-remaining" style="color: var(--text-secondary); font-size: 0.9rem;">0 kcal remaining</p>
                        </div>

                        <!-- Macro Overview -->
                        <div class="home-macros-card glass-dark" style="padding: 24px; margin-bottom: 24px;">
                            <h3 style="color: var(--text-primary); font-size: 1.1rem; margin-bottom: 16px;">Today's Macros</h3>
                            <div class="macro-display">
                                <div class="macro-item">
                                    <div class="macro-circle protein"><span id="home-protein">0</span>g</div>
                                    <div class="macro-label">Protein</div>
                                </div>
                                <div class="macro-item">
                                    <div class="macro-circle fat"><span id="home-fat">0</span>g</div>
                                    <div class="macro-label">Fat</div>
                                </div>
                                <div class="macro-item">
                                    <div class="macro-circle carbs"><span id="home-carbs">0</span>g</div>
                                    <div class="macro-label">Carbs</div>
                                </div>
                            </div>
                        </div>

                        <!-- Today's Meals -->
                        <div class="home-meals-card glass-dark" style="padding: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="color: var(--text-primary); font-size: 1.1rem;">Today's Meals</h3>
                                <button class="btn btn-primary btn-sm" onclick="openLogMealModal()">
                                    <span>‚ûï</span> Log Meal
                                </button>
                            </div>
                            <div id="home-meals-list">
                                <div class="empty-state" style="padding: 20px;">
                                    <span>üçΩÔ∏è</span>
                                    <p>No meals logged today</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HIDDEN: Old Dogs Tab (moved to Settings) -->
                <div id="dogs" class="tab-panel" style="display: none;">
                    <div class="section-header">
                        <h2 class="section-title"><span>üêï</span> Your Dogs</h2>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">Free: 1 dog <span class="pro-badge pro-badge-inline" onclick="showUpgradeModal()">PRO</span> Unlimited dogs</p>
                    </div>

                    <div class="form-card glass-dark">
                        <form id="dog-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Name</label>
                                    <input type="text" id="dog-name" required placeholder="e.g., Buddy">
                                </div>
                                <div class="form-group">
                                    <label>Breed (optional)</label>
                                    <input type="text" id="dog-breed" placeholder="e.g., Golden Retriever">
                                </div>
                                <div class="form-group">
                                    <label>Current Weight (<span class="weight-unit-label">kg</span>)</label>
                                    <input type="number" id="dog-weight" step="0.1" required placeholder="e.g., 25">
                                </div>
                                <div class="form-group">
                                    <label>Target Weight (<span class="weight-unit-label">kg</span>)</label>
                                    <input type="number" id="dog-target-weight" step="0.1" placeholder="Leave empty if at ideal weight">
                                </div>
                                <div class="form-group">
                                    <label>Age (years)</label>
                                    <input type="number" id="dog-age" step="0.1" required placeholder="e.g., 3">
                                </div>
                                <div class="form-group">
                                    <label>Life Stage</label>
                                    <select id="dog-life-stage">
                                        <option value="puppy">Puppy (under 1 year)</option>
                                        <option value="adult" selected>Adult (1-7 years)</option>
                                        <option value="senior">Senior (7+ years)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Activity Level</label>
                                    <select id="dog-activity">
                                        <option value="low">Low - Senior or sedentary</option>
                                        <option value="moderate" selected>Moderate - Regular walks</option>
                                        <option value="high">High - Very active</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Target Daily Kcal (optional)</label>
                                    <input type="number" id="dog-target-kcal" step="1" placeholder="Override calculated MER">
                                </div>
                                <div class="form-group">
                                    <label>Sex</label>
                                    <select id="dog-sex">
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Neutered/Spayed</label>
                                    <select id="dog-neutered">
                                        <option value="true">Yes</option>
                                        <option value="false">No</option>
                                    </select>
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label>Notes (allergies, medical conditions, etc.)</label>
                                    <textarea id="dog-notes" rows="2" placeholder="Any special dietary needs or medical conditions"></textarea>
                                </div>
                            </div>
                            <div class="quick-actions">
                                <button type="submit" class="btn btn-primary">
                                    <span>‚ûï</span> Add Dog
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="dogs-list" class="cards-grid">
                        <div class="empty-state">
                            <span>üêï</span>
                            <p>No dogs added yet. Add your first furry friend above!</p>
                        </div>
                    </div>
                </div>

                <!-- Tracking Tab -->
                <div id="tracking" class="tab-panel">
                    <div class="section-header">
                        <h2 class="section-title"><span>üìä</span> Daily Tracking</h2>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">Daily logging is free <span class="pro-badge pro-badge-inline" onclick="showUpgradeModal()">PRO</span> History charts & progress</p>
                    </div>

                    <!-- Dog Selector for Tracking -->
                    <div class="form-card glass-dark" style="margin-bottom: 24px;">
                        <div class="form-group">
                            <label>Select Dog</label>
                            <select id="tracking-dog-select" onchange="loadTrackingData()">
                                <option value="">Select a dog...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Daily Summary Card -->
                    <div id="daily-summary" class="glass-dark" style="padding: 24px; border-radius: 16px; margin-bottom: 24px; display: none;">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">Today's Summary</h3>
                        <div class="dog-stats" style="margin-bottom: 16px;">
                            <div class="stat-box">
                                <div class="stat-value" id="summary-target">--</div>
                                <div class="stat-label">Target kcal</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="summary-fed">--</div>
                                <div class="stat-label">Fed today</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="summary-remaining">--</div>
                                <div class="stat-label">Remaining</div>
                            </div>
                        </div>
                        <div id="summary-status" style="text-align: center; padding: 12px; border-radius: 8px;"></div>
                    </div>

                    <!-- Log Meal Form -->
                    <div class="form-card glass-dark" style="margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">Log a Meal</h3>
                        <form id="feeding-log-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Meal Type</label>
                                    <select id="log-meal-type">
                                        <option value="breakfast">Breakfast</option>
                                        <option value="lunch">Lunch</option>
                                        <option value="dinner">Dinner</option>
                                        <option value="snack">Snack/Treat</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Calories (kcal)</label>
                                    <input type="number" id="log-kcal" step="1" required placeholder="e.g., 250">
                                </div>
                                <div class="form-group">
                                    <label>Recipe (optional)</label>
                                    <select id="log-recipe">
                                        <option value="">No recipe</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <input type="text" id="log-notes" placeholder="Optional notes">
                                </div>
                            </div>
                            <div class="quick-actions">
                                <button type="submit" class="btn btn-primary">
                                    <span>üìù</span> Log Meal
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Today's Meals -->
                    <div class="form-card glass-dark" style="margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">Today's Meals</h3>
                        <div id="todays-meals-list"></div>
                    </div>

                    <!-- Weight Log Section -->
                    <div class="form-card glass-dark" style="margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">Log Weight</h3>
                        <form id="weight-log-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Weight (<span class="weight-unit-label">kg</span>)</label>
                                    <input type="number" id="log-weight" step="0.1" required placeholder="Current weight">
                                </div>
                                <div class="form-group">
                                    <label>Notes</label>
                                    <input type="text" id="weight-log-notes" placeholder="Optional notes">
                                </div>
                            </div>
                            <div class="quick-actions">
                                <button type="submit" class="btn btn-secondary">
                                    <span>‚öñÔ∏è</span> Log Weight
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Weight History -->
                    <div class="form-card glass-dark">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">Weight History <span class="pro-badge" onclick="showUpgradeModal()">PRO</span></h3>
                        <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">Track weight over time with Pro</p>
                        <div id="weight-history-list"></div>
                    </div>
                </div>

                <!-- Ingredients Tab -->
                <div id="ingredients" class="tab-panel">
                    <div class="section-header">
                        <h2 class="section-title"><span>ü•©</span> Ingredients</h2>
                    </div>

                    <div class="form-card glass-dark">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">üîç Search USDA Database</h3>
                        <div class="search-container">
                            <div class="search-wrapper">
                                <input type="text" id="ingredient-search" class="search-input" placeholder="Search for ingredients (e.g., chicken breast, beef liver)">
                            </div>
                            <button class="btn btn-primary" onclick="searchIngredients()">Search</button>
                        </div>
                        <div id="search-results" class="search-results"></div>
                    </div>

                    <div class="form-card glass-dark">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">‚úèÔ∏è Add Custom Ingredient</h3>
                        <form id="ingredient-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Name</label>
                                    <input type="text" id="ing-name" required placeholder="e.g., Homemade Beef Mix">
                                </div>
                                <div class="form-group">
                                    <label>Total Calories (kcal)</label>
                                    <input type="number" id="ing-kcal" step="0.1" required placeholder="e.g., 500">
                                </div>
                                <div class="form-group">
                                    <label>Total Weight (g) <span style="color: var(--text-muted); font-size: 0.8em;">optional</span></label>
                                    <input type="number" id="ing-weight" step="0.1" placeholder="e.g., 200 (default: 100)">
                                </div>
                                <div class="form-group">
                                    <label>Protein (g total) <span style="color: var(--text-muted); font-size: 0.8em;">optional</span></label>
                                    <input type="number" id="ing-protein" step="0.1" placeholder="e.g., 52">
                                </div>
                                <div class="form-group">
                                    <label>Fat (g total) <span style="color: var(--text-muted); font-size: 0.8em;">optional</span></label>
                                    <input type="number" id="ing-fat" step="0.1" placeholder="e.g., 30">
                                </div>
                                <div class="form-group">
                                    <label>Carbs (g total) <span style="color: var(--text-muted); font-size: 0.8em;">optional</span></label>
                                    <input type="number" id="ing-carbs" step="0.1" placeholder="e.g., 0">
                                </div>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.85em; margin: 10px 0;">
                                Enter total values for your ingredient. If you specify weight, values will be converted to per-100g automatically.
                            </p>
                            <div class="quick-actions">
                                <button type="submit" class="btn btn-primary">
                                    <span>‚ûï</span> Add Ingredient
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Cal to kcal Converter -->
                    <div class="form-card glass-dark" style="margin-top: 20px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 16px;">üîÑ Calorie Converter</h3>
                        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: end;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Calories (cal)</label>
                                <input type="number" id="cal-input" step="0.1" placeholder="e.g., 1000" oninput="convertCalToKcal()">
                            </div>
                            <div style="padding-bottom: 8px; color: var(--text-secondary); font-size: 1.5em;">=</div>
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Kilocalories (kcal)</label>
                                <input type="number" id="kcal-output" step="0.1" placeholder="Result" readonly style="background: rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.5);">
                            </div>
                        </div>
                        <p style="color: var(--text-muted); font-size: 0.8em; margin-top: 12px; text-align: center;">
                            1 kcal = 1000 cal (small calories) | Food labels typically show kcal (large Calories)
                        </p>
                    </div>

                    <h3 class="section-title" style="margin-bottom: 20px;"><span>üì¶</span> Saved Ingredients</h3>
                    <div id="ingredients-list" class="cards-grid">
                        <div class="empty-state">
                            <span>ü•©</span>
                            <p>No ingredients saved yet. Search USDA or add custom ingredients!</p>
                        </div>
                    </div>
                </div>

                <!-- Recipes Tab -->
                <div id="recipes" class="tab-panel">
                    <!-- Recipes Sub-Navigation -->
                    <div class="sub-nav" style="display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap;">
                        <button class="btn btn-secondary sub-nav-btn active" data-subsection="my-recipes" onclick="switchRecipeSection('my-recipes')">
                            <span>üìã</span> My Recipes
                        </button>
                        <button class="btn btn-secondary sub-nav-btn" data-subsection="ingredients-lib" onclick="switchRecipeSection('ingredients-lib')">
                            <span>ü•©</span> Ingredients
                        </button>
                        <button class="btn btn-secondary sub-nav-btn" data-subsection="ingredient-guide" onclick="switchRecipeSection('ingredient-guide')">
                            <span>üìö</span> Guide
                        </button>
                        <button class="btn btn-secondary sub-nav-btn" data-subsection="what-if" onclick="switchRecipeSection('what-if')">
                            <span>üî¨</span> What If <span class="pro-badge-small">PRO</span>
                        </button>
                    </div>

                    <!-- My Recipes Sub-Section -->
                    <div id="sub-my-recipes" class="recipe-subsection active">
                        <div class="section-header">
                            <h2 class="section-title"><span>üìã</span> My Recipes</h2>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 8px;">Free: 1 recipe <span class="pro-badge pro-badge-inline" onclick="showUpgradeModal()">PRO</span> Unlimited recipes</p>
                        </div>

                        <div class="recipe-builder">
                        <div class="builder-section glass-dark">
                            <h3>üÜï Create New Recipe</h3>
                            <form id="recipe-form">
                                <div class="form-group">
                                    <label>Recipe Name</label>
                                    <input type="text" id="recipe-name" required placeholder="e.g., Chicken & Rice Bowl">
                                </div>
                                <div class="form-group">
                                    <label>Meals per Day</label>
                                    <select id="recipe-meals">
                                        <option value="1">1 meal</option>
                                        <option value="2" selected>2 meals</option>
                                        <option value="3">3 meals</option>
                                        <option value="4">4 meals</option>
                                    </select>
                                </div>
                                <div class="quick-actions">
                                    <button type="submit" class="btn btn-primary" id="create-recipe-btn">Create Recipe</button>
                                </div>
                            </form>
                        </div>

                        <div class="builder-section glass-dark">
                            <h3>‚úÖ Select Ingredients You Have</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">
                                Just check the ingredients you have on hand. The app will automatically calculate optimal portions based on your dog's needs!
                            </p>
                            <div class="form-group">
                                <label>Select Recipe to Add To</label>
                                <select id="recipe-select" onchange="loadRecipeIngredientCheckboxes()"></select>
                            </div>
                            <div class="checkbox-actions" style="display: flex; gap: 10px; margin: 15px 0;">
                                <button class="btn btn-sm" onclick="selectAllIngredients()">Select All</button>
                                <button class="btn btn-sm" onclick="clearAllIngredients()">Clear All</button>
                            </div>
                            <div id="ingredient-checkbox-list" class="ingredient-checkbox-list">
                                <div class="empty-state"><span>ü•©</span><p>Add ingredients first, then check the ones you have available</p></div>
                            </div>
                            <div id="ingredient-count-display" style="padding: 12px; text-align: center; font-weight: 500; color: var(--text-secondary); margin-top: 10px;"></div>
                            <div class="quick-actions" style="margin-top: 15px;">
                                <button class="btn btn-success" onclick="saveRecipeIngredients()">
                                    <span>üíæ</span> Save Selected Ingredients
                                </button>
                            </div>
                        </div>
                    </div>

                        <h3 class="section-title" style="margin: 32px 0 20px;"><span>üìö</span> Your Recipes</h3>
                        <div id="recipes-list" class="cards-grid">
                            <div class="empty-state">
                                <span>üìã</span>
                                <p>No recipes created yet. Create your first recipe above!</p>
                            </div>
                        </div>
                    </div><!-- End My Recipes Sub-Section -->

                    <!-- Ingredients Library Sub-Section (content pulled from old ingredients tab) -->
                    <div id="sub-ingredients-lib" class="recipe-subsection" style="display: none;">
                        <!-- This will show the ingredients content -->
                    </div>

                    <!-- Ingredient Guide Sub-Section (content pulled from old guide tab) -->
                    <div id="sub-ingredient-guide" class="recipe-subsection" style="display: none;">
                        <!-- This will show the guide content -->
                    </div>

                    <!-- What If Sub-Section (PRO gated) -->
                    <div id="sub-what-if" class="recipe-subsection" style="display: none;">
                        <!-- PRO Gate for What If -->
                        <div id="whatif-pro-gate" class="pro-gate-overlay">
                            <div class="pro-gate-content glass-dark" style="text-align: center; padding: 48px 32px; max-width: 500px; margin: 0 auto;">
                                <div style="font-size: 4rem; margin-bottom: 16px;">üî¨</div>
                                <h2 style="color: var(--text-primary); margin-bottom: 12px;">What-If Simulator</h2>
                                <p style="color: var(--text-secondary); margin-bottom: 24px; line-height: 1.6;">
                                    Test recipe changes and see how they affect nutrition before making them.
                                </p>
                                <button class="btn btn-primary" onclick="showUpgradeModal()" style="width: 100%;">
                                    <span>‚≠ê</span> Upgrade to Pro
                                </button>
                                <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 12px;">Coming Soon</p>
                            </div>
                        </div>
                        <!-- PRO What If Content (shown for PRO users) -->
                        <div id="whatif-content" style="display: none;">
                            <!-- Simulator content will be here -->
                        </div>
                    </div>
                </div><!-- End Recipes Tab -->

                <!-- Meal Planner Tab (HIDDEN - merged into Recipes) -->
                <div id="planner" class="tab-panel">
                    <div class="section-header">
                        <h2 class="section-title"><span>üçΩÔ∏è</span> Meal Planner</h2>
                    </div>

                    <div class="form-card glass-dark">
                        <h3 style="color: var(--text-primary); margin-bottom: 20px;">Calculate Feeding Plan</h3>
                        <form id="plan-form">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Select Dog</label>
                                    <select id="plan-dog" required></select>
                                </div>
                                <div class="form-group">
                                    <label>Select Recipe</label>
                                    <select id="plan-recipe" required></select>
                                </div>
                                <div class="form-group">
                                    <label>Kibble Calories (daily)</label>
                                    <input type="number" id="plan-kibble" value="0" min="0" placeholder="0 for homemade only">
                                </div>
                                <div class="form-group">
                                    <label>Treat Calories (daily)</label>
                                    <input type="number" id="plan-treats" value="0" min="0" placeholder="Account for treats">
                                </div>
                                <div class="form-group">
                                    <label>Prep Days (batch size)</label>
                                    <input type="number" id="plan-days" value="7" min="1" max="30" placeholder="Days to prep">
                                </div>
                            </div>
                            <div class="quick-actions">
                                <button type="submit" class="btn btn-primary">
                                    <span>üßÆ</span> Calculate Batch Plan
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="plan-result"></div>
                </div>

                <!-- Ingredient Guide Tab -->
                <div id="guide" class="tab-panel">
                    <div class="section-header">
                        <h2 class="section-title"><span>üìö</span> Ingredient Guide</h2>
                        <p style="color: var(--text-secondary); margin-top: 8px;">Learn about dog-friendly ingredients and their health benefits</p>
                    </div>

                    <!-- Category Filter -->
                    <div class="category-filter" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="filter-btn active" data-category="all">All</button>
                        <button class="filter-btn" data-category="proteins">Proteins</button>
                        <button class="filter-btn" data-category="vegetables">Vegetables</button>
                        <button class="filter-btn" data-category="fruits">Fruits</button>
                        <button class="filter-btn" data-category="grains">Grains</button>
                        <button class="filter-btn" data-category="oils">Fats & Oils</button>
                        <button class="filter-btn" data-category="supplements">Supplements</button>
                    </div>

                    <!-- Proteins Section -->
                    <div class="ingredient-category" data-category="proteins">
                        <div class="category-header glass-dark" onclick="toggleCategory(this)">
                            <h3><span>ü•©</span> Proteins (Meats, Fish, Eggs, Organs)</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Beef.png" alt="Beef" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Beef (lean)</h4>
                                    <p>Muscle building, iron, B12, zinc for immune health</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Beef, ground, lean')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Chicken.png" alt="Chicken" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Chicken</h4>
                                    <p>Lean protein, glucosamine for joints, B vitamins</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Chicken, breast')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Turkey.png" alt="Turkey" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Turkey</h4>
                                    <p>Low-fat protein, selenium, tryptophan for calm</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Turkey, ground')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Lamb.png" alt="Lamb" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Lamb</h4>
                                    <p>Iron-rich, good for dogs with chicken allergies</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Lamb, ground')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Salmon.png" alt="Salmon" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Salmon</h4>
                                    <p>Omega-3 for coat/skin, brain health, anti-inflammatory</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Salmon, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Sardines.png" alt="Sardines" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Sardines</h4>
                                    <p>Omega-3, calcium (with bones), CoQ10 for heart</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Sardines, canned')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Eggs.png" alt="Eggs" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Eggs</h4>
                                    <p>Complete protein, biotin for coat, choline for brain</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Egg, whole, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Beef Liver.png" alt="Beef Liver" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Beef Liver</h4>
                                    <p class="warning-text">Vitamin A powerhouse, iron, B12 - feed sparingly (max 5% of diet)</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Beef liver, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Beef Heart.png" alt="Beef Heart" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Beef Heart</h4>
                                    <p>Taurine for heart health, CoQ10, B vitamins</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Beef heart, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Duck.png" alt="Duck" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Duck</h4>
                                    <p>Novel protein for allergies, rich in iron and amino acids</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Duck, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Venison.png" alt="Venison" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Venison</h4>
                                    <p>Novel protein for allergies, very lean</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Venison, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/COD.png" alt="Cod" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Cod</h4>
                                    <p>Lean white fish, iodine for thyroid</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Cod, cooked')">+ Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Vegetables Section -->
                    <div class="ingredient-category" data-category="vegetables">
                        <div class="category-header glass-dark" onclick="toggleCategory(this)">
                            <h3><span>ü•¶</span> Vegetables</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Broccoli.png" alt="Broccoli" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Broccoli</h4>
                                    <p>Fiber, vitamin C, cancer-fighting sulforaphane</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Broccoli, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Carrots.png" alt="Carrots" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Carrots</h4>
                                    <p>Beta-carotene for eyes, fiber, dental health</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Carrots, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Green Beans.png" alt="Green Beans" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Green Beans</h4>
                                    <p>Low-cal fiber, vitamins K & C, weight management</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Green beans, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Peas.png" alt="Peas" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Peas</h4>
                                    <p>Protein, fiber, vitamins A/K, lutein for eyes</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Peas, green, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Sweet Potato.png" alt="Sweet Potato" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Sweet Potato</h4>
                                    <p>Fiber, beta-carotene, vitamin B6, digestive health</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Sweet potato, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Pumpkin.png" alt="Pumpkin" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Pumpkin</h4>
                                    <p>Digestive aid, fiber for diarrhea/constipation</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Pumpkin, canned')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Spinach.png" alt="Spinach" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Spinach</h4>
                                    <p class="warning-text">Iron, antioxidants - limit due to oxalates</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Spinach, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Zuchinni.png" alt="Zucchini" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Zucchini</h4>
                                    <p>Low-cal, potassium, vitamin C</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Zucchini, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Butternut Squash.png" alt="Butternut Squash" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Butternut Squash</h4>
                                    <p>Beta-carotene, fiber, potassium</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Butternut squash, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Celery.png" alt="Celery" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Celery</h4>
                                    <p>Fresh breath, vitamins A/C/K, low calorie</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Celery, raw')">+ Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Fruits Section -->
                    <div class="ingredient-category" data-category="fruits">
                        <div class="category-header glass-dark" onclick="toggleCategory(this)">
                            <h3><span>ü´ê</span> Fruits</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Blueberries.png" alt="Blueberries" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Blueberries</h4>
                                    <p>Antioxidant superfood, brain health, UTI prevention</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Blueberries, raw')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Cranberries.png" alt="Cranberries" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Cranberries</h4>
                                    <p>Urinary tract health, prevents bacteria adhesion</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Cranberries, raw')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Apples.png" alt="Apples" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Apples (no seeds)</h4>
                                    <p>Fiber, vitamins A/C, dental cleaning</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Apples, raw')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Bananas.png" alt="Bananas" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Bananas</h4>
                                    <p class="warning-text">Potassium, B6, fiber - high sugar, use sparingly</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Bananas, raw')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Watermelon.png" alt="Watermelon" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Watermelon (no seeds)</h4>
                                    <p>Hydration, vitamins A/B6/C, lycopene</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Watermelon, raw')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Strawberries.png" alt="Strawberries" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Strawberries</h4>
                                    <p>Vitamin C, fiber, teeth-whitening enzymes</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Strawberries, raw')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Cantaloupe.png" alt="Cantaloupe" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Cantaloupe</h4>
                                    <p>Beta-carotene, fiber, hydration</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Cantaloupe, raw')">+ Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Grains Section -->
                    <div class="ingredient-category" data-category="grains">
                        <div class="category-header glass-dark" onclick="toggleCategory(this)">
                            <h3><span>üåæ</span> Grains & Starches</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/White Rice.png" alt="White Rice" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>White Rice</h4>
                                    <p>Easy to digest, good for upset stomach</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Rice, white, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Brown Rice.png" alt="Brown Rice" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Brown Rice</h4>
                                    <p>Fiber, B vitamins, manganese</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Rice, brown, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Oatmeal.png" alt="Oatmeal" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Oatmeal</h4>
                                    <p>Fiber, soothes skin allergies, B vitamins</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Oatmeal, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Quinoa.png" alt="Quinoa" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Quinoa</h4>
                                    <p>Complete protein, fiber, magnesium</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Quinoa, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Sweet Potato.png" alt="Sweet Potato" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Sweet Potato</h4>
                                    <p>Fiber, beta-carotene, vitamins A/C</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Sweet potato, cooked')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Lentils.png" alt="Lentils" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Lentils</h4>
                                    <p>Protein, fiber, iron, folate</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Lentils, cooked')">+ Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Fats & Oils Section -->
                    <div class="ingredient-category" data-category="oils">
                        <div class="category-header glass-dark" onclick="toggleCategory(this)">
                            <h3><span>ü´í</span> Healthy Fats & Oils</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Salmon Oil.png" alt="Salmon Oil" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Salmon Oil</h4>
                                    <p>Omega-3 EPA/DHA, coat shine, joint health</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Fish oil, salmon')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Coconut Oil.png" alt="Coconut Oil" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Coconut Oil</h4>
                                    <p>MCTs for energy, skin health, antibacterial</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Coconut oil')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Flaxseed Oil.png" alt="Flaxseed Oil" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Flaxseed Oil</h4>
                                    <p>Plant omega-3 (ALA), fiber, coat health</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Flaxseed oil')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Olive Oil.png" alt="Olive Oil" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Olive Oil</h4>
                                    <p>Healthy fats, vitamin E, antioxidants</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Olive oil')">+ Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Supplements Section -->
                    <div class="ingredient-category" data-category="supplements">
                        <div class="category-header glass-dark" onclick="toggleCategory(this)">
                            <h3><span>‚ú®</span> Supplements & Superfoods</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div class="category-content">
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Chia Seeds.png" alt="Chia Seeds" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Chia Seeds</h4>
                                    <p>Omega-3, fiber, calcium, protein</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Chia seeds')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Hemp Seeds.png" alt="Hemp Seeds" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Hemp Seeds</h4>
                                    <p>Complete protein, omega-3/6, GLA</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Hemp seeds')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Flax Seed.png" alt="Flax Seeds" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Flax Seeds (ground)</h4>
                                    <p>Omega-3, fiber, lignans - must be ground to absorb</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Flaxseed, ground')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Turmeric.png" alt="Turmeric" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Turmeric</h4>
                                    <p>Anti-inflammatory curcumin, joint support</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Turmeric, ground')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Local Honey.png" alt="Local Honey" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Local Honey</h4>
                                    <p class="warning-text">Allergy relief, antibacterial - use sparingly (high sugar)</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Honey')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Parsley.png" alt="Parsley" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Parsley</h4>
                                    <p>Fresh breath, vitamins A/C/K, antioxidants</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Parsley, fresh')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Eggshell Powder.png" alt="Eggshell Powder" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Eggshell Powder</h4>
                                    <p>Calcium supplement - 1,800mg calcium per teaspoon</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Eggshell powder')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Pumpkin Seeds.png" alt="Pumpkin Seeds" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Pumpkin Seeds</h4>
                                    <p>Zinc, natural anti-parasitic properties</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Pumpkin seeds')">+ Add</button>
                            </div>
                            <div class="ingredient-card glass-dark">
                                <img src="images/ingredients/Bone Broth.png" alt="Bone Broth" class="ingredient-img">
                                <div class="ingredient-info">
                                    <h4>Bone Broth</h4>
                                    <p>Joint support, gut healing, hydration</p>
                                </div>
                                <button class="btn btn-small" onclick="openAddToRecipeModal('Bone broth')">+ Add</button>
                            </div>
                        </div>
                    </div>

                    <!-- Dangerous Foods Section -->
                    <div class="danger-section">
                        <div class="danger-section-header">
                            <h2>üö´ Dangerous Foods for Dogs</h2>
                            <p>Know what to avoid ‚Äî some of these can be fatal</p>
                        </div>

                        <!-- Tier 1: Deadly -->
                        <div class="danger-tier tier-deadly">
                            <div class="danger-tier-header">
                                <h3>üç´ DEADLY ‚Äî Can Kill Quickly</h3>
                            </div>
                            <h4 style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 10px;">Human Foods That Kill Dogs</h4>
                            <div class="danger-grid">
                                <div class="danger-item skull">Chocolate (dark & baking worst)</div>
                                <div class="danger-item skull">Cocoa powder</div>
                                <div class="danger-item skull">Coffee / Espresso / Caffeine</div>
                                <div class="danger-item skull">Grapes</div>
                                <div class="danger-item skull">Raisins</div>
                                <div class="danger-item skull">Alcohol</div>
                                <div class="danger-item skull">Macadamia nuts</div>
                                <div class="danger-item skull">Xylitol (artificial sweetener)</div>
                                <div class="danger-item skull">Nutmeg (large amounts)</div>
                            </div>

                            <h4 style="color: var(--text-secondary); font-size: 0.85rem; margin: 20px 0 10px 0;">üßÖ Plants/Veggies That Destroy Organs</h4>
                            <div class="danger-grid">
                                <div class="danger-item skull">Onions (raw, cooked, powdered)</div>
                                <div class="danger-item skull">Garlic (raw, cooked, powdered)</div>
                                <div class="danger-item skull">Chives</div>
                                <div class="danger-item skull">Leeks</div>
                                <div class="danger-item skull">Shallots</div>
                            </div>
                            <div class="danger-note">These cause hemolytic anemia ‚Äî red blood cells literally explode.</div>
                        </div>

                        <!-- Tier 2: Very Dangerous -->
                        <div class="danger-tier tier-very-dangerous">
                            <div class="danger-tier-header">
                                <h3>üö® VERY DANGEROUS ‚Äî Can Kill, Often Dose-Dependent</h3>
                            </div>
                            <div class="danger-grid">
                                <div class="danger-item warning">Cooked bones (splinter, perforate)</div>
                                <div class="danger-item warning">Corn cobs (blockage risk)</div>
                                <div class="danger-item warning">Peach / Plum / Cherry pits</div>
                                <div class="danger-item warning">Apple seeds (cyanide)</div>
                                <div class="danger-item warning">Raw yeast dough</div>
                                <div class="danger-item warning">Fat trimmings / Grease</div>
                                <div class="danger-item warning">Moldy food</div>
                                <div class="danger-item warning">Rotten food</div>
                                <div class="danger-item warning">Hops (beer brewing)</div>
                                <div class="danger-item warning">Large amounts of liver</div>
                            </div>
                            <div class="danger-note">Fat trimmings trigger pancreatitis. Pits contain cyanide + obstruction risk. Large liver amounts cause vitamin A toxicity.</div>
                        </div>

                        <!-- Tier 3: Toxic -->
                        <div class="danger-tier tier-toxic">
                            <div class="danger-tier-header">
                                <h3>‚ö†Ô∏è TOXIC ‚Äî Damages Organs Over Time</h3>
                            </div>
                            <div class="danger-grid">
                                <div class="danger-item caution">Avocado (persin + fat)</div>
                                <div class="danger-item caution">Wild mushrooms</div>
                                <div class="danger-item caution">Raw potatoes</div>
                                <div class="danger-item caution">Green potato skins</div>
                                <div class="danger-item caution">Tomato leaves / stems</div>
                                <div class="danger-item caution">Rhubarb leaves</div>
                                <div class="danger-item caution">Excess salt</div>
                                <div class="danger-item caution">Excess sugar</div>
                                <div class="danger-item caution">Excess iodine (kelp, seaweed)</div>
                                <div class="danger-item caution">Excess vitamin D</div>
                                <div class="danger-item caution">Excess calcium (large breeds)</div>
                            </div>
                        </div>

                        <!-- Tier 4: Harmful -->
                        <div class="danger-tier tier-harmful">
                            <div class="danger-tier-header">
                                <h3>ü§¢ HARMFUL ‚Äî Not Toxic But Can Wreck Them</h3>
                            </div>
                            <h4 style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 10px;">Dairy & Processed Foods</h4>
                            <div class="danger-grid">
                                <div class="danger-item no">Milk</div>
                                <div class="danger-item no">Ice cream</div>
                                <div class="danger-item no">Cheese (small amounts sometimes ok)</div>
                                <div class="danger-item no">Spicy food</div>
                                <div class="danger-item no">Fried food</div>
                                <div class="danger-item no">Highly processed food</div>
                                <div class="danger-item no">Sugary food</div>
                                <div class="danger-item no">Seasoned food</div>
                                <div class="danger-item no">Human sauces (BBQ, teriyaki)</div>
                                <div class="danger-item no">Fast food</div>
                                <div class="danger-item no">Anything heavily salted</div>
                            </div>
                        </div>

                        <!-- Bones Info -->
                        <div class="danger-tier tier-info">
                            <div class="danger-tier-header">
                                <h3>ü¶¥ Bones ‚Äî Important Distinction</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <h4 style="color: #ef4444; font-size: 0.9rem; margin-bottom: 10px;">‚ùå NEVER Give:</h4>
                                    <div class="danger-grid" style="grid-template-columns: 1fr;">
                                        <div class="danger-item no">Cooked bones</div>
                                        <div class="danger-item no">Smoked bones</div>
                                        <div class="danger-item no">Store-bought brittle bones</div>
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color: #eab308; font-size: 0.9rem; margin-bottom: 10px;">‚ö†Ô∏è Maybe, With Caution:</h4>
                                    <div class="danger-grid" style="grid-template-columns: 1fr;">
                                        <div class="danger-item maybe">Raw bones (reputable source)</div>
                                        <div class="danger-item maybe">Size-appropriate only</div>
                                        <div class="danger-item maybe">Supervised only</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Spices -->
                        <div class="danger-tier tier-deadly">
                            <div class="danger-tier-header">
                                <h3>üßÇ Dangerous Spices & Seasonings</h3>
                            </div>
                            <div class="danger-grid">
                                <div class="danger-item skull">Onion powder</div>
                                <div class="danger-item skull">Garlic powder</div>
                                <div class="danger-item skull">Nutmeg</div>
                                <div class="danger-item warning">Excess salt</div>
                                <div class="danger-item warning">Chili powder</div>
                                <div class="danger-item warning">Cayenne</div>
                                <div class="danger-item warning">Paprika (irritates GI)</div>
                                <div class="danger-item warning">"Seasoning blends" (contain onion/garlic)</div>
                            </div>
                        </div>

                        <!-- Emergency Symptoms -->
                        <div class="danger-tier tier-deadly" style="background: rgba(220, 38, 38, 0.2);">
                            <div class="danger-tier-header">
                                <h3>üß† Emergency Symptoms ‚Äî VET NOW!</h3>
                            </div>
                            <p style="color: var(--text-primary); margin-bottom: 15px;">If your dog shows ANY of these symptoms after eating something suspicious:</p>
                            <div class="symptoms-grid">
                                <div class="symptom-item">Vomiting</div>
                                <div class="symptom-item">Lethargy</div>
                                <div class="symptom-item">Tremors</div>
                                <div class="symptom-item">Seizures</div>
                                <div class="symptom-item">Collapse</div>
                                <div class="symptom-item">Pale gums</div>
                                <div class="symptom-item">Refusing food</div>
                                <div class="symptom-item">Bloody diarrhea</div>
                                <div class="symptom-item">Abdominal pain</div>
                                <div class="symptom-item">Disorientation</div>
                            </div>
                            <div class="danger-note" style="margin-top: 15px; background: var(--bg-secondary); border-left-color: #fff;">
                                <strong>ASPCA Animal Poison Control:</strong> (888) 426-4435 (fee applies) ‚Äî Available 24/7
                            </div>
                        </div>
                    </div>
                </div>

                <!-- What If Simulator Tab -->
                <div id="simulator" class="tab-panel">
                    <div class="section-header">
                        <h2 class="section-title"><span>üî¨</span> What If Simulator</h2>
                        <p style="color: var(--text-secondary); margin-top: 8px;">See how ingredient changes affect your dog's nutrition</p>
                    </div>

                    <div class="form-card glass-dark">
                        <h3 style="color: var(--text-primary); margin-bottom: 20px;">Select Dog & Recipe</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Dog</label>
                                <select id="sim-dog" required onchange="loadSimulatorRecipe()"></select>
                            </div>
                            <div class="form-group">
                                <label>Select Recipe</label>
                                <select id="sim-recipe" required onchange="loadSimulatorRecipe()"></select>
                            </div>
                        </div>
                    </div>

                    <!-- Kibble Input Section -->
                    <div id="kibble-section" class="form-card glass-dark" style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: var(--text-primary); margin: 0;">ü•£ Kibble Base (Optional)</h3>
                            <label class="toggle-switch">
                                <input type="checkbox" id="kibble-toggle" onchange="toggleKibbleSection()">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.9rem;">Enable to add kibble alongside fresh food (hybrid feeding)</p>

                        <div id="kibble-inputs" style="display: none;">
                            <p style="color: var(--text-muted); margin-bottom: 15px; font-size: 0.85rem;">Enter values from your kibble's Guaranteed Analysis (GA)</p>

                            <div class="form-grid" style="grid-template-columns: repeat(3, 1fr);">
                                <div class="form-group">
                                    <label>Protein %</label>
                                    <input type="number" id="kibble-protein" step="0.1" min="0" max="100" placeholder="e.g., 26" oninput="previewKibbleCarbs()">
                                </div>
                                <div class="form-group">
                                    <label>Fat %</label>
                                    <input type="number" id="kibble-fat" step="0.1" min="0" max="100" placeholder="e.g., 15" oninput="previewKibbleCarbs()">
                                </div>
                                <div class="form-group">
                                    <label>Fiber %</label>
                                    <input type="number" id="kibble-fiber" step="0.1" min="0" max="100" placeholder="e.g., 4" oninput="previewKibbleCarbs()">
                                </div>
                                <div class="form-group">
                                    <label>Moisture %</label>
                                    <input type="number" id="kibble-moisture" step="0.1" min="0" max="100" value="10" placeholder="10" oninput="previewKibbleCarbs()">
                                </div>
                                <div class="form-group">
                                    <label>Ash %</label>
                                    <input type="number" id="kibble-ash" step="0.1" min="0" max="100" value="7" placeholder="7" oninput="previewKibbleCarbs()">
                                </div>
                                <div class="form-group">
                                    <label>Amount (grams)</label>
                                    <input type="number" id="kibble-amount" step="1" min="1" placeholder="e.g., 150">
                                </div>
                            </div>

                            <!-- Optional Ca/P -->
                            <div class="form-grid" style="grid-template-columns: repeat(2, 1fr); margin-top: 10px;">
                                <div class="form-group">
                                    <label>Calcium % <span style="color: var(--text-muted);">(if listed)</span></label>
                                    <input type="number" id="kibble-calcium" step="0.01" min="0" max="10" placeholder="e.g., 1.2">
                                </div>
                                <div class="form-group">
                                    <label>Phosphorus % <span style="color: var(--text-muted);">(if listed)</span></label>
                                    <input type="number" id="kibble-phosphorus" step="0.01" min="0" max="10" placeholder="e.g., 1.0">
                                </div>
                            </div>

                            <!-- Calculated NFE Display -->
                            <div id="kibble-nfe-display" style="margin-top: 15px; padding: 12px; background: rgba(14, 165, 233, 0.1); border-radius: 8px; display: none;">
                                <span style="color: var(--text-secondary);">Calculated Carbs (NFE): </span>
                                <span id="kibble-nfe-value" style="color: var(--text-primary); font-weight: 600;">0%</span>
                            </div>

                            <!-- High Filler Warning -->
                            <div id="high-filler-warning" style="display: none; margin-top: 15px; padding: 12px; background: rgba(249, 115, 22, 0.2); border-radius: 8px; border-left: 4px solid #f97316;">
                                <strong style="color: #f97316;">HIGH FILLER CONTENT</strong>
                                <p style="color: var(--text-secondary); margin: 5px 0 0 0; font-size: 0.9rem;">
                                    Kibble is <span id="kibble-carb-display">0</span>% carbohydrates. Consider a lower-carb option.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div id="simulator-content" style="display: none;">
                        <!-- Current Nutrition Overview -->
                        <div class="form-card glass-dark" style="margin-top: 20px;">
                            <h3 style="color: var(--text-primary); margin-bottom: 15px;">üìä Current Nutritional Profile</h3>
                            <div id="current-nutrition-display"></div>
                        </div>

                        <!-- Ingredient Adjustments -->
                        <div class="form-card glass-dark" style="margin-top: 20px;">
                            <h3 style="color: var(--text-primary); margin-bottom: 15px;">üîß Adjust Fresh Ingredients</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 15px;">Change amounts below and click "Simulate" to see the impact</p>
                            <div id="ingredient-adjustments"></div>
                            <div class="quick-actions" style="margin-top: 20px;">
                                <button type="button" class="btn btn-primary" onclick="runSimulation()">
                                    <span>üî¨</span> Simulate Changes
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="resetSimulator()">
                                    <span>‚Ü∫</span> Reset
                                </button>
                            </div>
                        </div>

                        <!-- Simulation Results -->
                        <div id="simulation-results" style="display: none;">
                            <!-- Overall Status -->
                            <div id="overall-status-card" class="form-card glass-dark" style="margin-top: 20px;"></div>

                            <!-- Source Breakdown (Kibble vs Fresh) -->
                            <div class="form-card glass-dark" style="margin-top: 20px;">
                                <h3 style="color: var(--text-primary); margin-bottom: 15px;">üìä Nutrient Sources: Kibble vs Fresh</h3>
                                <div style="max-width: 600px; margin: 0 auto;">
                                    <canvas id="source-breakdown-chart"></canvas>
                                </div>
                                <div id="source-legend" style="display: flex; justify-content: center; gap: 20px; margin-top: 15px;">
                                    <span><span style="display: inline-block; width: 12px; height: 12px; background: #f59e0b; border-radius: 2px; margin-right: 5px;"></span>Kibble</span>
                                    <span><span style="display: inline-block; width: 12px; height: 12px; background: #10b981; border-radius: 2px; margin-right: 5px;"></span>Fresh</span>
                                </div>
                            </div>

                            <!-- Ca:P Ratio Card -->
                            <div id="ca-p-card" class="form-card glass-dark" style="margin-top: 20px; display: none;">
                                <h3 style="color: var(--text-primary); margin-bottom: 15px;">ü¶¥ Calcium : Phosphorus Ratio</h3>
                                <div id="ca-p-display"></div>
                            </div>

                            <!-- Nutrient Bars -->
                            <div class="form-card glass-dark" style="margin-top: 20px;">
                                <h3 style="color: var(--text-primary); margin-bottom: 15px;">üìà Nutrient Levels vs AAFCO Requirements</h3>
                                <div id="nutrient-bars"></div>
                            </div>

                            <!-- What Changed Summary -->
                            <div id="change-summary" class="form-card glass-dark" style="margin-top: 20px;"></div>
                        </div>
                    </div>
                </div>

                <!-- About Tab -->
                <div id="about" class="tab-panel">
                    <div class="about-content">
                        <img src="images/gunner-1.jpg" class="about-hero-img" alt="Gunner running happily in the backyard">

                        <h1 class="about-heading">Meet Gunner</h1>

                        <div class="about-text">
                            <p>I rescued Gunner in 2021. From the moment I met him, I knew this was not just a dog. <span class="emphasis">This was family.</span></p>

                            <p>Like a lot of people who love their dog, I told myself I wanted to give him "the best." But between work, school, and life, "the best" slowly turned into convenience. Table scraps. Extra treats. A little too much, a little too often.</p>

                            <p class="emotional">And one day I realized he was not just getting older.</p>

                            <p class="emotional">He was getting heavier. Slower.</p>

                            <p><span class="emphasis">That one hurt.</span> Because that was not on time. That was on me.</p>

                            <p>I am not a veterinarian. I am just a guy who did not want to keep guessing and hoping I was doing the right thing. So I started learning. I researched. I tried things. I messed up. I adjusted. I tracked everything. Ingredients. Portions. What worked. What did not.</p>

                            <p>And I will be honest. It was intimidating at first. There is a lot of noise out there. A lot of opinions. A lot of ways to feel like you are doing it wrong.</p>

                            <p>What I needed was not perfection. <span class="emphasis">I needed consistency.</span> I needed a simple way to stay intentional instead of winging it.</p>

                            <p>So I built this app for myself.</p>

                            <p>Something to take the guesswork out of meal planning. Something to keep me honest. Something that turns good intentions into actual habits.</p>

                            <p><span class="emphasis">And it worked.</span></p>

                            <p>Gunner is healthier. He is more energetic. He is excited for every meal in a way he never was before. More importantly, I know what is in his bowl and why.</p>

                            <p>This app is our story turned into a tool.</p>

                            <p>It is not a substitute for veterinary advice. You should always work with your vet when changing your dog's diet. But if you are like I was, trying to do better and tired of guessing, this is what helped me stay on track.</p>

                            <div class="about-quote">
                                Your dog is not just a dog. They are family.
                            </div>

                            <p class="emotional">And one day, sooner than you want, you are going to look back and wish you had one more year. One more month. One more walk.</p>

                            <p>The least we can do is make sure the time they have is healthy, intentional, and full of love.</p>

                            <div class="about-cta">
                                <p>If you have ever looked at your dog and thought, "I could be doing better," this is where you start.</p>
                            </div>
                        </div>

                        <img src="images/gunner-2.webp" class="about-closing-img" alt="Gunner">
                    </div>
                </div>

                <!-- HISTORY Tab (PRO Gated) -->
                <div id="history" class="tab-panel">
                    <!-- PRO Gate Overlay (shown for FREE users) -->
                    <div id="history-pro-gate" class="pro-gate-overlay">
                        <div class="pro-gate-content glass-dark" style="text-align: center; padding: 48px 32px; max-width: 500px; margin: 0 auto;">
                            <div style="font-size: 4rem; margin-bottom: 16px;">üìä</div>
                            <h2 style="color: var(--text-primary); margin-bottom: 12px;">Unlock History with Pro</h2>
                            <p style="color: var(--text-secondary); margin-bottom: 24px; line-height: 1.6;">
                                Track your dog's progress over time with Fresh Pup Pro. See past meals, weight trends, and nutrition charts.
                            </p>
                            <ul style="text-align: left; color: var(--text-secondary); margin-bottom: 24px; padding-left: 20px;">
                                <li style="margin-bottom: 8px;">üìÖ Full meal history by day</li>
                                <li style="margin-bottom: 8px;">üìà Weight trend charts</li>
                                <li style="margin-bottom: 8px;">üéØ Goal tracking over time</li>
                                <li style="margin-bottom: 8px;">üìä Nutrition analysis</li>
                            </ul>
                            <button class="btn btn-primary" onclick="showUpgradeModal()" style="width: 100%;">
                                <span>‚≠ê</span> Upgrade to Pro
                            </button>
                            <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 12px;">Coming Soon</p>
                        </div>
                    </div>

                    <!-- PRO History Content (hidden for FREE users) -->
                    <div id="history-content" style="display: none;">
                        <div class="section-header">
                            <h2 class="section-title"><span>üìä</span> History & Progress</h2>
                        </div>

                        <!-- Dog Selector -->
                        <div class="form-card glass-dark" style="margin-bottom: 24px;">
                            <div class="form-group">
                                <label>Select Dog</label>
                                <select id="history-dog-select" onchange="loadHistoryData()">
                                    <option value="">Select a dog...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Date Range Picker -->
                        <div class="form-card glass-dark" style="margin-bottom: 24px;">
                            <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                                <button class="btn btn-secondary filter-btn active" data-range="7">Last 7 Days</button>
                                <button class="btn btn-secondary filter-btn" data-range="30">Last 30 Days</button>
                                <button class="btn btn-secondary filter-btn" data-range="90">Last 90 Days</button>
                            </div>
                        </div>

                        <!-- Weight Chart -->
                        <div class="form-card glass-dark" style="margin-bottom: 24px;">
                            <h3 style="color: var(--text-primary); margin-bottom: 16px;">Weight Trend</h3>
                            <div id="history-weight-chart" style="height: 250px; display: flex; align-items: center; justify-content: center;">
                                <p style="color: var(--text-muted);">Select a dog to see weight history</p>
                            </div>
                        </div>

                        <!-- Meal History -->
                        <div class="form-card glass-dark">
                            <h3 style="color: var(--text-primary); margin-bottom: 16px;">Meal History</h3>
                            <div id="history-meals-list">
                                <p style="color: var(--text-muted); text-align: center; padding: 20px;">Select a dog to see meal history</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SETTINGS Tab -->
                <div id="settings" class="tab-panel">
                    <div class="section-header">
                        <h2 class="section-title"><span>‚öôÔ∏è</span> Settings</h2>
                    </div>

                    <!-- Dog Management Section -->
                    <div class="settings-section glass-dark" style="margin-bottom: 24px;">
                        <div class="settings-section-header" onclick="toggleSettingsSection('dogs-section')" style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--text-primary); margin: 0;"><span>üêï</span> Dog Management</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div id="dogs-section" class="settings-section-content" style="display: none; padding: 0 20px 20px;">
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">
                                Free: 1 dog <span class="pro-badge pro-badge-inline" onclick="showUpgradeModal()">PRO</span> Unlimited dogs
                            </p>

                            <!-- Add Dog Form -->
                            <form id="settings-dog-form" style="margin-bottom: 24px;">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Name</label>
                                        <input type="text" id="settings-dog-name" required placeholder="e.g., Buddy">
                                    </div>
                                    <div class="form-group">
                                        <label>Breed (optional)</label>
                                        <input type="text" id="settings-dog-breed" placeholder="e.g., Golden Retriever">
                                    </div>
                                    <div class="form-group">
                                        <label>Current Weight (<span class="weight-unit-label">kg</span>)</label>
                                        <input type="number" id="settings-dog-weight" step="0.1" required placeholder="e.g., 25">
                                    </div>
                                    <div class="form-group">
                                        <label>Age (years)</label>
                                        <input type="number" id="settings-dog-age" step="0.1" required placeholder="e.g., 3">
                                    </div>
                                    <div class="form-group">
                                        <label>Activity Level</label>
                                        <select id="settings-dog-activity">
                                            <option value="low">Low - Senior or sedentary</option>
                                            <option value="moderate" selected>Moderate - Regular walks</option>
                                            <option value="high">High - Very active</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Life Stage</label>
                                        <select id="settings-dog-life-stage">
                                            <option value="puppy">Puppy (under 1 year)</option>
                                            <option value="adult" selected>Adult (1-7 years)</option>
                                            <option value="senior">Senior (7+ years)</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" id="settings-add-dog-btn">
                                    <span>‚ûï</span> Add Dog
                                </button>
                            </form>

                            <!-- Dogs List -->
                            <div id="settings-dogs-list" class="cards-grid"></div>
                        </div>
                    </div>

                    <!-- Subscription Section -->
                    <div class="settings-section glass-dark" style="margin-bottom: 24px;">
                        <div class="settings-section-header" onclick="toggleSettingsSection('subscription-section')" style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--text-primary); margin: 0;"><span>‚≠ê</span> Subscription</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div id="subscription-section" class="settings-section-content" style="display: none; padding: 0 20px 20px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <span style="color: var(--text-primary); font-weight: 600;">Current Plan:</span>
                                <span id="current-tier-badge" class="status-badge caution">FREE</span>
                            </div>
                            <div style="background: var(--primary-tint); padding: 20px; border-radius: 12px; margin-bottom: 16px;">
                                <h4 style="color: var(--primary); margin-bottom: 12px;">Pro Benefits:</h4>
                                <ul style="color: var(--text-secondary); padding-left: 20px; margin: 0;">
                                    <li>Unlimited dogs</li>
                                    <li>Unlimited recipes</li>
                                    <li>Full history & progress tracking</li>
                                    <li>Weight trend charts</li>
                                    <li>What-If nutrition simulator</li>
                                </ul>
                            </div>
                            <button class="btn btn-primary" onclick="showUpgradeModal()" style="width: 100%;">
                                <span>‚≠ê</span> Upgrade to Pro
                            </button>
                        </div>
                    </div>

                    <!-- Preferences Section -->
                    <div class="settings-section glass-dark" style="margin-bottom: 24px;">
                        <div class="settings-section-header" onclick="toggleSettingsSection('preferences-section')" style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--text-primary); margin: 0;"><span>üéõÔ∏è</span> Preferences</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div id="preferences-section" class="settings-section-content" style="display: none; padding: 0 20px 20px;">
                            <div class="form-group">
                                <label>Weight Unit</label>
                                <div class="unit-toggle" style="margin-top: 8px;">
                                    <button class="btn btn-secondary unit-btn active" data-unit="kg" onclick="setWeightUnit('kg')">kg</button>
                                    <button class="btn btn-secondary unit-btn" data-unit="lbs" onclick="setWeightUnit('lbs')">lbs</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- About Section -->
                    <div class="settings-section glass-dark" style="margin-bottom: 24px;">
                        <div class="settings-section-header" onclick="toggleSettingsSection('about-section')" style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--text-primary); margin: 0;"><span>‚ù§Ô∏è</span> About Fresh Pup</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div id="about-section" class="settings-section-content" style="display: none; padding: 0 20px 20px;">
                            <div class="about-content" style="max-width: 100%;">
                                <img src="images/gunner-1.jpg" class="about-hero-img" alt="Gunner" style="max-height: 300px;">
                                <h2 class="about-heading" style="font-size: 2rem;">Meet Gunner</h2>
                                <div class="about-text">
                                    <p>I rescued Gunner in 2021. From the moment I met him, I knew this was not just a dog. <span class="emphasis">This was family.</span></p>

                                    <p>Like a lot of people who love their dog, I told myself I wanted to give him "the best." But between work, school, and life, "the best" slowly turned into convenience. Table scraps. Extra treats. A little too much, a little too often.</p>

                                    <p class="emotional">And one day I realized he was not just getting older.</p>

                                    <p class="emotional">He was getting heavier. Slower.</p>

                                    <p><span class="emphasis">That one hurt.</span> Because that was not on time. That was on me.</p>

                                    <p>I am not a veterinarian. I am just a guy who did not want to keep guessing and hoping I was doing the right thing. So I started learning. I researched. I tried things. I messed up. I adjusted. I tracked everything. Ingredients. Portions. What worked. What did not.</p>

                                    <p>And I will be honest. It was intimidating at first. There is a lot of noise out there. A lot of opinions. A lot of ways to feel like you are doing it wrong.</p>

                                    <p>What I needed was not perfection. <span class="emphasis">I needed consistency.</span> I needed a simple way to stay intentional instead of winging it.</p>

                                    <p>So I built this app for myself.</p>

                                    <p>Something to take the guesswork out of meal planning. Something to keep me honest. Something that turns good intentions into actual habits.</p>

                                    <p><span class="emphasis">And it worked.</span></p>

                                    <p>Gunner is healthier. He is more energetic. He is excited for every meal in a way he never was before. More importantly, I know what is in his bowl and why.</p>

                                    <p>This app is our story turned into a tool.</p>

                                    <p>It is not a substitute for veterinary advice. You should always work with your vet when changing your dog's diet. But if you are like I was, trying to do better and tired of guessing, this is what helped me stay on track.</p>

                                    <div class="about-quote" style="margin: 20px 0;">
                                        Your dog is not just a dog. They are family.
                                    </div>

                                    <p class="emotional">And one day, sooner than you want, you are going to look back and wish you had one more year. One more month. One more walk.</p>

                                    <p>The least we can do is make sure the time they have is healthy, intentional, and full of love.</p>

                                    <div class="about-cta" style="margin-top: 20px;">
                                        <p>If you have ever looked at your dog and thought, "I could be doing better," this is where you start.</p>
                                    </div>
                                </div>
                                <img src="images/gunner-2.webp" class="about-closing-img" alt="Gunner" style="margin-top: 24px; border-radius: 16px; max-width: 100%;">
                            </div>
                        </div>
                    </div>

                    <!-- Disclaimer Section -->
                    <div class="settings-section glass-dark">
                        <div class="settings-section-header" onclick="toggleSettingsSection('disclaimer-section')" style="padding: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="color: var(--text-primary); margin: 0;"><span>üìã</span> Disclaimer</h3>
                            <span class="expand-icon">+</span>
                        </div>
                        <div id="disclaimer-section" class="settings-section-content" style="display: none; padding: 0 20px 20px;">
                            <div style="color: var(--text-secondary); line-height: 1.6;">
                                <p style="margin-bottom: 12px;"><strong>Not a substitute for veterinary advice.</strong></p>
                                <p style="margin-bottom: 12px;">Fresh Pup is designed to help you track and plan your dog's nutrition, but it is not a replacement for professional veterinary care.</p>
                                <p style="margin-bottom: 12px;">Always consult with your veterinarian before making significant changes to your dog's diet, especially if your dog has health conditions, allergies, or special dietary needs.</p>
                                <p>The calculations provided are estimates based on general formulas and may not be appropriate for every dog.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add to Recipe Modal -->
    <div class="modal-overlay" id="add-to-recipe-modal">
        <div class="modal">
            <h3>Add to Recipe</h3>
            <p style="color: var(--text-primary); margin-bottom: 20px;">
                Adding: <strong id="add-ingredient-name"></strong>
            </p>
            <div class="form-group">
                <label>Select Recipe</label>
                <select id="modal-recipe-select" required></select>
            </div>
            <div class="form-group">
                <label>Amount (grams)</label>
                <input type="number" id="modal-ingredient-grams" value="100" min="1" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAddToRecipeModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addIngredientToRecipe()">Add to Recipe</button>
            </div>
        </div>
    </div>

    <!-- Edit Dog Modal -->
    <div class="modal-overlay" id="edit-dog-modal">
        <div class="modal">
            <h3>Edit Dog</h3>
            <form id="edit-dog-form">
                <input type="hidden" id="edit-dog-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="edit-dog-name" required>
                </div>
                <div class="form-group">
                    <label>Breed</label>
                    <input type="text" id="edit-dog-breed" placeholder="Optional">
                </div>
                <div class="form-group">
                    <label>Current Weight (<span class="weight-unit-label">kg</span>)</label>
                    <input type="number" id="edit-dog-weight" step="0.1" required>
                </div>
                <div class="form-group">
                    <label>Target Weight (<span class="weight-unit-label">kg</span>)</label>
                    <input type="number" id="edit-dog-target-weight" step="0.1" placeholder="Leave empty for no target">
                </div>
                <div class="form-group">
                    <label>Age (years)</label>
                    <input type="number" id="edit-dog-age" step="0.1" required>
                </div>
                <div class="form-group">
                    <label>Life Stage</label>
                    <select id="edit-dog-life-stage">
                        <option value="puppy">Puppy</option>
                        <option value="adult">Adult</option>
                        <option value="senior">Senior</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Activity Level</label>
                    <select id="edit-dog-activity">
                        <option value="low">Low</option>
                        <option value="moderate">Moderate</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Target Daily Kcal (optional)</label>
                    <input type="number" id="edit-dog-target-kcal" step="1" placeholder="Override calculated MER">
                </div>
                <div class="form-group">
                    <label>Sex</label>
                    <select id="edit-dog-sex">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Neutered/Spayed</label>
                    <select id="edit-dog-neutered">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="edit-dog-notes" rows="2" placeholder="Allergies, medical conditions, etc."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-dog-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Ingredient Modal -->
    <div class="modal-overlay" id="edit-ingredient-modal">
        <div class="modal">
            <h3>Edit Ingredient</h3>
            <form id="edit-ingredient-form">
                <input type="hidden" id="edit-ingredient-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="edit-ingredient-name" required>
                </div>
                <div class="form-group">
                    <label>Calories (per 100g)</label>
                    <input type="number" id="edit-ingredient-kcal" step="0.1" required>
                </div>
                <div class="form-group">
                    <label>Protein (g per 100g)</label>
                    <input type="number" id="edit-ingredient-protein" step="0.1">
                </div>
                <div class="form-group">
                    <label>Fat (g per 100g)</label>
                    <input type="number" id="edit-ingredient-fat" step="0.1">
                </div>
                <div class="form-group">
                    <label>Carbs (g per 100g)</label>
                    <input type="number" id="edit-ingredient-carbs" step="0.1">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-ingredient-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Recipe Modal -->
    <div class="modal-overlay" id="edit-recipe-modal">
        <div class="modal">
            <h3>Edit Recipe</h3>
            <form id="edit-recipe-form">
                <input type="hidden" id="edit-recipe-id">
                <div class="form-group">
                    <label>Recipe Name</label>
                    <input type="text" id="edit-recipe-name" required>
                </div>
                <div class="form-group">
                    <label>Meals per Day</label>
                    <select id="edit-recipe-meals">
                        <option value="1">1 meal</option>
                        <option value="2">2 meals</option>
                        <option value="3">3 meals</option>
                        <option value="4">4 meals</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit-recipe-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal-overlay" id="confirm-delete-modal">
        <div class="modal">
            <h3>Confirm Delete</h3>
            <p id="delete-message" style="color: var(--text-primary); margin-bottom: 24px;">Are you sure you want to delete this item?</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('confirm-delete-modal')">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Upgrade to Pro Modal -->
    <div id="upgrade-modal">
        <div class="upgrade-modal-content glass">
            <h2>Unlock Fresh Pup Pro</h2>
            <p>Get more out of meal planning for your pups</p>
            <ul class="pro-benefits">
                <li>Unlimited dog profiles</li>
                <li>Unlimited recipes</li>
                <li>Weight tracking history</li>
                <li>Progress charts & insights</li>
                <li>Advanced goal settings</li>
            </ul>
            <button class="btn btn-upgrade">Coming Soon</button>
            <button class="btn btn-secondary" onclick="closeUpgradeModal()">Maybe Later</button>
        </div>
    </div>

    <!-- Onboarding Wizard Modal -->
    <div id="onboarding-modal" class="modal-overlay">
        <div class="modal" style="max-width: 550px;">
            <!-- Step 1: Welcome -->
            <div id="onboard-step-1" class="onboard-step active">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 4rem; margin-bottom: 16px;">üêï</div>
                    <h2 style="color: var(--text-primary); margin-bottom: 12px;">Welcome to Fresh Pup!</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 24px; line-height: 1.6;">
                        Let's set up your dog's nutrition plan in just a few steps.
                    </p>
                    <button class="btn btn-primary" onclick="nextOnboardStep(2)" style="width: 100%;">
                        Get Started
                    </button>
                </div>
            </div>

            <!-- Step 2: Add Your Dog -->
            <div id="onboard-step-2" class="onboard-step" style="display: none;">
                <h2 style="color: var(--text-primary); margin-bottom: 8px;">Add Your Dog</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Who are we feeding today?</p>
                <form id="onboard-dog-form">
                    <div class="form-group">
                        <label>Dog's Name</label>
                        <input type="text" id="onboard-dog-name" required placeholder="e.g., Buddy">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Weight (<span class="weight-unit-label">kg</span>)</label>
                            <input type="number" id="onboard-dog-weight" step="0.1" required placeholder="e.g., 25">
                        </div>
                        <div class="form-group">
                            <label>Age (years)</label>
                            <input type="number" id="onboard-dog-age" step="0.1" required placeholder="e.g., 3">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Activity Level</label>
                        <select id="onboard-dog-activity">
                            <option value="low">Low - Senior or sedentary</option>
                            <option value="moderate" selected>Moderate - Regular walks</option>
                            <option value="high">High - Very active</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="prevOnboardStep(1)" style="flex: 1;">Back</button>
                        <button type="submit" class="btn btn-primary" style="flex: 2;">Continue</button>
                    </div>
                </form>
            </div>

            <!-- Step 3: First Recipe (Optional) -->
            <div id="onboard-step-3" class="onboard-step" style="display: none;">
                <h2 style="color: var(--text-primary); margin-bottom: 8px;">Create Your First Recipe</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Give your homemade meal a name (you can add ingredients later)</p>
                <form id="onboard-recipe-form">
                    <div class="form-group">
                        <label>Recipe Name</label>
                        <input type="text" id="onboard-recipe-name" required placeholder="e.g., Chicken & Rice Bowl">
                    </div>
                    <div class="form-group">
                        <label>Meals per Day</label>
                        <select id="onboard-recipe-meals">
                            <option value="1">1 meal</option>
                            <option value="2" selected>2 meals</option>
                            <option value="3">3 meals</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="prevOnboardStep(2)" style="flex: 1;">Back</button>
                        <button type="submit" class="btn btn-primary" style="flex: 2;">Continue</button>
                    </div>
                </form>
                <button type="button" class="btn" style="width: 100%; margin-top: 12px; background: transparent; color: var(--text-muted);" onclick="skipToStep4()">
                    Skip for now
                </button>
            </div>

            <!-- Step 4: All Done -->
            <div id="onboard-step-4" class="onboard-step" style="display: none;">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 4rem; margin-bottom: 16px;">üéâ</div>
                    <h2 style="color: var(--text-primary); margin-bottom: 12px;">You're All Set!</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 8px;">
                        <strong id="onboard-dog-display">Your dog</strong> is ready to start eating better.
                    </p>
                    <div id="onboard-calories-display" style="background: var(--primary-tint); padding: 16px; border-radius: 12px; margin: 20px 0;">
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 4px;">Daily Calorie Target</p>
                        <p style="color: var(--primary); font-size: 2rem; font-weight: 700;" id="onboard-target-kcal">-- kcal</p>
                    </div>
                    <button class="btn btn-primary" onclick="finishOnboarding()" style="width: 100%;">
                        Start Using Fresh Pup
                    </button>
                </div>
            </div>

            <!-- Progress Dots -->
            <div style="display: flex; justify-content: center; gap: 8px; margin-top: 20px;">
                <div class="onboard-dot active" data-step="1"></div>
                <div class="onboard-dot" data-step="2"></div>
                <div class="onboard-dot" data-step="3"></div>
                <div class="onboard-dot" data-step="4"></div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="auth-modal">
        <div class="modal" style="max-width: 400px;">
            <!-- Auth Tabs -->
            <div class="auth-tabs" style="display: flex; margin-bottom: 24px; border-bottom: 2px solid var(--border-divider);">
                <button type="button" id="auth-tab-signin" onclick="setAuthMode('signin')" class="auth-tab active" style="flex: 1; padding: 12px; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: 600; color: var(--primary); border-bottom: 2px solid var(--primary); margin-bottom: -2px;">
                    Sign In
                </button>
                <button type="button" id="auth-tab-signup" onclick="setAuthMode('signup')" class="auth-tab" style="flex: 1; padding: 12px; background: none; border: none; cursor: pointer; font-size: 1rem; font-weight: 500; color: var(--text-secondary); border-bottom: 2px solid transparent; margin-bottom: -2px;">
                    Sign Up
                </button>
            </div>

            <p style="color: var(--text-secondary); margin-bottom: 20px;" id="auth-modal-subtitle">
                Sign in to sync your data across devices
            </p>

            <!-- Auth Form -->
            <form id="auth-form" onsubmit="handleAuth(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="auth-email" required placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="auth-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
                </div>
                <div id="forgot-password-link" style="text-align: right; margin-top: -8px; margin-bottom: 16px;">
                    <button type="button" onclick="showForgotPassword()" style="color: var(--primary); background: none; border: none; cursor: pointer; font-size: 0.9rem;">
                        Forgot Password?
                    </button>
                </div>
                <div id="auth-error" style="display: none; color: var(--danger); margin-bottom: 16px; padding: 12px; background: rgba(217, 137, 108, 0.1); border-radius: 8px;"></div>
                <div class="modal-actions" style="flex-direction: column; gap: 12px;">
                    <button type="submit" class="btn btn-primary" style="width: 100%;" id="auth-submit-btn">
                        Sign In
                    </button>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="closeAuthModal()">
                        Cancel
                    </button>
                </div>
            </form>

            <!-- Forgot Password Form (hidden by default) -->
            <form id="forgot-password-form" onsubmit="handlePasswordReset(event)" style="display: none;">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="reset-email" required placeholder="your@email.com">
                </div>
                <div id="reset-message" style="display: none; margin-bottom: 16px; padding: 12px; border-radius: 8px;"></div>
                <div class="modal-actions" style="flex-direction: column; gap: 12px;">
                    <button type="submit" class="btn btn-primary" style="width: 100%;" id="reset-submit-btn">
                        Send Reset Link
                    </button>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="hideForgotPassword()">
                        Back to Sign In
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profile-modal">
        <div class="modal" style="max-width: 450px;">
            <h3>Your Profile</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">
                Manage your account settings
            </p>

            <form id="profile-form" onsubmit="updateProfile(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="profile-email" disabled style="background: var(--bg-surface); color: var(--text-secondary);">
                </div>
                <div class="form-group">
                    <label>Display Name</label>
                    <input type="text" id="profile-name" placeholder="Your name">
                </div>
                <div class="form-group">
                    <label>Avatar URL</label>
                    <input type="url" id="profile-avatar" placeholder="https://example.com/avatar.jpg">
                    <div id="avatar-preview" style="margin-top: 12px; text-align: center;">
                        <img id="avatar-preview-img" src="" alt="Avatar preview" style="width: 80px; height: 80px; border-radius: 50%; display: none; object-fit: cover; border: 3px solid var(--primary);">
                    </div>
                </div>
                <div id="profile-message" style="display: none; margin-bottom: 16px; padding: 12px; border-radius: 8px;"></div>
                <div class="modal-actions" style="flex-direction: column; gap: 12px;">
                    <button type="submit" class="btn btn-primary" style="width: 100%;" id="profile-submit-btn">
                        Save Changes
                    </button>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="closeProfileModal()">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // ==================== Calculation Constants & Functions ====================
        // These replace the backend Python calculations for Cloudflare Pages deployment

        // Activity/life stage factors for MER calculation
        const ACTIVITY_FACTORS = {
            neutered_adult: 1.6,
            intact_adult: 1.8,
            weight_loss: 1.1,
            weight_gain: 1.8,
            puppy_young: 3.0,  // Under 4 months
            puppy_older: 2.0,  // 4+ months
        };

        // Modified Atwater factors for pet food (kcal/g)
        const MODIFIED_ATWATER = {
            protein: 3.5,
            fat: 8.5,
            carbs: 3.5,  // NFE
        };

        // Eggshell powder calcium content
        const EGGSHELL_CALCIUM_PCT = 38.0;  // 38% calcium by weight

        // AAFCO requirements (per 1000 kcal for adult maintenance)
        const AAFCO_REQUIREMENTS = {
            protein: { min: 45.0, max: null },
            fat: { min: 13.75, max: null },
            calcium: { min: 1.25, max: 6.25 },
            phosphorus: { min: 1.0, max: 4.0 },
            iron: { min: 10.0, max: null },
            zinc: { min: 20.0, max: null },
            vitamin_a: { min: 1250.0, max: 62500.0 },
            vitamin_d: { min: 3.125, max: 18.75 },
            vitamin_e: { min: 12.5, max: null },
        };

        /**
         * Calculate Resting Energy Requirement (RER)
         * Formula: RER = 70 √ó (weight_kg ^ 0.75)
         */
        function calculateRER(weightKg) {
            if (weightKg <= 0) throw new Error("Weight must be positive");
            return 70 * Math.pow(weightKg, 0.75);
        }

        /**
         * Get activity factor for MER calculation
         */
        function getActivityFactor(neutered, ageYears, targetWeightKg = null, currentWeightKg = null) {
            // Check for puppy (under 1 year)
            if (ageYears < 1) {
                if (ageYears < 4/12) {  // Under 4 months
                    return ACTIVITY_FACTORS.puppy_young;
                }
                return ACTIVITY_FACTORS.puppy_older;
            }

            // Check for weight management goals
            if (targetWeightKg !== null && currentWeightKg !== null) {
                if (targetWeightKg < currentWeightKg) {
                    return ACTIVITY_FACTORS.weight_loss;
                } else if (targetWeightKg > currentWeightKg) {
                    return ACTIVITY_FACTORS.weight_gain;
                }
            }

            // Adult dogs
            return neutered ? ACTIVITY_FACTORS.neutered_adult : ACTIVITY_FACTORS.intact_adult;
        }

        /**
         * Calculate Maintenance Energy Requirement (MER)
         * Formula: MER = RER √ó factor
         */
        function calculateMER(weightKg, factor) {
            return calculateRER(weightKg) * factor;
        }

        /**
         * Calculate nutrient amount for a given weight of ingredient
         */
        function calculateNutrientAmount(grams, nutrientPer100g) {
            return (grams * nutrientPer100g) / 100;
        }

        /**
         * Convert grams to calories
         */
        function gramsToKcal(grams, kcalPer100g) {
            return (grams / 100) * kcalPer100g;
        }

        /**
         * Convert desired calories to grams
         */
        function kcalToGrams(desiredKcal, kcalPer100g) {
            if (kcalPer100g <= 0) return 0;
            return (desiredKcal / kcalPer100g) * 100;
        }

        /**
         * Aggregate nutrient totals from recipe ingredients
         */
        function aggregateNutrients(ingredients, targetKcal) {
            const totals = {
                kcal: 0,
                protein_g: 0,
                fat_g: 0,
                carbs_g: 0,
                calcium_mg: 0,
                phosphorus_mg: 0,
                iron_mg: 0,
                zinc_mg: 0,
                vitamin_a_mcg: 0,
                vitamin_d_mcg: 0,
                vitamin_e_mg: 0,
            };

            // First pass: calculate total kcal from percentages
            let totalKcalFrom100g = 0;
            for (const ing of ingredients) {
                totalKcalFrom100g += (ing.percentage / 100) * ing.kcal_per_100g;
            }

            // Calculate scaling factor to reach target kcal
            const scaleFactor = totalKcalFrom100g > 0 ? targetKcal / totalKcalFrom100g : 0;

            // Second pass: calculate actual grams and nutrients
            for (const ing of ingredients) {
                const grams = (ing.percentage / 100) * 100 * scaleFactor;  // grams of this ingredient

                totals.kcal += calculateNutrientAmount(grams, ing.kcal_per_100g || 0);
                totals.protein_g += calculateNutrientAmount(grams, ing.protein_g_per_100g || 0);
                totals.fat_g += calculateNutrientAmount(grams, ing.fat_g_per_100g || 0);
                totals.carbs_g += calculateNutrientAmount(grams, ing.carbs_g_per_100g || 0);
                totals.calcium_mg += calculateNutrientAmount(grams, ing.calcium_mg_per_100g || 0);
                totals.phosphorus_mg += calculateNutrientAmount(grams, ing.phosphorus_mg_per_100g || 0);
                totals.iron_mg += calculateNutrientAmount(grams, ing.iron_mg_per_100g || 0);
                totals.zinc_mg += calculateNutrientAmount(grams, ing.zinc_mg_per_100g || 0);
                totals.vitamin_a_mcg += calculateNutrientAmount(grams, ing.vitamin_a_mcg_per_100g || 0);
                totals.vitamin_d_mcg += calculateNutrientAmount(grams, ing.vitamin_d_mcg_per_100g || 0);
                totals.vitamin_e_mg += calculateNutrientAmount(grams, ing.vitamin_e_mg_per_100g || 0);
            }

            return totals;
        }

        /**
         * Convert nutrient amount to per-1000kcal basis for AAFCO comparison
         */
        function nutrientPer1000kcal(nutrientAmount, totalKcal) {
            if (totalKcal <= 0) return 0;
            return (nutrientAmount / totalKcal) * 1000;
        }

        /**
         * Check AAFCO compliance for a nutrient
         */
        function checkAAFCOCompliance(nutrient, amountPer1000kcal, minPer1000kcal, maxPer1000kcal = null) {
            const result = {
                nutrient,
                amount_per_1000kcal: Math.round(amountPer1000kcal * 100) / 100,
                min_required: minPer1000kcal,
                max_allowed: maxPer1000kcal,
                status: 'adequate',
                warning: null,
                percentage: 0,
            };

            if (amountPer1000kcal < minPer1000kcal) {
                result.status = 'deficient';
                result.warning = `${nutrient} is below minimum (${amountPer1000kcal.toFixed(2)} < ${minPer1000kcal})`;
                result.percentage = (amountPer1000kcal / minPer1000kcal) * 100;
            } else if (maxPer1000kcal !== null && amountPer1000kcal > maxPer1000kcal) {
                result.status = 'excess';
                result.warning = `${nutrient} is above maximum (${amountPer1000kcal.toFixed(2)} > ${maxPer1000kcal})`;
                result.percentage = 100 + ((amountPer1000kcal - maxPer1000kcal) / maxPer1000kcal) * 100;
            } else {
                result.percentage = (amountPer1000kcal / minPer1000kcal) * 100;
            }

            return result;
        }

        /**
         * Calculate NFE (carbohydrates) from kibble GA
         */
        function calculateKibbleNFE(proteinPct, fatPct, fiberPct, moisturePct, ashPct) {
            const nfe = 100 - (proteinPct + fatPct + fiberPct + moisturePct + ashPct);
            return Math.max(0, nfe);
        }

        /**
         * Calculate nutrients from kibble guaranteed analysis
         */
        function calculateKibbleNutrients(proteinPct, fatPct, fiberPct, moisturePct, ashPct, amountGrams, calciumPct = null, phosphorusPct = null) {
            const nfePct = calculateKibbleNFE(proteinPct, fatPct, fiberPct, moisturePct, ashPct);

            const proteinG = (proteinPct / 100) * amountGrams;
            const fatG = (fatPct / 100) * amountGrams;
            const carbsG = (nfePct / 100) * amountGrams;
            const fiberG = (fiberPct / 100) * amountGrams;

            const kcal = proteinG * MODIFIED_ATWATER.protein +
                         fatG * MODIFIED_ATWATER.fat +
                         carbsG * MODIFIED_ATWATER.carbs;

            const calciumMg = calciumPct ? (calciumPct / 100) * amountGrams * 1000 : 0;
            const phosphorusMg = phosphorusPct ? (phosphorusPct / 100) * amountGrams * 1000 : 0;

            return {
                kcal: Math.round(kcal * 100) / 100,
                protein_g: Math.round(proteinG * 100) / 100,
                fat_g: Math.round(fatG * 100) / 100,
                carbs_g: Math.round(carbsG * 100) / 100,
                fiber_g: Math.round(fiberG * 100) / 100,
                calcium_mg: Math.round(calciumMg * 100) / 100,
                phosphorus_mg: Math.round(phosphorusMg * 100) / 100,
                nfe_pct: Math.round(nfePct * 100) / 100,
                carb_pct_of_kibble: Math.round(nfePct * 100) / 100,
            };
        }

        /**
         * Analyze Calcium to Phosphorus ratio
         */
        function analyzeCaPRatio(totalCalciumMg, totalPhosphorusMg, targetRatio = 1.2) {
            if (totalPhosphorusMg <= 0) {
                return {
                    total_calcium_mg: Math.round(totalCalciumMg * 100) / 100,
                    total_phosphorus_mg: 0,
                    ca_p_ratio: 0,
                    status: 'unknown',
                    calcium_gap_mg: null,
                    eggshell_recommendation_g: null,
                    message: 'Cannot calculate ratio: no phosphorus data'
                };
            }

            const actualRatio = totalCalciumMg / totalPhosphorusMg;

            if (actualRatio >= 1.1 && actualRatio <= 2.0) {
                return {
                    total_calcium_mg: Math.round(totalCalciumMg * 100) / 100,
                    total_phosphorus_mg: Math.round(totalPhosphorusMg * 100) / 100,
                    ca_p_ratio: Math.round(actualRatio * 100) / 100,
                    status: 'optimal',
                    calcium_gap_mg: null,
                    eggshell_recommendation_g: null,
                    message: `Ca:P ratio is ${actualRatio.toFixed(2)}:1 - within optimal range (1.1-2.0:1)`
                };
            } else if (actualRatio >= 1.0 && actualRatio < 1.1) {
                return {
                    total_calcium_mg: Math.round(totalCalciumMg * 100) / 100,
                    total_phosphorus_mg: Math.round(totalPhosphorusMg * 100) / 100,
                    ca_p_ratio: Math.round(actualRatio * 100) / 100,
                    status: 'acceptable',
                    calcium_gap_mg: null,
                    eggshell_recommendation_g: null,
                    message: `Ca:P ratio is ${actualRatio.toFixed(2)}:1 - acceptable but below optimal`
                };
            } else if (actualRatio < 1.0) {
                const calciumNeeded = totalPhosphorusMg * 1.0;
                const calciumGapMg = calciumNeeded - totalCalciumMg;
                const eggshellG = calciumGapMg / (EGGSHELL_CALCIUM_PCT / 100 * 1000);

                return {
                    total_calcium_mg: Math.round(totalCalciumMg * 100) / 100,
                    total_phosphorus_mg: Math.round(totalPhosphorusMg * 100) / 100,
                    ca_p_ratio: Math.round(actualRatio * 100) / 100,
                    status: 'low',
                    calcium_gap_mg: Math.round(calciumGapMg * 100) / 100,
                    eggshell_recommendation_g: Math.round(eggshellG * 100) / 100,
                    message: `Ca:P ratio is ${actualRatio.toFixed(2)}:1 - LOW. Add ${eggshellG.toFixed(1)}g eggshell powder`
                };
            } else {
                return {
                    total_calcium_mg: Math.round(totalCalciumMg * 100) / 100,
                    total_phosphorus_mg: Math.round(totalPhosphorusMg * 100) / 100,
                    ca_p_ratio: Math.round(actualRatio * 100) / 100,
                    status: 'high',
                    calcium_gap_mg: null,
                    eggshell_recommendation_g: null,
                    message: `Ca:P ratio is ${actualRatio.toFixed(2)}:1 - above optimal, reduce calcium sources`
                };
            }
        }

        /**
         * Combine kibble and fresh food nutrients
         */
        function combineNutrientTotals(kibbleNutrients, freshTotals) {
            return {
                kcal: (kibbleNutrients?.kcal || 0) + (freshTotals?.kcal || 0),
                protein_g: (kibbleNutrients?.protein_g || 0) + (freshTotals?.protein_g || 0),
                fat_g: (kibbleNutrients?.fat_g || 0) + (freshTotals?.fat_g || 0),
                carbs_g: (kibbleNutrients?.carbs_g || 0) + (freshTotals?.carbs_g || 0),
                calcium_mg: (kibbleNutrients?.calcium_mg || 0) + (freshTotals?.calcium_mg || 0),
                phosphorus_mg: (kibbleNutrients?.phosphorus_mg || 0) + (freshTotals?.phosphorus_mg || 0),
                iron_mg: freshTotals?.iron_mg || 0,
                zinc_mg: freshTotals?.zinc_mg || 0,
                vitamin_a_mcg: freshTotals?.vitamin_a_mcg || 0,
                vitamin_d_mcg: freshTotals?.vitamin_d_mcg || 0,
                vitamin_e_mg: freshTotals?.vitamin_e_mg || 0,
            };
        }

        /**
         * Get weight status relative to target
         */
        function getWeightStatus(currentKg, targetKg) {
            if (targetKg === null || targetKg === undefined) {
                return 'no_target';
            }
            const diff = currentKg - targetKg;
            if (Math.abs(diff) < 0.5) {
                return 'at_target';
            } else if (diff > 0) {
                return 'needs_loss';
            } else {
                return 'needs_gain';
            }
        }

        /**
         * Calculate full dog nutrition data (replaces backend /dog/{id} response)
         */
        function calculateDogNutrition(dog) {
            const rer = calculateRER(dog.weight_kg);
            const factor = getActivityFactor(
                dog.neutered,
                dog.age_years,
                dog.target_weight_kg,
                dog.weight_kg
            );
            const mer = calculateMER(dog.weight_kg, factor);
            const effectiveDailyKcal = dog.target_daily_kcal || mer;
            const weightStatus = getWeightStatus(dog.weight_kg, dog.target_weight_kg);

            return {
                ...dog,
                rer: Math.round(rer * 100) / 100,
                mer: Math.round(mer * 100) / 100,
                effective_daily_kcal: Math.round(effectiveDailyKcal * 100) / 100,
                activity_factor: factor,
                weight_status: weightStatus,
            };
        }

        /**
         * Compute feeding plan (replaces /plan/compute endpoint)
         */
        function computeFeedingPlan(dog, recipe, kibbleKcal = 0, treatsKcal = 0) {
            const targetKcal = dog.effective_daily_kcal || dog.mer;
            const homemadeKcal = Math.max(0, targetKcal - kibbleKcal - treatsKcal);

            // Get recipe ingredients with full data
            const ingredients = recipe.ingredients.map(ri => ({
                percentage: ri.percentage,
                kcal_per_100g: ri.kcal_per_100g || 0,
                protein_g_per_100g: ri.protein_g_per_100g || 0,
                fat_g_per_100g: ri.fat_g_per_100g || 0,
                carbs_g_per_100g: ri.carbs_g_per_100g || 0,
                calcium_mg_per_100g: ri.calcium_mg_per_100g || 0,
                phosphorus_mg_per_100g: ri.phosphorus_mg_per_100g || 0,
                iron_mg_per_100g: ri.iron_mg_per_100g || 0,
                zinc_mg_per_100g: ri.zinc_mg_per_100g || 0,
                vitamin_a_mcg_per_100g: ri.vitamin_a_mcg_per_100g || 0,
                vitamin_d_mcg_per_100g: ri.vitamin_d_mcg_per_100g || 0,
                vitamin_e_mg_per_100g: ri.vitamin_e_mg_per_100g || 0,
            }));

            const nutrients = aggregateNutrients(ingredients, homemadeKcal);

            // Check AAFCO compliance
            const status = [];
            const nutrientMap = {
                protein: nutrients.protein_g,
                fat: nutrients.fat_g,
                calcium: nutrients.calcium_mg,
                phosphorus: nutrients.phosphorus_mg,
                iron: nutrients.iron_mg,
                zinc: nutrients.zinc_mg,
                vitamin_a: nutrients.vitamin_a_mcg,
                vitamin_d: nutrients.vitamin_d_mcg,
                vitamin_e: nutrients.vitamin_e_mg,
            };

            for (const [nutrient, amount] of Object.entries(nutrientMap)) {
                const req = AAFCO_REQUIREMENTS[nutrient];
                if (req) {
                    const per1000 = nutrientPer1000kcal(amount, nutrients.kcal);
                    const check = checkAAFCOCompliance(nutrient, per1000, req.min, req.max);
                    status.push(check);
                }
            }

            return {
                target_kcal: targetKcal,
                kibble_kcal: kibbleKcal,
                treats_kcal: treatsKcal,
                homemade_kcal: homemadeKcal,
                nutrients,
                aafco_status: status,
                meals_per_day: recipe.meals_per_day || 2,
            };
        }

        /**
         * Compute full batch meal plan (replaces /plan/compute endpoint)
         */
        async function computeBatchPlan(dogId, recipeId, kibbleKcal = 0, treatsKcal = 0, numDays = 7) {
            // Fetch dog and recipe data
            const dog = await db.getDog(dogId);
            const recipe = await db.getRecipe(recipeId);

            if (!dog || !recipe) {
                throw new Error('Dog or recipe not found');
            }

            const targetKcal = dog.effective_daily_kcal || dog.mer;
            const mealsPerDay = recipe.meals_per_day || 2;
            const totalMeals = numDays * mealsPerDay;

            // Separate ingredients by type
            const foodIngredients = recipe.ingredients.filter(i =>
                !i.ingredient_type || i.ingredient_type === 'food'
            );
            const oilIngredients = recipe.ingredients.filter(i => i.ingredient_type === 'oil');
            const supplementIngredients = recipe.ingredients.filter(i => i.ingredient_type === 'supplement');
            const treatIngredients = recipe.ingredients.filter(i => i.ingredient_type === 'treat');

            // Calculate calories from oils and supplements
            let oilsKcal = 0;
            const oils = oilIngredients.map(ing => {
                const mlPerMeal = ing.serving_size_ml || 5;
                const mlPerDay = mlPerMeal * mealsPerDay;
                const kcalPerMl = ing.kcal_per_ml || (ing.kcal_per_100g / 100);
                const kcalPerDay = mlPerDay * kcalPerMl;
                oilsKcal += kcalPerDay;
                return {
                    ingredient_name: ing.ingredient_name,
                    ml_per_meal: mlPerMeal,
                    tsp_per_meal: mlPerMeal / 5,
                    kcal_per_day: kcalPerDay
                };
            });

            let supplementsKcal = 0;
            const supplements = supplementIngredients.map(ing => {
                const unitsPerDay = ing.units_per_day || 1;
                const kcalFromSupplement = (ing.kcal_per_unit || 0) * unitsPerDay;
                supplementsKcal += kcalFromSupplement;
                return {
                    ingredient_name: ing.ingredient_name,
                    units_per_day: unitsPerDay,
                    kcal_from_supplement: kcalFromSupplement
                };
            });

            const treats = treatIngredients.map(ing => ({
                ingredient_name: ing.ingredient_name,
                units_per_day: ing.units_per_day || 2,
                treat_kcal_budget: treatsKcal
            }));

            // Calculate homemade food calories
            const homemadeKcal = Math.max(0, targetKcal - kibbleKcal - treatsKcal - oilsKcal - supplementsKcal);
            const perMealKcal = homemadeKcal / mealsPerDay;

            // Calculate food ingredient portions
            const totalFoodPercentage = foodIngredients.reduce((sum, i) => sum + i.percentage, 0);

            // Get total kcal/100g for food ingredients
            let totalKcalPer100g = 0;
            foodIngredients.forEach(ing => {
                totalKcalPer100g += (ing.percentage / totalFoodPercentage) * (ing.kcal_per_100g || 0);
            });

            // Calculate total grams needed per day
            const gramsPerDay = totalKcalPer100g > 0 ? (homemadeKcal / totalKcalPer100g) * 100 : 0;
            const gramsPerMeal = gramsPerDay / mealsPerDay;
            const gramsPerContainer = gramsPerMeal;

            // Calculate ingredient portions
            const ingredientPortions = foodIngredients.map(ing => {
                const portionPct = ing.percentage / totalFoodPercentage;
                const gramsPerDayIng = gramsPerDay * portionPct;
                const gramsPerMealIng = gramsPerMeal * portionPct;
                const totalGramsBatch = gramsPerDayIng * numDays;

                return {
                    ingredient_name: ing.ingredient_name,
                    percentage: ing.percentage,
                    category: ing.category || 'other',
                    ingredient_type: ing.ingredient_type || 'food',
                    grams_per_day: gramsPerDayIng,
                    grams_per_meal: gramsPerMealIng,
                    total_grams_batch: totalGramsBatch,
                    kcal_per_100g: ing.kcal_per_100g || 0,
                };
            });

            // Calculate nutrients for AAFCO check
            const nutrients = {
                kcal: 0, protein_g: 0, fat_g: 0, carbs_g: 0,
                calcium_mg: 0, phosphorus_mg: 0, iron_mg: 0, zinc_mg: 0,
                vitamin_a_mcg: 0, vitamin_d_mcg: 0, vitamin_e_mg: 0
            };

            ingredientPortions.forEach(p => {
                const ing = foodIngredients.find(i => i.ingredient_name === p.ingredient_name);
                if (!ing) return;
                const grams = p.grams_per_day;
                nutrients.kcal += calculateNutrientAmount(grams, ing.kcal_per_100g || 0);
                nutrients.protein_g += calculateNutrientAmount(grams, ing.protein_g_per_100g || 0);
                nutrients.fat_g += calculateNutrientAmount(grams, ing.fat_g_per_100g || 0);
                nutrients.carbs_g += calculateNutrientAmount(grams, ing.carbs_g_per_100g || 0);
                nutrients.calcium_mg += calculateNutrientAmount(grams, ing.calcium_mg_per_100g || 0);
                nutrients.phosphorus_mg += calculateNutrientAmount(grams, ing.phosphorus_mg_per_100g || 0);
                nutrients.iron_mg += calculateNutrientAmount(grams, ing.iron_mg_per_100g || 0);
                nutrients.zinc_mg += calculateNutrientAmount(grams, ing.zinc_mg_per_100g || 0);
                nutrients.vitamin_a_mcg += calculateNutrientAmount(grams, ing.vitamin_a_mcg_per_100g || 0);
                nutrients.vitamin_d_mcg += calculateNutrientAmount(grams, ing.vitamin_d_mcg_per_100g || 0);
                nutrients.vitamin_e_mg += calculateNutrientAmount(grams, ing.vitamin_e_mg_per_100g || 0);
            });

            // Check AAFCO compliance
            const warnings = [];
            const nutrientMap = {
                protein: nutrients.protein_g,
                fat: nutrients.fat_g,
                calcium: nutrients.calcium_mg,
                phosphorus: nutrients.phosphorus_mg,
                iron: nutrients.iron_mg,
                zinc: nutrients.zinc_mg,
                vitamin_a: nutrients.vitamin_a_mcg,
                vitamin_d: nutrients.vitamin_d_mcg,
                vitamin_e: nutrients.vitamin_e_mg,
            };

            for (const [nutrient, amount] of Object.entries(nutrientMap)) {
                const req = AAFCO_REQUIREMENTS[nutrient];
                if (req) {
                    const per1000 = nutrientPer1000kcal(amount, nutrients.kcal || homemadeKcal);
                    if (per1000 < req.min) {
                        warnings.push(`${nutrient} is below AAFCO minimum (${per1000.toFixed(1)} vs ${req.min} per 1000 kcal)`);
                    } else if (req.max && per1000 > req.max) {
                        warnings.push(`${nutrient} exceeds AAFCO maximum (${per1000.toFixed(1)} vs ${req.max} per 1000 kcal)`);
                    }
                }
            }

            return {
                dog_name: dog.name,
                recipe_name: recipe.name,
                target_kcal: targetKcal,
                per_meal_kcal: perMealKcal,
                meals_per_day: mealsPerDay,
                num_days: numDays,
                total_meals: totalMeals,
                grams_per_container: gramsPerContainer,
                ingredient_portions: ingredientPortions,
                oils,
                supplements,
                treats,
                calorie_budget: {
                    homemade_food_kcal: homemadeKcal,
                    kibble_kcal: kibbleKcal,
                    oils_kcal: oilsKcal,
                    supplements_kcal: supplementsKcal,
                    treats_kcal: treatsKcal,
                },
                nutrients,
                warnings,
            };
        }

        // ==================== Supabase Auth Configuration ====================
        const SUPABASE_URL = 'https://msazepwvgcmbqnyiarow.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zYXplcHd2Z2NtYnFueWlhcm93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3MjUxNDQsImV4cCI6MjA4NDMwMTE0NH0.LHB3ZICNgTD9s2V-qECbA81ry4hXTAN5DDj7SCXT9JU';

        // Initialize Supabase client (if configured)
        let supabaseClient = null;
        let currentUser = null;

        if (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Check for existing session on load
            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    currentUser = session.user;
                    updateAuthUI(session.user);
                }
            });

            // Listen for auth changes
            supabaseClient.auth.onAuthStateChange((event, session) => {
                currentUser = session?.user || null;
                updateAuthUI(session?.user);

                if (event === 'SIGNED_IN') {
                    showToast('Signed in successfully!', 'success');
                    closeAuthModal();
                    loadAllData(); // Reload data for signed-in user
                } else if (event === 'SIGNED_OUT') {
                    showToast('Signed out', 'info');
                    loadAllData(); // Reload data for anonymous user
                }
            });
        }

        // Auth UI State
        let authMode = 'signin'; // 'signin' or 'signup'

        function updateAuthUI(user) {
            const authBtn = document.getElementById('auth-btn');
            const userMenu = document.getElementById('user-menu');
            const userEmailDisplay = document.getElementById('user-email-display');
            const userAvatarDisplay = document.getElementById('user-avatar-display');
            const userAvatarFallback = document.getElementById('user-avatar-fallback');

            if (user) {
                authBtn.style.display = 'none';
                userMenu.style.display = 'block';

                // Show display name or email
                const displayName = user.user_metadata?.display_name || user.email?.split('@')[0] || 'User';
                userEmailDisplay.textContent = displayName;

                // Show avatar if available
                const avatarUrl = user.user_metadata?.avatar_url;
                if (avatarUrl) {
                    userAvatarDisplay.src = avatarUrl;
                    userAvatarDisplay.style.display = 'block';
                    userAvatarFallback.style.display = 'none';
                } else {
                    userAvatarDisplay.style.display = 'none';
                    userAvatarFallback.style.display = 'inline';
                }
            } else {
                authBtn.style.display = 'flex';
                userMenu.style.display = 'none';
            }
        }

        function showAuthModal() {
            if (!supabaseClient) {
                showToast('Auth not configured. Set SUPABASE_URL and SUPABASE_ANON_KEY in localStorage for testing.', 'error');
                return;
            }
            document.getElementById('auth-modal').classList.add('active');
            document.getElementById('auth-email').focus();
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.remove('active');
            document.getElementById('auth-form').reset();
            document.getElementById('auth-error').style.display = 'none';
            // Reset forgot password state
            document.getElementById('auth-form').style.display = 'block';
            document.getElementById('forgot-password-form').style.display = 'none';
            document.getElementById('forgot-password-form').reset();
            document.getElementById('reset-message').style.display = 'none';
            document.getElementById('auth-tab-signin').style.display = 'block';
            document.getElementById('auth-tab-signup').style.display = 'block';
            setAuthMode('signin');
        }

        function setAuthMode(mode) {
            authMode = mode;

            const subtitle = document.getElementById('auth-modal-subtitle');
            const submitBtn = document.getElementById('auth-submit-btn');
            const signinTab = document.getElementById('auth-tab-signin');
            const signupTab = document.getElementById('auth-tab-signup');
            const forgotLink = document.getElementById('forgot-password-link');

            // Update tabs
            if (authMode === 'signup') {
                signinTab.style.color = 'var(--text-secondary)';
                signinTab.style.fontWeight = '500';
                signinTab.style.borderBottomColor = 'transparent';
                signupTab.style.color = 'var(--primary)';
                signupTab.style.fontWeight = '600';
                signupTab.style.borderBottomColor = 'var(--primary)';
                subtitle.textContent = 'Create an account to save your data to the cloud';
                submitBtn.textContent = 'Create Account';
                forgotLink.style.display = 'none';
            } else {
                signinTab.style.color = 'var(--primary)';
                signinTab.style.fontWeight = '600';
                signinTab.style.borderBottomColor = 'var(--primary)';
                signupTab.style.color = 'var(--text-secondary)';
                signupTab.style.fontWeight = '500';
                signupTab.style.borderBottomColor = 'transparent';
                subtitle.textContent = 'Sign in to sync your data across devices';
                submitBtn.textContent = 'Sign In';
                forgotLink.style.display = 'block';
            }

            document.getElementById('auth-error').style.display = 'none';
        }

        // Keep toggleAuthMode for backwards compatibility
        function toggleAuthMode() {
            setAuthMode(authMode === 'signin' ? 'signup' : 'signin');
        }

        // Password Reset Functions
        function showForgotPassword() {
            document.getElementById('auth-form').style.display = 'none';
            document.getElementById('forgot-password-form').style.display = 'block';
            document.getElementById('auth-modal-subtitle').textContent = 'Enter your email to receive a reset link';
            document.getElementById('auth-tab-signin').style.display = 'none';
            document.getElementById('auth-tab-signup').style.display = 'none';
            document.getElementById('reset-email').focus();
        }

        function hideForgotPassword() {
            document.getElementById('auth-form').style.display = 'block';
            document.getElementById('forgot-password-form').style.display = 'none';
            document.getElementById('reset-message').style.display = 'none';
            document.getElementById('auth-tab-signin').style.display = 'block';
            document.getElementById('auth-tab-signup').style.display = 'block';
            setAuthMode('signin');
        }

        async function handlePasswordReset(event) {
            event.preventDefault();

            if (!supabaseClient) {
                showToast('Auth not configured', 'error');
                return;
            }

            const email = document.getElementById('reset-email').value;
            const messageDiv = document.getElementById('reset-message');
            const submitBtn = document.getElementById('reset-submit-btn');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            try {
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin
                });

                if (error) {
                    messageDiv.textContent = error.message;
                    messageDiv.style.color = 'var(--danger)';
                    messageDiv.style.background = 'rgba(217, 137, 108, 0.1)';
                } else {
                    messageDiv.textContent = 'Check your email for a password reset link!';
                    messageDiv.style.color = 'var(--success)';
                    messageDiv.style.background = 'rgba(123, 174, 142, 0.1)';
                }
                messageDiv.style.display = 'block';
            } catch (err) {
                messageDiv.textContent = 'An error occurred. Please try again.';
                messageDiv.style.color = 'var(--danger)';
                messageDiv.style.background = 'rgba(217, 137, 108, 0.1)';
                messageDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Send Reset Link';
            }
        }

        // Profile Modal Functions
        function showProfileModal() {
            if (!currentUser) {
                showToast('Please sign in first', 'error');
                return;
            }

            // Populate form with current data
            document.getElementById('profile-email').value = currentUser.email || '';
            document.getElementById('profile-name').value = currentUser.user_metadata?.display_name || '';
            document.getElementById('profile-avatar').value = currentUser.user_metadata?.avatar_url || '';

            // Show avatar preview if exists
            const avatarUrl = currentUser.user_metadata?.avatar_url;
            const previewImg = document.getElementById('avatar-preview-img');
            if (avatarUrl) {
                previewImg.src = avatarUrl;
                previewImg.style.display = 'block';
            } else {
                previewImg.style.display = 'none';
            }

            // Close user dropdown
            document.getElementById('user-dropdown').style.display = 'none';

            // Show modal
            document.getElementById('profile-modal').classList.add('active');
            document.getElementById('profile-name').focus();
        }

        function closeProfileModal() {
            document.getElementById('profile-modal').classList.remove('active');
            document.getElementById('profile-message').style.display = 'none';
        }

        // Update avatar preview when URL changes
        document.getElementById('profile-avatar')?.addEventListener('input', function(e) {
            const previewImg = document.getElementById('avatar-preview-img');
            if (e.target.value) {
                previewImg.src = e.target.value;
                previewImg.style.display = 'block';
                previewImg.onerror = () => { previewImg.style.display = 'none'; };
            } else {
                previewImg.style.display = 'none';
            }
        });

        async function updateProfile(event) {
            event.preventDefault();

            if (!supabaseClient || !currentUser) {
                showToast('Not signed in', 'error');
                return;
            }

            const displayName = document.getElementById('profile-name').value.trim();
            const avatarUrl = document.getElementById('profile-avatar').value.trim();
            const messageDiv = document.getElementById('profile-message');
            const submitBtn = document.getElementById('profile-submit-btn');

            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                const { data, error } = await supabaseClient.auth.updateUser({
                    data: {
                        display_name: displayName,
                        avatar_url: avatarUrl
                    }
                });

                if (error) {
                    messageDiv.textContent = error.message;
                    messageDiv.style.color = 'var(--danger)';
                    messageDiv.style.background = 'rgba(217, 137, 108, 0.1)';
                    messageDiv.style.display = 'block';
                } else {
                    messageDiv.textContent = 'Profile updated successfully!';
                    messageDiv.style.color = 'var(--success)';
                    messageDiv.style.background = 'rgba(123, 174, 142, 0.1)';
                    messageDiv.style.display = 'block';

                    // Update current user and UI
                    currentUser = data.user;
                    updateAuthUI(data.user);

                    // Close modal after a brief delay
                    setTimeout(() => {
                        closeProfileModal();
                        showToast('Profile updated!', 'success');
                    }, 1000);
                }
            } catch (err) {
                messageDiv.textContent = 'An error occurred. Please try again.';
                messageDiv.style.color = 'var(--danger)';
                messageDiv.style.background = 'rgba(217, 137, 108, 0.1)';
                messageDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
            }
        }

        async function handleAuth(event) {
            event.preventDefault();

            if (!supabaseClient) {
                showToast('Auth not configured', 'error');
                return;
            }

            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const errorDiv = document.getElementById('auth-error');
            const submitBtn = document.getElementById('auth-submit-btn');

            submitBtn.disabled = true;
            submitBtn.textContent = authMode === 'signin' ? 'Signing in...' : 'Creating account...';

            try {
                let result;
                if (authMode === 'signin') {
                    result = await supabaseClient.auth.signInWithPassword({ email, password });
                } else {
                    result = await supabaseClient.auth.signUp({ email, password });
                }

                if (result.error) {
                    errorDiv.textContent = result.error.message;
                    errorDiv.style.display = 'block';
                } else if (authMode === 'signup' && !result.data.session) {
                    // Email confirmation required
                    errorDiv.textContent = 'Check your email for a confirmation link!';
                    errorDiv.style.display = 'block';
                    errorDiv.style.color = 'var(--success)';
                    errorDiv.style.background = 'rgba(123, 174, 142, 0.1)';
                }
            } catch (err) {
                errorDiv.textContent = 'An error occurred. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = authMode === 'signin' ? 'Sign In' : 'Create Account';
            }
        }

        async function signOut() {
            if (!supabaseClient) return;
            await supabaseClient.auth.signOut();
            document.getElementById('user-dropdown').style.display = 'none';
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        }

        // Close user dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const userMenu = document.getElementById('user-menu');
            if (userMenu && !userMenu.contains(e.target)) {
                document.getElementById('user-dropdown').style.display = 'none';
            }
        });

        // Get auth token for API requests
        async function getAuthToken() {
            if (!supabase || !currentUser) return null;
            const { data: { session } } = await supabaseClient.auth.getSession();
            return session?.access_token || null;
        }

        // Helper to make authenticated API requests (legacy - kept for USDA API calls)
        async function fetchWithAuth(url, options = {}) {
            const token = await getAuthToken();
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            return fetch(url, { ...options, headers });
        }

        // ==================== Supabase Database Operations ====================
        // Direct database calls replacing FastAPI backend

        const db = {
            // ===== DOGS =====
            async listDogs() {
                if (!supabaseClient) return [];
                const { data, error } = await supabaseClient
                    .from('dogs')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (error) { console.error('Error loading dogs:', error); return []; }
                return data || [];
            },

            async getDog(id) {
                if (!supabaseClient) return null;
                const { data, error } = await supabaseClient
                    .from('dogs')
                    .select('*')
                    .eq('id', id)
                    .single();
                if (error) { console.error('Error loading dog:', error); return null; }
                // Add calculated fields
                return data ? calculateDogNutrition(data) : null;
            },

            async createDog(dogData) {
                if (!supabaseClient) throw new Error('Database not configured');
                const { data, error } = await supabaseClient
                    .from('dogs')
                    .insert([{
                        user_id: currentUser?.id || null,
                        name: dogData.name,
                        breed: dogData.breed || null,
                        age_years: dogData.age_years,
                        sex: dogData.sex,
                        neutered: dogData.neutered,
                        weight_kg: dogData.weight_kg,
                        target_weight_kg: dogData.target_weight_kg || null,
                        target_daily_kcal: dogData.target_daily_kcal || null,
                        activity_level: dogData.activity_level || 'moderate',
                        life_stage: dogData.life_stage || 'adult',
                        notes: dogData.notes || null,
                    }])
                    .select()
                    .single();
                if (error) throw error;

                // Create initial weight log
                if (data) {
                    await supabaseClient.from('weight_logs').insert([{
                        dog_id: data.id,
                        weight_kg: dogData.weight_kg,
                        notes: 'Initial weight'
                    }]);
                }
                return data;
            },

            async updateDog(id, updates) {
                if (!supabaseClient) throw new Error('Database not configured');
                const oldDog = await this.getDog(id);
                const { data, error } = await supabaseClient
                    .from('dogs')
                    .update(updates)
                    .eq('id', id)
                    .select()
                    .single();
                if (error) throw error;

                // Log weight change if applicable
                if (updates.weight_kg && oldDog && updates.weight_kg !== oldDog.weight_kg) {
                    await supabaseClient.from('weight_logs').insert([{
                        dog_id: id,
                        weight_kg: updates.weight_kg,
                        notes: 'Weight updated'
                    }]);
                }
                return data;
            },

            async deleteDog(id) {
                if (!supabaseClient) throw new Error('Database not configured');
                const { error } = await supabaseClient
                    .from('dogs')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                return true;
            },

            // ===== INGREDIENTS =====
            async listIngredients() {
                if (!supabaseClient) return [];
                const { data, error } = await supabaseClient
                    .from('ingredients')
                    .select('*')
                    .order('name');
                if (error) { console.error('Error loading ingredients:', error); return []; }
                return data || [];
            },

            async getIngredient(id) {
                if (!supabaseClient) return null;
                const { data, error } = await supabaseClient
                    .from('ingredients')
                    .select('*')
                    .eq('id', id)
                    .single();
                if (error) { console.error('Error loading ingredient:', error); return null; }
                return data;
            },

            async searchIngredients(query) {
                if (!supabaseClient) return [];
                const { data, error } = await supabaseClient
                    .from('ingredients')
                    .select('*')
                    .ilike('name', `%${query}%`)
                    .limit(20);
                if (error) { console.error('Error searching ingredients:', error); return []; }
                return data || [];
            },

            async createIngredient(ingredientData) {
                if (!supabaseClient) throw new Error('Database not configured');
                const { data, error } = await supabaseClient
                    .from('ingredients')
                    .insert([{
                        user_id: currentUser?.id || null,
                        name: ingredientData.name,
                        source_type: ingredientData.source_type || 'USER',
                        source_id: ingredientData.source_id || null,
                        ingredient_type: ingredientData.ingredient_type || 'food',
                        category: ingredientData.category || 'other',
                        kcal_per_100g: ingredientData.kcal_per_100g || 0,
                        protein_g_per_100g: ingredientData.protein_g_per_100g || 0,
                        fat_g_per_100g: ingredientData.fat_g_per_100g || 0,
                        carbs_g_per_100g: ingredientData.carbs_g_per_100g || 0,
                        calcium_mg_per_100g: ingredientData.calcium_mg_per_100g || 0,
                        phosphorus_mg_per_100g: ingredientData.phosphorus_mg_per_100g || 0,
                        iron_mg_per_100g: ingredientData.iron_mg_per_100g || 0,
                        zinc_mg_per_100g: ingredientData.zinc_mg_per_100g || 0,
                        vitamin_a_mcg_per_100g: ingredientData.vitamin_a_mcg_per_100g || 0,
                        vitamin_d_mcg_per_100g: ingredientData.vitamin_d_mcg_per_100g || 0,
                        vitamin_e_mg_per_100g: ingredientData.vitamin_e_mg_per_100g || 0,
                    }])
                    .select()
                    .single();
                if (error) throw error;
                return data;
            },

            async updateIngredient(id, updates) {
                if (!supabaseClient) throw new Error('Database not configured');
                const { data, error } = await supabaseClient
                    .from('ingredients')
                    .update(updates)
                    .eq('id', id)
                    .select()
                    .single();
                if (error) throw error;
                return data;
            },

            async deleteIngredient(id) {
                if (!supabaseClient) throw new Error('Database not configured');
                const { error } = await supabaseClient
                    .from('ingredients')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                return true;
            },

            // ===== RECIPES =====
            async listRecipes() {
                if (!supabaseClient) return [];
                const { data, error } = await supabaseClient
                    .from('recipes')
                    .select('*')
                    .order('id', { ascending: false });
                if (error) { console.error('Error loading recipes:', error); return []; }
                return data || [];
            },

            async getRecipe(id) {
                if (!supabaseClient) return null;
                // Get recipe with its ingredients
                const { data: recipe, error: recipeError } = await supabaseClient
                    .from('recipes')
                    .select('*')
                    .eq('id', id)
                    .single();
                if (recipeError) { console.error('Error loading recipe:', recipeError); return null; }
                if (!recipe) return null;

                // Get recipe ingredients with full ingredient data
                const { data: recipeIngredients, error: riError } = await supabaseClient
                    .from('recipe_ingredients')
                    .select(`
                        id,
                        percentage,
                        ingredient_id,
                        ingredients (
                            id,
                            name,
                            kcal_per_100g,
                            protein_g_per_100g,
                            fat_g_per_100g,
                            carbs_g_per_100g,
                            calcium_mg_per_100g,
                            phosphorus_mg_per_100g,
                            iron_mg_per_100g,
                            zinc_mg_per_100g,
                            vitamin_a_mcg_per_100g,
                            vitamin_d_mcg_per_100g,
                            vitamin_e_mg_per_100g,
                            ingredient_type,
                            category
                        )
                    `)
                    .eq('recipe_id', id);

                if (riError) { console.error('Error loading recipe ingredients:', riError); }

                // Format the response
                recipe.ingredients = (recipeIngredients || []).map(ri => ({
                    id: ri.id,
                    ingredient_id: ri.ingredient_id,
                    ingredient_name: ri.ingredients?.name || '',
                    percentage: ri.percentage,
                    kcal_per_100g: ri.ingredients?.kcal_per_100g || 0,
                    protein_g_per_100g: ri.ingredients?.protein_g_per_100g || 0,
                    fat_g_per_100g: ri.ingredients?.fat_g_per_100g || 0,
                    carbs_g_per_100g: ri.ingredients?.carbs_g_per_100g || 0,
                    calcium_mg_per_100g: ri.ingredients?.calcium_mg_per_100g || 0,
                    phosphorus_mg_per_100g: ri.ingredients?.phosphorus_mg_per_100g || 0,
                    iron_mg_per_100g: ri.ingredients?.iron_mg_per_100g || 0,
                    zinc_mg_per_100g: ri.ingredients?.zinc_mg_per_100g || 0,
                    vitamin_a_mcg_per_100g: ri.ingredients?.vitamin_a_mcg_per_100g || 0,
                    vitamin_d_mcg_per_100g: ri.ingredients?.vitamin_d_mcg_per_100g || 0,
                    vitamin_e_mg_per_100g: ri.ingredients?.vitamin_e_mg_per_100g || 0,
                    ingredient_type: ri.ingredients?.ingredient_type || 'food',
                    category: ri.ingredients?.category || 'other',
                }));

                return recipe;
            },

            async createRecipe(recipeData) {
                if (!supabaseClient) throw new Error('Database not configured');
                const { data, error } = await supabaseClient
                    .from('recipes')
                    .insert([{
                        user_id: currentUser?.id || null,
                        name: recipeData.name,
                        meals_per_day: recipeData.meals_per_day || 2,
                    }])
                    .select()
                    .single();
                if (error) throw error;
                data.ingredients = [];
                return data;
            },

            async updateRecipe(id, updates) {
                if (!supabaseClient) throw new Error('Database not configured');
                const { data, error } = await supabaseClient
                    .from('recipes')
                    .update(updates)
                    .eq('id', id)
                    .select()
                    .single();
                if (error) throw error;
                return data;
            },

            async deleteRecipe(id) {
                if (!supabaseClient) throw new Error('Database not configured');
                // Delete recipe ingredients first
                await supabaseClient.from('recipe_ingredients').delete().eq('recipe_id', id);
                const { error } = await supabaseClient
                    .from('recipes')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                return true;
            },

            async addIngredientToRecipe(recipeId, ingredientId, percentage) {
                if (!supabaseClient) throw new Error('Database not configured');
                // Check if already exists
                const { data: existing } = await supabaseClient
                    .from('recipe_ingredients')
                    .select('id')
                    .eq('recipe_id', recipeId)
                    .eq('ingredient_id', ingredientId)
                    .single();

                if (existing) {
                    // Update percentage
                    await supabaseClient
                        .from('recipe_ingredients')
                        .update({ percentage })
                        .eq('id', existing.id);
                } else {
                    // Insert new
                    await supabaseClient
                        .from('recipe_ingredients')
                        .insert([{ recipe_id: recipeId, ingredient_id: ingredientId, percentage }]);
                }
                return this.getRecipe(recipeId);
            },

            async removeIngredientFromRecipe(recipeId, ingredientId) {
                if (!supabaseClient) throw new Error('Database not configured');
                await supabaseClient
                    .from('recipe_ingredients')
                    .delete()
                    .eq('recipe_id', recipeId)
                    .eq('ingredient_id', ingredientId);
                return this.getRecipe(recipeId);
            },

            // ===== FEEDING LOGS =====
            async listFeedingLogs(dogId, limit = 10) {
                if (!supabaseClient) return [];
                const { data, error } = await supabaseClient
                    .from('feeding_logs')
                    .select('*, recipes(name)')
                    .eq('dog_id', dogId)
                    .order('logged_at', { ascending: false })
                    .limit(limit);
                if (error) { console.error('Error loading feeding logs:', error); return []; }
                return data || [];
            },

            async getTodayFeedingLogs(dogId) {
                if (!supabaseClient) return [];
                const today = new Date().toISOString().split('T')[0];
                const { data, error } = await supabaseClient
                    .from('feeding_logs')
                    .select('*, recipes(name)')
                    .eq('dog_id', dogId)
                    .gte('logged_at', today)
                    .order('logged_at', { ascending: false });
                if (error) { console.error('Error loading today logs:', error); return []; }
                return data || [];
            },

            async createFeedingLog(logData) {
                if (!supabaseClient) throw new Error('Database not configured');
                const { data, error } = await supabaseClient
                    .from('feeding_logs')
                    .insert([{
                        dog_id: logData.dog_id,
                        recipe_id: logData.recipe_id || null,
                        meal_type: logData.meal_type || null,
                        kcal_fed: logData.kcal_fed,
                        notes: logData.notes || null,
                    }])
                    .select()
                    .single();
                if (error) throw error;
                return data;
            },

            async deleteFeedingLog(id) {
                if (!supabaseClient) throw new Error('Database not configured');
                const { error } = await supabaseClient
                    .from('feeding_logs')
                    .delete()
                    .eq('id', id);
                if (error) throw error;
                return true;
            },

            async getTodaySummary(dogId) {
                const logs = await this.getTodayFeedingLogs(dogId);
                const totalKcal = logs.reduce((sum, log) => sum + (log.kcal_fed || 0), 0);
                return {
                    total_kcal_today: totalKcal,
                    meal_count: logs.length,
                    meals: logs,
                };
            },

            // ===== WEIGHT LOGS =====
            async listWeightLogs(dogId, limit = 10) {
                if (!supabaseClient) return [];
                const { data, error } = await supabaseClient
                    .from('weight_logs')
                    .select('*')
                    .eq('dog_id', dogId)
                    .order('logged_at', { ascending: false })
                    .limit(limit);
                if (error) { console.error('Error loading weight logs:', error); return []; }
                return data || [];
            },

            async createWeightLog(logData) {
                if (!supabaseClient) throw new Error('Database not configured');
                const { data, error } = await supabaseClient
                    .from('weight_logs')
                    .insert([{
                        dog_id: logData.dog_id,
                        weight_kg: logData.weight_kg,
                        notes: logData.notes || null,
                    }])
                    .select()
                    .single();
                if (error) throw error;

                // Update dog's current weight
                await this.updateDog(logData.dog_id, { weight_kg: logData.weight_kg });

                return data;
            },

            // ===== FEEDING PLANS =====
            async getFeedingPlan(dogId) {
                if (!supabaseClient) return null;
                const { data, error } = await supabaseClient
                    .from('feeding_plans')
                    .select('*, recipes(*)')
                    .eq('dog_id', dogId)
                    .single();
                if (error && error.code !== 'PGRST116') { // PGRST116 = no rows
                    console.error('Error loading feeding plan:', error);
                }
                return data || null;
            },

            async saveFeedingPlan(planData) {
                if (!supabaseClient) throw new Error('Database not configured');
                // Check if plan exists
                const existing = await this.getFeedingPlan(planData.dog_id);
                if (existing) {
                    const { data, error } = await supabaseClient
                        .from('feeding_plans')
                        .update({
                            recipe_id: planData.recipe_id,
                            kibble_kcal: planData.kibble_kcal || 0,
                            treats_kcal: planData.treats_kcal || 0,
                            homemade_kcal: planData.homemade_kcal || 0,
                            target_kcal: planData.target_kcal,
                        })
                        .eq('dog_id', planData.dog_id)
                        .select()
                        .single();
                    if (error) throw error;
                    return data;
                } else {
                    const { data, error } = await supabaseClient
                        .from('feeding_plans')
                        .insert([{
                            dog_id: planData.dog_id,
                            recipe_id: planData.recipe_id,
                            kibble_kcal: planData.kibble_kcal || 0,
                            treats_kcal: planData.treats_kcal || 0,
                            homemade_kcal: planData.homemade_kcal || 0,
                            target_kcal: planData.target_kcal,
                        }])
                        .select()
                        .single();
                    if (error) throw error;
                    return data;
                }
            },
        };

        // Weight unit state
        let currentWeightUnit = localStorage.getItem('weightUnit') || 'kg';
        const KG_TO_LBS = 2.20462;
        const LBS_TO_KG = 0.453592;

        // Weight conversion functions
        function kgToLbs(kg) { return Math.round(kg * KG_TO_LBS * 100) / 100; }
        function lbsToKg(lbs) { return Math.round(lbs * LBS_TO_KG * 100) / 100; }
        function displayWeight(kg) {
            if (currentWeightUnit === 'lbs') {
                return `${kgToLbs(kg).toFixed(1)} lbs`;
            }
            return `${kg.toFixed(1)} kg`;
        }
        function inputToKg(value) {
            if (currentWeightUnit === 'lbs') {
                return lbsToKg(value);
            }
            return value;
        }
        function kgToInput(kg) {
            if (currentWeightUnit === 'lbs') {
                return kgToLbs(kg);
            }
            return kg;
        }

        // Set weight unit
        function setWeightUnit(unit) {
            currentWeightUnit = unit;
            localStorage.setItem('weightUnit', unit);
            document.querySelectorAll('.unit-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.unit === unit);
            });
            document.querySelectorAll('.weight-unit-label').forEach(el => {
                el.textContent = unit;
            });
            // Reload displays
            loadDogs();
        }

        // Initialize unit toggle
        function initWeightUnit() {
            document.querySelectorAll('.unit-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.unit === currentWeightUnit);
            });
            document.querySelectorAll('.weight-unit-label').forEach(el => {
                el.textContent = currentWeightUnit;
            });
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Upgrade modal functions
        function showUpgradeModal() {
            document.getElementById('upgrade-modal').classList.add('active');
        }

        function closeUpgradeModal() {
            document.getElementById('upgrade-modal').classList.remove('active');
        }

        // ===== ONBOARDING WIZARD =====
        let onboardingDogId = null;
        let onboardingRecipeId = null;

        function checkOnboarding() {
            const completed = localStorage.getItem('onboardingComplete');
            if (!completed) {
                showOnboarding();
            }
        }

        function showOnboarding() {
            document.getElementById('onboarding-modal').classList.add('active');
        }

        function hideOnboarding() {
            document.getElementById('onboarding-modal').classList.remove('active');
        }

        function nextOnboardStep(step) {
            updateOnboardStep(step);
        }

        function prevOnboardStep(step) {
            updateOnboardStep(step);
        }

        function updateOnboardStep(step) {
            // Hide all steps
            document.querySelectorAll('.onboard-step').forEach(s => {
                s.style.display = 'none';
                s.classList.remove('active');
            });

            // Show target step
            const targetStep = document.getElementById(`onboard-step-${step}`);
            if (targetStep) {
                targetStep.style.display = 'block';
                targetStep.classList.add('active');
            }

            // Update dots
            document.querySelectorAll('.onboard-dot').forEach(dot => {
                const dotStep = parseInt(dot.dataset.step);
                dot.classList.remove('active', 'completed');
                if (dotStep === step) {
                    dot.classList.add('active');
                } else if (dotStep < step) {
                    dot.classList.add('completed');
                }
            });
        }

        function skipToStep4() {
            updateOnboardStep(4);
            updateOnboardingDisplay();
        }

        async function updateOnboardingDisplay() {
            if (onboardingDogId) {
                try {
                    const dog = await db.getDog(onboardingDogId);
                    if (dog) {
                        document.getElementById('onboard-dog-display').textContent = dog.name;
                        document.getElementById('onboard-target-kcal').textContent = `${Math.round(dog.mer || 0)} kcal`;
                    }
                } catch (err) {
                    console.error('Error fetching dog for display:', err);
                }
            }
        }

        function finishOnboarding() {
            localStorage.setItem('onboardingComplete', 'true');
            if (onboardingDogId) {
                localStorage.setItem('selectedDogId', onboardingDogId);
                selectedHomeDogId = onboardingDogId;
            }
            hideOnboarding();
            loadHomeDashboard();
            showToast('Welcome to Fresh Pup!', 'success');
        }

        // Onboarding dog form
        document.addEventListener('DOMContentLoaded', function() {
            const onboardDogForm = document.getElementById('onboard-dog-form');
            if (onboardDogForm) {
                onboardDogForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const dogData = {
                        name: document.getElementById('onboard-dog-name').value,
                        weight_kg: inputToKg(parseFloat(document.getElementById('onboard-dog-weight').value)),
                        age_years: parseFloat(document.getElementById('onboard-dog-age').value),
                        activity_level: document.getElementById('onboard-dog-activity').value,
                        life_stage: 'adult'
                    };

                    try {
                        const dog = await db.createDog({
                            ...dogData,
                            sex: 'male',
                            neutered: true
                        });
                        onboardingDogId = dog.id;
                        nextOnboardStep(3);
                    } catch (err) {
                        showToast('Error adding dog', 'error');
                    }
                });
            }

            // Onboarding recipe form
            const onboardRecipeForm = document.getElementById('onboard-recipe-form');
            if (onboardRecipeForm) {
                onboardRecipeForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const recipeData = {
                        name: document.getElementById('onboard-recipe-name').value,
                        meals_per_day: parseInt(document.getElementById('onboard-recipe-meals').value)
                    };

                    try {
                        const recipe = await db.createRecipe(recipeData);
                        onboardingRecipeId = recipe.id;
                        nextOnboardStep(4);
                        updateOnboardingDisplay();
                    } catch (err) {
                        showToast('Error creating recipe', 'error');
                    }
                });
            }

            // Check if onboarding needed
            setTimeout(checkOnboarding, 500);
        });

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // ===== TIER MANAGEMENT =====
        let userTier = localStorage.getItem('userTier') || 'FREE';
        const isPro = () => userTier === 'PRO';
        let allDogs = [];
        let allRecipes = [];
        let selectedHomeDogId = localStorage.getItem('selectedDogId') || null;

        function canAddDog() {
            if (isPro()) return true;
            return allDogs.length < 1;
        }

        function canAddRecipe() {
            if (isPro()) return true;
            return allRecipes.length < 1;
        }

        function updateTierUI() {
            // Update tier badge in settings
            const tierBadge = document.getElementById('current-tier-badge');
            if (tierBadge) {
                tierBadge.textContent = userTier;
                tierBadge.className = 'status-badge ' + (isPro() ? 'excellent' : 'caution');
            }

            // Show/hide PRO gate on History tab
            const historyGate = document.getElementById('history-pro-gate');
            const historyContent = document.getElementById('history-content');
            if (historyGate && historyContent) {
                historyGate.style.display = isPro() ? 'none' : 'block';
                historyContent.style.display = isPro() ? 'block' : 'none';
            }

            // Update Add Dog button in Settings
            const addDogBtn = document.getElementById('settings-add-dog-btn');
            if (addDogBtn) {
                const canAdd = canAddDog();
                addDogBtn.disabled = !canAdd;
                if (!canAdd) {
                    addDogBtn.innerHTML = '<span>üîí</span> Add Dog <span class="pro-badge-small">PRO</span>';
                    addDogBtn.title = 'FREE tier limit: 1 dog. Upgrade to PRO for unlimited dogs!';
                } else {
                    addDogBtn.innerHTML = '<span>‚ûï</span> Add Dog';
                    addDogBtn.title = '';
                }
            }

            // Update Create Recipe button
            const createRecipeBtn = document.getElementById('create-recipe-btn');
            if (createRecipeBtn) {
                const canAdd = canAddRecipe();
                createRecipeBtn.disabled = !canAdd;
                if (!canAdd) {
                    createRecipeBtn.innerHTML = 'üîí Create Recipe <span class="pro-badge-small">PRO</span>';
                    createRecipeBtn.title = 'FREE tier limit: 1 recipe. Upgrade to PRO for unlimited recipes!';
                } else {
                    createRecipeBtn.innerHTML = 'Create Recipe';
                    createRecipeBtn.title = '';
                }
            }
        }

        // ===== TAB SWITCHING =====
        function switchTab(tabId) {
            // Remove active from all tabs and panels
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

            // Activate the selected tab
            const tab = document.querySelector(`.nav-tab[data-tab="${tabId}"]`);
            const panel = document.getElementById(tabId);

            if (tab) tab.classList.add('active');
            if (panel) panel.classList.add('active');

            // Load data for specific tabs
            if (tabId === 'home') {
                loadHomeDashboard();
            } else if (tabId === 'recipes') {
                loadRecipes();
                loadIngredients();
            } else if (tabId === 'history' && isPro()) {
                loadHistoryData();
            } else if (tabId === 'settings') {
                loadSettingsDogs();
            }
        }

        // ===== SETTINGS SECTIONS =====
        function toggleSettingsSection(sectionId) {
            const section = document.getElementById(sectionId);
            const header = section.previousElementSibling;
            const icon = header.querySelector('.expand-icon');

            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.textContent = '‚àí';
            } else {
                section.style.display = 'none';
                icon.textContent = '+';
            }
        }

        // ===== HOME TAB =====
        async function loadHomeDashboard() {
            try {
                // Fetch all dogs
                const rawDogs = await db.listDogs();
                allDogs = rawDogs.map(dog => calculateDogNutrition(dog));
                updateTierUI(); // Update UI based on current limits

                const noDogEl = document.getElementById('home-no-dog');
                const dashboardEl = document.getElementById('home-dashboard');

                if (allDogs.length === 0) {
                    noDogEl.style.display = 'block';
                    dashboardEl.style.display = 'none';
                    return;
                }

                noDogEl.style.display = 'none';
                dashboardEl.style.display = 'block';

                // Populate dog selector
                const selector = document.getElementById('home-dog-selector');
                selector.innerHTML = allDogs.map(dog =>
                    `<option value="${dog.id}" ${dog.id == selectedHomeDogId ? 'selected' : ''}>${dog.name}</option>`
                ).join('');

                // If no dog selected, select first one
                if (!selectedHomeDogId || !allDogs.find(d => d.id == selectedHomeDogId)) {
                    selectedHomeDogId = allDogs[0].id;
                    localStorage.setItem('selectedDogId', selectedHomeDogId);
                    selector.value = selectedHomeDogId;
                }

                await loadHomeDogData(selectedHomeDogId);
            } catch (err) {
                console.error('Error loading home dashboard:', err);
            }
        }

        async function selectHomeDog(dogId) {
            selectedHomeDogId = dogId;
            localStorage.setItem('selectedDogId', dogId);
            await loadHomeDogData(dogId);
        }

        async function loadHomeDogData(dogId) {
            try {
                // Get dog details
                const dog = await db.getDog(dogId);
                if (!dog) return;

                // Update profile card
                document.getElementById('home-dog-name').textContent = dog.name;
                document.getElementById('home-dog-details').textContent =
                    `${displayWeight(dog.weight_kg)} ‚Ä¢ ${dog.age_years} years ‚Ä¢ ${dog.activity_level} activity`;

                // Get today's summary
                const summary = await db.getTodaySummary(dogId);

                const targetKcal = dog.target_daily_kcal || dog.mer || 0;
                const fedKcal = summary.total_kcal || 0;
                const remaining = targetKcal - fedKcal;
                const percentage = targetKcal > 0 ? Math.min((fedKcal / targetKcal) * 100, 100) : 0;

                document.getElementById('home-calories-fed').textContent = Math.round(fedKcal);
                document.getElementById('home-calories-target').textContent = Math.round(targetKcal);
                document.getElementById('home-calories-remaining').textContent =
                    remaining >= 0 ? `${Math.round(remaining)} kcal remaining` : `${Math.round(Math.abs(remaining))} kcal over target`;

                // Update calorie bar
                const bar = document.getElementById('home-calorie-bar');
                bar.style.width = `${percentage}%`;

                // Update status
                const statusBadge = document.getElementById('home-calorie-status');
                if (percentage < 80) {
                    statusBadge.textContent = 'Under';
                    statusBadge.className = 'status-badge caution';
                    bar.className = 'nutrient-bar-fill caution';
                } else if (percentage <= 110) {
                    statusBadge.textContent = 'On Track';
                    statusBadge.className = 'status-badge excellent';
                    bar.className = 'nutrient-bar-fill excellent';
                } else {
                    statusBadge.textContent = 'Over';
                    statusBadge.className = 'status-badge bad';
                    bar.className = 'nutrient-bar-fill bad';
                }

                // Update macros
                document.getElementById('home-protein').textContent = Math.round(summary.total_protein_g || 0);
                document.getElementById('home-fat').textContent = Math.round(summary.total_fat_g || 0);
                document.getElementById('home-carbs').textContent = Math.round(summary.total_carbs_g || 0);

                // Load today's meals
                await loadHomeMeals(dogId);
            } catch (err) {
                console.error('Error loading dog data:', err);
            }
        }

        async function loadHomeMeals(dogId) {
            try {
                const meals = await db.getTodayFeedingLogs(dogId);

                const container = document.getElementById('home-meals-list');

                if (!meals || meals.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <span>üçΩÔ∏è</span>
                            <p>No meals logged today</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = meals.map(meal => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                        <div>
                            <span style="font-weight: 600; color: var(--text-primary);">${meal.meal_type}</span>
                            ${meal.notes ? `<span style="color: var(--text-muted); margin-left: 8px;">${meal.notes}</span>` : ''}
                        </div>
                        <span style="color: var(--primary); font-weight: 600;">${meal.kcal} kcal</span>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading meals:', err);
            }
        }

        function openLogMealModal() {
            // Use existing tracking form in a modal or switch to tracking
            // For now, populate the tracking dog selector and show a simple prompt
            if (selectedHomeDogId) {
                const trackingSelect = document.getElementById('tracking-dog-select');
                if (trackingSelect) trackingSelect.value = selectedHomeDogId;
            }
            // Could open a modal here - for now use alert
            showToast('Use the Recipes tab to log meals', 'info');
        }

        // ===== SETTINGS DOGS =====
        async function loadSettingsDogs() {
            try {
                const rawDogs = await db.listDogs();
                allDogs = rawDogs.map(dog => calculateDogNutrition(dog));
                updateTierUI(); // Centralized tier UI updates

                const container = document.getElementById('settings-dogs-list');

                if (allDogs.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px;">
                            <span>üêï</span>
                            <p>No dogs added yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = allDogs.map(dog => `
                    <div class="dog-card glass" style="padding: 16px;">
                        <h4 style="color: var(--text-primary); margin-bottom: 8px;">${dog.name}</h4>
                        <p style="color: var(--text-secondary); font-size: 0.85rem;">${displayWeight(dog.weight_kg)} ‚Ä¢ ${dog.age_years} years</p>
                        <div class="card-actions" style="margin-top: 12px;">
                            <button class="btn btn-sm btn-edit" onclick="editDog(${dog.id})">Edit</button>
                            <button class="btn btn-sm btn-delete" onclick="deleteDog(${dog.id})">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading settings dogs:', err);
            }
        }

        // Settings dog form submission
        document.addEventListener('DOMContentLoaded', function() {
            const settingsDogForm = document.getElementById('settings-dog-form');
            if (settingsDogForm) {
                settingsDogForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    if (!canAddDog()) {
                        showUpgradeModal();
                        showToast('FREE tier limit: 1 dog. Upgrade to PRO for unlimited!', 'caution');
                        return;
                    }

                    const dogData = {
                        name: document.getElementById('settings-dog-name').value,
                        breed: document.getElementById('settings-dog-breed').value || null,
                        weight_kg: inputToKg(parseFloat(document.getElementById('settings-dog-weight').value)),
                        age_years: parseFloat(document.getElementById('settings-dog-age').value),
                        activity_level: document.getElementById('settings-dog-activity').value,
                        life_stage: document.getElementById('settings-dog-life-stage').value
                    };

                    try {
                        await db.createDog(dogData);
                        showToast('Dog added successfully!', 'success');
                        settingsDogForm.reset();
                        loadSettingsDogs();
                        loadHomeDashboard();
                    } catch (err) {
                        showToast('Error adding dog', 'error');
                    }
                });
            }
        });

        // ===== RECIPES SUB-SECTIONS =====
        function switchRecipeSection(sectionId) {
            // Update sub-nav buttons
            document.querySelectorAll('.sub-nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.subsection === sectionId);
            });

            // Hide all subsections
            document.querySelectorAll('.recipe-subsection').forEach(sec => {
                sec.style.display = 'none';
                sec.classList.remove('active');
            });

            // Show selected subsection
            const section = document.getElementById(`sub-${sectionId}`);
            if (section) {
                section.style.display = 'block';
                section.classList.add('active');
            }

            // Check PRO gate for What If
            if (sectionId === 'what-if') {
                const gate = document.getElementById('whatif-pro-gate');
                const content = document.getElementById('whatif-content');
                if (gate && content) {
                    gate.style.display = isPro() ? 'none' : 'block';
                    content.style.display = isPro() ? 'block' : 'none';
                }
            }

            // Load data for specific sections
            if (sectionId === 'ingredients-lib') {
                loadIngredientsForSubsection();
            } else if (sectionId === 'ingredient-guide') {
                loadGuideForSubsection();
            }
        }

        function loadIngredientsForSubsection() {
            // Copy ingredients content to subsection if needed
            const oldIngredients = document.getElementById('ingredients');
            const subIngredients = document.getElementById('sub-ingredients-lib');
            if (oldIngredients && subIngredients && subIngredients.innerHTML.trim() === '') {
                subIngredients.innerHTML = oldIngredients.innerHTML;
            }
        }

        function loadGuideForSubsection() {
            // Copy guide content to subsection if needed
            const oldGuide = document.getElementById('guide');
            const subGuide = document.getElementById('sub-ingredient-guide');
            if (oldGuide && subGuide && subGuide.innerHTML.trim() === '') {
                subGuide.innerHTML = oldGuide.innerHTML;
            }
        }

        // ===== HISTORY TAB =====
        async function loadHistoryData() {
            if (!isPro()) return;

            const dogId = document.getElementById('history-dog-select')?.value;
            if (!dogId) return;

            // Load weight history and meal history
            // This would be similar to existing tracking functions
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ'}</span> ${message}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Tab switching - use new switchTab function
        document.querySelectorAll('.nav-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                switchTab(btn.dataset.tab);
            });
        });

        // Initial load
        initWeightUnit();
        updateTierUI();
        loadHomeDashboard(); // Start on Home tab
        loadRecipes();
        loadIngredients();

        // Dog form
        document.getElementById('dog-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;

            const weightInput = parseFloat(document.getElementById('dog-weight').value);
            const targetWeightInput = document.getElementById('dog-target-weight').value;
            const targetKcalInput = document.getElementById('dog-target-kcal').value;

            const data = {
                name: document.getElementById('dog-name').value,
                breed: document.getElementById('dog-breed').value || null,
                weight_kg: inputToKg(weightInput),
                target_weight_kg: targetWeightInput ? inputToKg(parseFloat(targetWeightInput)) : null,
                target_daily_kcal: targetKcalInput ? parseFloat(targetKcalInput) : null,
                age_years: parseFloat(document.getElementById('dog-age').value),
                life_stage: document.getElementById('dog-life-stage').value,
                activity_level: document.getElementById('dog-activity').value,
                neutered: document.getElementById('dog-neutered').value === 'true',
                sex: document.getElementById('dog-sex').value,
                notes: document.getElementById('dog-notes').value || null
            };

            try {
                await db.createDog(data);
                e.target.reset();
                loadDogs();
                showToast(`${data.name} added successfully!`, 'success');
            } catch (err) {
                showToast(err.message || 'Error adding dog', 'error');
            }
            btn.disabled = false;
        });

        async function loadDogs() {
            try {
                const rawDogs = await db.listDogs();
                // Add calculated fields (RER, MER, etc.) to each dog
                const dogs = rawDogs.map(dog => calculateDogNutrition(dog));
                const list = document.getElementById('dogs-list');
                const planSelect = document.getElementById('plan-dog');
                const trackingSelect = document.getElementById('tracking-dog-select');

                if (dogs.length === 0) {
                    list.innerHTML = `<div class="empty-state"><span>üêï</span><p>No dogs added yet. Add your first furry friend above!</p></div>`;
                    planSelect.innerHTML = '<option value="">Add a dog first</option>';
                    trackingSelect.innerHTML = '<option value="">Add a dog first</option>';
                    return;
                }

                list.innerHTML = dogs.map(dog => {
                    const breedInfo = dog.breed ? ` ¬∑ ${dog.breed}` : '';
                    const targetInfo = dog.target_weight_kg ? ` (target: ${displayWeight(dog.target_weight_kg)})` : '';
                    const dailyKcal = dog.target_daily_kcal || dog.mer || '‚Äî';
                    const lifeStageLabel = dog.life_stage ? dog.life_stage.charAt(0).toUpperCase() + dog.life_stage.slice(1) : '';

                    return `
                    <div class="dog-card glass-dark">
                        <div class="dog-header">
                            <div class="dog-avatar">üêï</div>
                            <div class="dog-info">
                                <h3>${dog.name}</h3>
                                <p>${displayWeight(dog.weight_kg)}${targetInfo}${breedInfo}</p>
                                <p style="font-size: 0.85rem; opacity: 0.7;">${dog.age_years} years ¬∑ ${lifeStageLabel} ¬∑ ${dog.activity_level}</p>
                            </div>
                        </div>
                        <div class="dog-stats">
                            <div class="stat-box">
                                <div class="stat-value">${dog.rer?.toFixed(0) || '‚Äî'}</div>
                                <div class="stat-label">RER</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${dog.mer?.toFixed(0) || '‚Äî'}</div>
                                <div class="stat-label">MER</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${typeof dailyKcal === 'number' ? dailyKcal.toFixed(0) : dailyKcal}</div>
                                <div class="stat-label">Daily kcal</div>
                            </div>
                        </div>
                        ${dog.notes ? `<p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-divider);">üìù ${dog.notes}</p>` : ''}
                        <div class="card-actions">
                            <button class="btn btn-sm btn-edit" onclick="editDog(${dog.id})">Edit</button>
                            <button class="btn btn-sm btn-delete" onclick="confirmDeleteDog(${dog.id}, '${dog.name}')">Delete</button>
                        </div>
                    </div>
                `}).join('');

                const dogOptions = dogs.map(d => `<option value="${d.id}">${d.name} (${displayWeight(d.weight_kg)})</option>`).join('');
                planSelect.innerHTML = dogOptions;
                trackingSelect.innerHTML = '<option value="">Select a dog...</option>' + dogOptions;
            } catch (err) {
                console.error('Error loading dogs:', err);
            }
        }

        // Edit dog
        async function editDog(dogId) {
            try {
                const dog = await db.getDog(dogId);
                if (!dog) { showToast('Dog not found', 'error'); return; }

                document.getElementById('edit-dog-id').value = dog.id;
                document.getElementById('edit-dog-name').value = dog.name;
                document.getElementById('edit-dog-breed').value = dog.breed || '';
                document.getElementById('edit-dog-weight').value = kgToInput(dog.weight_kg).toFixed(1);
                document.getElementById('edit-dog-target-weight').value = dog.target_weight_kg ? kgToInput(dog.target_weight_kg).toFixed(1) : '';
                document.getElementById('edit-dog-target-kcal').value = dog.target_daily_kcal || '';
                document.getElementById('edit-dog-age').value = dog.age_years;
                document.getElementById('edit-dog-life-stage').value = dog.life_stage || 'adult';
                document.getElementById('edit-dog-activity').value = dog.activity_level;
                document.getElementById('edit-dog-sex').value = dog.sex;
                document.getElementById('edit-dog-neutered').value = dog.neutered.toString();
                document.getElementById('edit-dog-notes').value = dog.notes || '';

                openModal('edit-dog-modal');
            } catch (err) {
                showToast('Error loading dog data', 'error');
            }
        }

        // Edit dog form submit
        document.getElementById('edit-dog-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dogId = document.getElementById('edit-dog-id').value;
            const weightInput = parseFloat(document.getElementById('edit-dog-weight').value);
            const targetWeightInput = document.getElementById('edit-dog-target-weight').value;
            const targetKcalInput = document.getElementById('edit-dog-target-kcal').value;

            const data = {
                name: document.getElementById('edit-dog-name').value,
                breed: document.getElementById('edit-dog-breed').value || null,
                weight_kg: inputToKg(weightInput),
                target_weight_kg: targetWeightInput ? inputToKg(parseFloat(targetWeightInput)) : 0,
                target_daily_kcal: targetKcalInput ? parseFloat(targetKcalInput) : 0,
                age_years: parseFloat(document.getElementById('edit-dog-age').value),
                life_stage: document.getElementById('edit-dog-life-stage').value,
                activity_level: document.getElementById('edit-dog-activity').value,
                sex: document.getElementById('edit-dog-sex').value,
                neutered: document.getElementById('edit-dog-neutered').value === 'true',
                notes: document.getElementById('edit-dog-notes').value || null
            };

            try {
                await db.updateDog(dogId, data);
                closeModal('edit-dog-modal');
                loadDogs();
                showToast('Dog updated successfully!', 'success');
            } catch (err) {
                showToast(err.message || 'Error updating dog', 'error');
            }
        });

        // Delete dog
        function confirmDeleteDog(dogId, dogName) {
            document.getElementById('delete-message').textContent = `Are you sure you want to delete ${dogName}?`;
            document.getElementById('confirm-delete-btn').onclick = () => deleteDog(dogId);
            openModal('confirm-delete-modal');
        }

        async function deleteDog(dogId) {
            try {
                await db.deleteDog(dogId);
                closeModal('confirm-delete-modal');
                loadDogs();
                showToast('Dog deleted successfully!', 'success');
            } catch (err) {
                showToast(err.message || 'Error deleting dog', 'error');
            }
        }

        // USDA API configuration (get your free key at https://fdc.nal.usda.gov/api-key-signup.html)
        const USDA_API_KEY = localStorage.getItem('USDA_API_KEY') || 'DEMO_KEY';
        const USDA_API_BASE = 'https://api.nal.usda.gov/fdc/v1';

        // Ingredient search - directly calls USDA API
        async function searchIngredients() {
            const query = document.getElementById('ingredient-search').value;
            if (!query) return;

            // First search local database
            const results = document.getElementById('search-results');
            results.innerHTML = `<div class="loading"><div class="spinner"></div> Searching...</div>`;

            try {
                // Search local ingredients first
                const localResults = await db.searchIngredients(query);

                // Then search USDA
                const usdaRes = await fetch(`${USDA_API_BASE}/foods/search?api_key=${USDA_API_KEY}&query=${encodeURIComponent(query)}&pageSize=8`);
                const usdaData = await usdaRes.json();

                let html = '';

                // Show local results
                if (localResults.length > 0) {
                    html += `<div style="font-size: 0.9rem; color: var(--text-secondary); padding: 8px 16px; border-bottom: 1px solid var(--border-divider);">Your Ingredients</div>`;
                    html += localResults.slice(0, 4).map(ing => `
                        <div class="search-result" style="background: var(--primary-tint);">
                            <h4>${ing.name}</h4>
                            <p>${ing.kcal_per_100g?.toFixed(0) || 0} kcal/100g ¬∑ Already saved</p>
                        </div>
                    `).join('');
                }

                // Show USDA results
                if (usdaData.foods && usdaData.foods.length > 0) {
                    html += `<div style="font-size: 0.9rem; color: var(--text-secondary); padding: 8px 16px; border-bottom: 1px solid var(--border-divider);">USDA Database</div>`;
                    html += usdaData.foods.slice(0, 8).map(item => {
                        const escapedDesc = item.description.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        return `
                        <div class="search-result" onclick="importFromUSDA('${item.fdcId}', '${escapedDesc}')">
                            <h4>${item.description}</h4>
                            <p>USDA ${item.dataType || 'Food'} ¬∑ Click to import</p>
                        </div>
                    `}).join('');
                }

                if (!html) {
                    html = `<div class="empty-state" style="padding: 20px;"><p>No results found. Try a different search term.</p></div>`;
                }

                results.innerHTML = html;
            } catch (err) {
                console.error('Search error:', err);
                results.innerHTML = `<div class="empty-state" style="padding: 20px;"><p>Search failed: ${err.message || 'Unknown error'}</p></div>`;
            }
        }

        // Import from USDA - fetches full nutrient data and saves to Supabase
        async function importFromUSDA(fdcId, name) {
            showToast('Importing ingredient...', 'info');
            try {
                // Fetch full nutrient data from USDA
                const res = await fetch(`${USDA_API_BASE}/food/${fdcId}?api_key=${USDA_API_KEY}`);
                const food = await res.json();

                // Extract nutrients (USDA nutrient IDs)
                const getNutrient = (id) => {
                    const n = food.foodNutrients?.find(fn => fn.nutrient?.id === id || fn.number === id.toString());
                    return n?.amount || 0;
                };

                // Create ingredient in Supabase
                const ingredientData = {
                    name: food.description || name,
                    source_type: 'USDA',
                    source_id: fdcId.toString(),
                    kcal_per_100g: getNutrient(1008), // Energy
                    protein_g_per_100g: getNutrient(1003), // Protein
                    fat_g_per_100g: getNutrient(1004), // Total fat
                    carbs_g_per_100g: getNutrient(1005), // Carbohydrates
                    calcium_mg_per_100g: getNutrient(1087), // Calcium
                    phosphorus_mg_per_100g: getNutrient(1091), // Phosphorus
                    iron_mg_per_100g: getNutrient(1089), // Iron
                    zinc_mg_per_100g: getNutrient(1095), // Zinc
                    vitamin_a_mcg_per_100g: getNutrient(1106), // Vitamin A (RAE)
                    vitamin_d_mcg_per_100g: getNutrient(1114), // Vitamin D
                    vitamin_e_mg_per_100g: getNutrient(1109), // Vitamin E
                };

                await db.createIngredient(ingredientData);
                document.getElementById('search-results').innerHTML = '';
                document.getElementById('ingredient-search').value = '';
                loadIngredients();
                showToast('Ingredient imported!', 'success');
            } catch (err) {
                console.error('Import error:', err);
                showToast('Import failed: ' + (err.message || 'Unknown error'), 'error');
            }
        }

        // Cal to kcal converter
        function convertCalToKcal() {
            const calInput = document.getElementById('cal-input');
            const kcalOutput = document.getElementById('kcal-output');
            const cal = parseFloat(calInput.value) || 0;
            kcalOutput.value = (cal / 1000).toFixed(3);
        }

        // Custom ingredient form - converts total values to per-100g
        document.getElementById('ingredient-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get total values from form
            const totalKcal = parseFloat(document.getElementById('ing-kcal').value) || 0;
            const totalWeight = parseFloat(document.getElementById('ing-weight').value) || 100; // Default to 100g
            const totalProtein = parseFloat(document.getElementById('ing-protein').value) || 0;
            const totalFat = parseFloat(document.getElementById('ing-fat').value) || 0;
            const totalCarbs = parseFloat(document.getElementById('ing-carbs').value) || 0;

            // Convert to per-100g values
            const multiplier = 100 / totalWeight;

            const data = {
                name: document.getElementById('ing-name').value,
                kcal_per_100g: totalKcal * multiplier,
                protein_g_per_100g: totalProtein * multiplier,
                fat_g_per_100g: totalFat * multiplier,
                carbs_g_per_100g: totalCarbs * multiplier,
                source_type: 'USER'
            };

            try {
                await db.createIngredient(data);
                e.target.reset();
                loadIngredients();
                showToast('Ingredient added!', 'success');
            } catch (err) {
                showToast(err.message || 'Error adding ingredient', 'error');
            }
        });

        async function loadIngredients() {
            try {
                const ingredients = await db.listIngredients();
                const list = document.getElementById('ingredients-list');

                // Cache ingredients for checkbox list
                allIngredientsCache = ingredients;

                if (ingredients.length === 0) {
                    list.innerHTML = `<div class="empty-state"><span>ü•©</span><p>No ingredients saved yet. Search USDA or add custom ingredients!</p></div>`;
                    loadRecipeIngredientCheckboxes();
                    return;
                }

                list.innerHTML = ingredients.map(ing => `
                    <div class="ingredient-card glass-dark">
                        <img src="images/ingredients/${encodeURIComponent(ing.name)}.png" alt="${ing.name}" class="ingredient-img" onerror="this.style.display='none'">
                        <div class="ingredient-header">
                            <h3>${ing.name}</h3>
                            <span class="ingredient-badge ${ing.source_type === 'USDA' ? 'badge-usda' : 'badge-user'}">${ing.source_type}</span>
                        </div>
                        <div class="macro-display">
                            <div class="macro-item">
                                <div class="macro-circle kcal">${ing.kcal_per_100g?.toFixed(0) || 0}</div>
                                <div class="macro-label">kcal</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-circle protein">${ing.protein_g_per_100g?.toFixed(0) || 0}g</div>
                                <div class="macro-label">Protein</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-circle fat">${ing.fat_g_per_100g?.toFixed(0) || 0}g</div>
                                <div class="macro-label">Fat</div>
                            </div>
                            <div class="macro-item">
                                <div class="macro-circle carbs">${ing.carbs_g_per_100g?.toFixed(0) || 0}g</div>
                                <div class="macro-label">Carbs</div>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-sm btn-edit" onclick="editIngredient(${ing.id})">Edit</button>
                            <button class="btn btn-sm btn-delete" onclick="confirmDeleteIngredient(${ing.id}, '${ing.name.replace(/'/g, "\\'")}')">Delete</button>
                        </div>
                    </div>
                `).join('');

                // Refresh checkbox list with new ingredients
                loadRecipeIngredientCheckboxes();
            } catch (err) {
                console.error('Error loading ingredients:', err);
            }
        }

        // Edit ingredient
        async function editIngredient(ingredientId) {
            try {
                const ing = await db.getIngredient(ingredientId);
                if (!ing) { showToast('Ingredient not found', 'error'); return; }

                document.getElementById('edit-ingredient-id').value = ing.id;
                document.getElementById('edit-ingredient-name').value = ing.name;
                document.getElementById('edit-ingredient-kcal').value = ing.kcal_per_100g || 0;
                document.getElementById('edit-ingredient-protein').value = ing.protein_g_per_100g || 0;
                document.getElementById('edit-ingredient-fat').value = ing.fat_g_per_100g || 0;
                document.getElementById('edit-ingredient-carbs').value = ing.carbs_g_per_100g || 0;

                openModal('edit-ingredient-modal');
            } catch (err) {
                showToast('Error loading ingredient data', 'error');
            }
        }

        // Edit ingredient form submit
        document.getElementById('edit-ingredient-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const ingredientId = document.getElementById('edit-ingredient-id').value;

            const data = {
                name: document.getElementById('edit-ingredient-name').value,
                kcal_per_100g: parseFloat(document.getElementById('edit-ingredient-kcal').value) || 0,
                protein_g_per_100g: parseFloat(document.getElementById('edit-ingredient-protein').value) || 0,
                fat_g_per_100g: parseFloat(document.getElementById('edit-ingredient-fat').value) || 0,
                carbs_g_per_100g: parseFloat(document.getElementById('edit-ingredient-carbs').value) || 0
            };

            try {
                await db.updateIngredient(ingredientId, data);
                closeModal('edit-ingredient-modal');
                loadIngredients();
                showToast('Ingredient updated successfully!', 'success');
            } catch (err) {
                showToast(err.message || 'Error updating ingredient', 'error');
            }
        });

        // Delete ingredient
        function confirmDeleteIngredient(ingredientId, ingredientName) {
            document.getElementById('delete-message').textContent = `Are you sure you want to delete ${ingredientName}?`;
            document.getElementById('confirm-delete-btn').onclick = () => deleteIngredient(ingredientId);
            openModal('confirm-delete-modal');
        }

        async function deleteIngredient(ingredientId) {
            try {
                await db.deleteIngredient(ingredientId);
                closeModal('confirm-delete-modal');
                loadIngredients();
                showToast('Ingredient deleted successfully!', 'success');
            } catch (err) {
                showToast(err.message || 'Error deleting ingredient', 'error');
            }
        }

        // Recipe form
        document.getElementById('recipe-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Check tier limit
            if (!canAddRecipe()) {
                showUpgradeModal();
                showToast('FREE tier limit: 1 recipe. Upgrade to PRO for unlimited!', 'caution');
                return;
            }

            const data = {
                name: document.getElementById('recipe-name').value,
                meals_per_day: parseInt(document.getElementById('recipe-meals').value)
            };

            try {
                await db.createRecipe(data);
                e.target.reset();
                loadRecipes();
                showToast('Recipe created!', 'success');
            } catch (err) {
                showToast('Error creating recipe', 'error');
            }
        });

        // Store all ingredients globally for checkbox list
        let allIngredientsCache = [];

        async function loadRecipeIngredientCheckboxes() {
            const recipeId = document.getElementById('recipe-select').value;
            const list = document.getElementById('ingredient-checkbox-list');

            if (!recipeId || allIngredientsCache.length === 0) {
                list.innerHTML = `<div class="empty-state"><span>ü•©</span><p>Add ingredients first, then check the ones to include in this recipe</p></div>`;
                return;
            }

            // Get current recipe ingredients to pre-check
            let existingIngredients = [];
            try {
                const recipe = await db.getRecipe(recipeId);
                existingIngredients = recipe?.ingredients || [];
            } catch (err) {
                console.error('Error loading recipe:', err);
            }

            // Create simple checkbox list - NO percentage inputs!
            // The app will auto-calculate optimal portions
            list.innerHTML = allIngredientsCache.map(ing => {
                const existing = existingIngredients.find(ri => ri.ingredient_id === ing.id);
                const isChecked = existing ? 'checked' : '';
                const category = categorizeIngredient(ing.name);
                return `
                    <div class="ingredient-checkbox-item ${isChecked ? 'checked' : ''}" data-id="${ing.id}" data-category="${category}">
                        <input type="checkbox" id="ing-check-${ing.id}" ${isChecked}
                               onchange="toggleIngredientCheck(this, ${ing.id})">
                        <div class="ingredient-checkbox-info">
                            <div class="ingredient-checkbox-name">${ing.name}</div>
                            <div class="ingredient-checkbox-macros">
                                <span class="category-badge category-${category}">${category}</span>
                                ${ing.kcal_per_100g?.toFixed(0) || 0} kcal/100g
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateIngredientCount();
        }

        // Categorize ingredient by name for auto-portioning
        function categorizeIngredient(name) {
            const nameLower = name.toLowerCase();
            const categories = {
                protein: ['beef', 'chicken', 'turkey', 'lamb', 'pork', 'venison', 'bison', 'duck', 'rabbit', 'salmon', 'fish', 'sardine', 'mackerel', 'cod', 'tilapia', 'tuna', 'egg', 'liver', 'heart', 'kidney', 'gizzard', 'meat'],
                carbs: ['rice', 'oatmeal', 'oat', 'quinoa', 'barley', 'millet', 'pasta', 'noodle', 'lentil', 'bean', 'potato', 'sweet potato'],
                veggies: ['broccoli', 'carrot', 'green bean', 'pea', 'pumpkin', 'spinach', 'kale', 'zucchini', 'celery', 'cucumber', 'squash', 'brussels', 'cabbage', 'cauliflower', 'asparagus', 'beet', 'vegetable', 'lettuce', 'greens'],
                fruits: ['blueberr', 'cranberr', 'apple', 'banana', 'watermelon', 'cantaloupe', 'strawberr', 'raspberr', 'blackberr', 'mango', 'pear', 'peach', 'fruit'],
                fats: ['oil', 'coconut', 'flax', 'olive', 'salmon oil', 'fish oil'],
                supplements: ['chia', 'hemp', 'seed', 'turmeric', 'ginger', 'parsley', 'kelp', 'spirulina', 'powder', 'supplement', 'vitamin', 'mineral']
            };

            for (const [category, keywords] of Object.entries(categories)) {
                if (keywords.some(kw => nameLower.includes(kw))) {
                    return category;
                }
            }
            return 'other';
        }

        function updateIngredientCount() {
            const checkedItems = document.querySelectorAll('#ingredient-checkbox-list .ingredient-checkbox-item input[type="checkbox"]:checked');
            const countDisplay = document.getElementById('ingredient-count-display');
            if (countDisplay) {
                const count = checkedItems.length;
                countDisplay.innerHTML = count > 0
                    ? `<span style="color: #10b981;">‚úì ${count} ingredient${count > 1 ? 's' : ''} selected</span>`
                    : '<span style="color: var(--text-muted);">No ingredients selected</span>';
            }
        }

        function toggleIngredientCheck(checkbox, ingredientId) {
            const item = checkbox.closest('.ingredient-checkbox-item');
            if (checkbox.checked) {
                item.classList.add('checked');
            } else {
                item.classList.remove('checked');
            }
            updateIngredientCount();
        }

        function selectAllIngredients() {
            document.querySelectorAll('#ingredient-checkbox-list input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
                cb.closest('.ingredient-checkbox-item')?.classList.add('checked');
            });
            updateIngredientCount();
        }

        function clearAllIngredients() {
            document.querySelectorAll('#ingredient-checkbox-list input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                cb.closest('.ingredient-checkbox-item')?.classList.remove('checked');
            });
            updateIngredientCount();
        }

        // Auto-calculate optimal percentages based on ingredient categories
        function calculateOptimalPercentages(selectedItems) {
            // Standard balanced recipe ratios
            const categoryTargets = {
                protein: 50,      // 50% of recipe should be protein
                carbs: 20,        // 20% carbs/starches
                veggies: 20,      // 20% vegetables
                fruits: 5,        // 5% fruits
                fats: 3,          // 3% oils/fats
                supplements: 2,   // 2% supplements
                other: 0          // will absorb remainder
            };

            // Group selected ingredients by category
            const categorized = {};
            for (const cat of Object.keys(categoryTargets)) {
                categorized[cat] = [];
            }

            selectedItems.forEach(item => {
                const category = item.dataset.category || 'other';
                if (categorized[category]) {
                    categorized[category].push(item);
                } else {
                    categorized.other.push(item);
                }
            });

            // Calculate actual percentages based on what's selected
            const result = [];
            let usedPercentage = 0;

            // First pass: distribute percentages to categories that have items
            const activeCategoryTargets = {};
            for (const [cat, items] of Object.entries(categorized)) {
                if (items.length > 0 && categoryTargets[cat] > 0) {
                    activeCategoryTargets[cat] = categoryTargets[cat];
                }
            }

            // Normalize to 100% based on selected categories
            const totalTarget = Object.values(activeCategoryTargets).reduce((a, b) => a + b, 0);
            const scaleFactor = totalTarget > 0 ? 100 / totalTarget : 1;

            for (const [cat, items] of Object.entries(categorized)) {
                if (items.length === 0) continue;

                let categoryPct = (activeCategoryTargets[cat] || 5) * scaleFactor;

                // Special handling for supplements - cap at 2% each
                if (cat === 'supplements') {
                    categoryPct = Math.min(categoryPct, items.length * 2);
                }

                const perItemPct = categoryPct / items.length;

                items.forEach(item => {
                    result.push({
                        ingredient_id: parseInt(item.dataset.id),
                        percentage: Math.round(perItemPct * 10) / 10 // Round to 1 decimal
                    });
                    usedPercentage += perItemPct;
                });
            }

            // Normalize to exactly 100%
            if (result.length > 0 && Math.abs(usedPercentage - 100) > 0.1) {
                const adjustment = 100 / usedPercentage;
                result.forEach(r => {
                    r.percentage = Math.round(r.percentage * adjustment * 10) / 10;
                });
            }

            return result;
        }

        async function saveRecipeIngredients() {
            const recipeId = document.getElementById('recipe-select').value;
            if (!recipeId) {
                showToast('Please select a recipe first', 'error');
                return;
            }

            // Get all checked ingredients
            const allItems = document.querySelectorAll('#ingredient-checkbox-list .ingredient-checkbox-item');
            const selectedItems = [];

            allItems.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    selectedItems.push(item);
                }
            });

            if (selectedItems.length === 0) {
                showToast('Please check at least one ingredient', 'error');
                return;
            }

            // Auto-calculate optimal percentages based on ingredient categories
            const ingredientsToAdd = calculateOptimalPercentages(selectedItems);

            // First, remove all existing ingredients from recipe
            try {
                const recipe = await db.getRecipe(recipeId);

                // Delete existing ingredients
                for (const ing of recipe?.ingredients || []) {
                    await db.removeIngredientFromRecipe(recipeId, ing.ingredient_id);
                }

                // Add all ingredients with auto-calculated percentages
                for (const ing of ingredientsToAdd) {
                    await db.addIngredientToRecipe(recipeId, ing.ingredient_id, ing.percentage);
                }

                loadRecipes();
                showToast(`Recipe created with ${ingredientsToAdd.length} ingredients! Portions auto-calculated.`, 'success');
            } catch (err) {
                showToast('Error updating recipe ingredients', 'error');
                console.error(err);
            }
        }

        async function loadRecipes() {
            try {
                const recipes = await db.listRecipes();
                allRecipes = recipes; // Update global array for tier checking
                updateTierUI(); // Update UI based on current limits

                const list = document.getElementById('recipes-list');
                const recipeSelect = document.getElementById('recipe-select');
                const planRecipeSelect = document.getElementById('plan-recipe');

                if (recipes.length === 0) {
                    list.innerHTML = `<div class="empty-state"><span>üìã</span><p>No recipes created yet. Create your first recipe above!</p></div>`;
                    recipeSelect.innerHTML = '<option value="">Create a recipe first</option>';
                    planRecipeSelect.innerHTML = '<option value="">Create a recipe first</option>';
                    return;
                }

                const fullRecipes = await Promise.all(
                    recipes.map(r => db.getRecipe(r.id))
                );

                list.innerHTML = fullRecipes.map(recipe => `
                    <div class="recipe-card glass-dark">
                        <div class="recipe-header">
                            <h3>${recipe.name}</h3>
                            <span class="meals-badge">${recipe.meals_per_day} meals/day</span>
                        </div>
                        ${recipe.ingredients && recipe.ingredients.length > 0 ? `
                            <div class="recipe-ingredients">
                                ${recipe.ingredients.map(i => `
                                    <div class="recipe-ingredient-item">
                                        <span>${i.ingredient_name || i.name}</span>
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <strong>${i.percentage}%</strong>
                                            <button class="btn btn-sm btn-delete" style="padding: 4px 8px;" onclick="removeIngredientFromRecipe(${recipe.id}, ${i.ingredient_id})">‚úï</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `<div class="empty-state" style="padding: 20px;"><p>No ingredients yet</p></div>`}
                        <div class="card-actions">
                            <button class="btn btn-sm btn-edit" onclick="editRecipe(${recipe.id})">Edit</button>
                            <button class="btn btn-sm btn-delete" onclick="confirmDeleteRecipe(${recipe.id}, '${recipe.name.replace(/'/g, "\\'")}')">Delete</button>
                        </div>
                    </div>
                `).join('');

                const options = recipes.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
                recipeSelect.innerHTML = options;
                planRecipeSelect.innerHTML = options;

                // Refresh checkbox list when recipes change
                loadRecipeIngredientCheckboxes();
            } catch (err) {
                console.error('Error loading recipes:', err);
            }
        }

        // Remove ingredient from recipe
        async function removeIngredientFromRecipe(recipeId, ingredientId) {
            try {
                await db.removeIngredientFromRecipe(recipeId, ingredientId);
                loadRecipes();
                showToast('Ingredient removed from recipe!', 'success');
            } catch (err) {
                showToast(err.message || 'Error removing ingredient', 'error');
            }
        }

        // Edit recipe
        async function editRecipe(recipeId) {
            try {
                const recipe = await db.getRecipe(recipeId);
                if (!recipe) { showToast('Recipe not found', 'error'); return; }

                document.getElementById('edit-recipe-id').value = recipe.id;
                document.getElementById('edit-recipe-name').value = recipe.name;
                document.getElementById('edit-recipe-meals').value = recipe.meals_per_day;

                openModal('edit-recipe-modal');
            } catch (err) {
                showToast('Error loading recipe data', 'error');
            }
        }

        // Edit recipe form submit
        document.getElementById('edit-recipe-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const recipeId = document.getElementById('edit-recipe-id').value;

            const data = {
                name: document.getElementById('edit-recipe-name').value,
                meals_per_day: parseInt(document.getElementById('edit-recipe-meals').value)
            };

            try {
                await db.updateRecipe(recipeId, data);
                closeModal('edit-recipe-modal');
                loadRecipes();
                showToast('Recipe updated successfully!', 'success');
            } catch (err) {
                showToast(err.message || 'Error updating recipe', 'error');
            }
        });

        // Delete recipe
        function confirmDeleteRecipe(recipeId, recipeName) {
            document.getElementById('delete-message').textContent = `Are you sure you want to delete ${recipeName}?`;
            document.getElementById('confirm-delete-btn').onclick = () => deleteRecipe(recipeId);
            openModal('confirm-delete-modal');
        }

        async function deleteRecipe(recipeId) {
            try {
                await db.deleteRecipe(recipeId);
                closeModal('confirm-delete-modal');
                loadRecipes();
                showToast('Recipe deleted successfully!', 'success');
            } catch (err) {
                showToast(err.message || 'Error deleting recipe', 'error');
            }
        }

        // Feeding plan
        document.getElementById('plan-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dogId = parseInt(document.getElementById('plan-dog').value);
            const recipeId = parseInt(document.getElementById('plan-recipe').value);
            const kibbleKcal = parseFloat(document.getElementById('plan-kibble').value) || 0;
            const treatsKcal = parseFloat(document.getElementById('plan-treats').value) || 0;
            const numDays = parseInt(document.getElementById('plan-days').value) || 7;

            const resultDiv = document.getElementById('plan-result');
            resultDiv.innerHTML = `<div class="loading"><div class="spinner"></div> Calculating optimal feeding plan...</div>`;

            try {
                const plan = await computeBatchPlan(dogId, recipeId, kibbleKcal, treatsKcal, numDays);

                if (plan) {
                    resultDiv.innerHTML = `
                        <div class="plan-header glass-dark">
                            <div class="plan-dog-avatar">üêï</div>
                            <div class="plan-dog-info">
                                <h2>Batch Meal Plan for ${plan.dog_name || 'Your Dog'}</h2>
                                <p>${plan.num_days} day batch using ${plan.recipe_name || 'selected recipe'}</p>
                            </div>
                        </div>

                        <!-- Batch Summary -->
                        <div class="calorie-breakdown">
                            <div class="calorie-card glass-dark highlight">
                                <div class="value">${plan.total_meals || '‚Äî'}</div>
                                <div class="label">Meal Containers</div>
                            </div>
                            <div class="calorie-card glass-dark">
                                <div class="value">${plan.grams_per_container?.toFixed(0) || '‚Äî'}g</div>
                                <div class="label">Per Container</div>
                            </div>
                            <div class="calorie-card glass-dark">
                                <div class="value">${plan.per_meal_kcal?.toFixed(0) || '‚Äî'}</div>
                                <div class="label">kcal/meal</div>
                            </div>
                            <div class="calorie-card glass-dark">
                                <div class="value">${plan.target_kcal?.toFixed(0) || '‚Äî'}</div>
                                <div class="label">kcal/day target</div>
                            </div>
                        </div>

                        <!-- Calorie Budget Summary -->
                        ${plan.calorie_budget ? `
                            <div class="form-card glass-dark" style="margin-bottom: 20px; padding: 20px;">
                                <h3 style="color: var(--text-primary); margin-bottom: 15px;">üìä Daily Calorie Budget</h3>
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 8px; color: var(--text-primary);">
                                    <span>üçñ Homemade Food:</span>
                                    <span style="text-align: right; font-weight: bold;">${plan.calorie_budget.homemade_food_kcal?.toFixed(0)} kcal</span>
                                    ${plan.calorie_budget.kibble_kcal > 0 ? `
                                        <span>ü•£ Kibble:</span>
                                        <span style="text-align: right; font-weight: bold;">${plan.calorie_budget.kibble_kcal?.toFixed(0)} kcal</span>
                                    ` : ''}
                                    ${plan.calorie_budget.oils_kcal > 0 ? `
                                        <span>ü´í Oils (at mealtime):</span>
                                        <span style="text-align: right; font-weight: bold;">${plan.calorie_budget.oils_kcal?.toFixed(0)} kcal</span>
                                    ` : ''}
                                    ${plan.calorie_budget.supplements_kcal > 0 ? `
                                        <span>üíä Supplements:</span>
                                        <span style="text-align: right; font-weight: bold;">${plan.calorie_budget.supplements_kcal?.toFixed(0)} kcal</span>
                                    ` : ''}
                                    ${plan.calorie_budget.treats_kcal > 0 ? `
                                        <span>ü¶¥ Treats:</span>
                                        <span style="text-align: right; font-weight: bold;">${plan.calorie_budget.treats_kcal?.toFixed(0)} kcal</span>
                                    ` : ''}
                                    <div style="grid-column: 1/-1; border-top: 1px solid var(--border-divider); margin: 8px 0;"></div>
                                    <span style="font-weight: bold;">Total:</span>
                                    <span style="text-align: right; font-weight: bold; color: ${plan.calorie_budget.remaining_kcal < 0 ? '#ef4444' : '#10b981'};">${plan.calorie_budget.total_kcal?.toFixed(0)} / ${plan.calorie_budget.target_daily_kcal?.toFixed(0)} kcal</span>
                                    ${plan.calorie_budget.remaining_kcal !== 0 ? `
                                        <span style="color: ${plan.calorie_budget.remaining_kcal < 0 ? '#ef4444' : 'var(--text-secondary)'};">
                                            ${plan.calorie_budget.remaining_kcal > 0 ? 'Remaining:' : 'Over by:'}
                                        </span>
                                        <span style="text-align: right; color: ${plan.calorie_budget.remaining_kcal < 0 ? '#ef4444' : 'var(--text-secondary)'};">
                                            ${Math.abs(plan.calorie_budget.remaining_kcal)?.toFixed(0)} kcal
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Container Instructions -->
                        <div class="form-card glass-dark" style="margin-bottom: 20px; padding: 20px;">
                            <h3 style="color: var(--text-primary); margin-bottom: 15px;">üì¶ How to Prep</h3>
                            <p style="color: var(--text-primary); font-size: 1.1em; margin-bottom: 10px;">
                                <strong>1.</strong> Cook/prep all batch ingredients using the amounts below
                            </p>
                            <p style="color: var(--text-primary); font-size: 1.1em; margin-bottom: 10px;">
                                <strong>2.</strong> Mix everything together thoroughly
                            </p>
                            <p style="color: var(--text-primary); font-size: 1.1em; margin-bottom: 10px;">
                                <strong>3.</strong> Divide into <strong>${plan.total_meals}</strong> containers of <strong>${plan.grams_per_container?.toFixed(0)}g</strong> each
                            </p>
                            <p style="color: var(--text-primary); font-size: 1.1em;">
                                <strong>4.</strong> Feed <strong>${plan.meals_per_day}</strong> container(s) per day (${plan.per_meal_kcal?.toFixed(0)} kcal each)
                            </p>
                            ${plan.oils && plan.oils.length > 0 ? `
                                <p style="color: var(--text-primary); font-size: 1.1em; margin-top: 10px;">
                                    <strong>5.</strong> Add oils at mealtime (see "Given Separately" section)
                                </p>
                            ` : ''}
                        </div>

                        <!-- BATCH Ingredients (FOOD type only) -->
                        ${plan.batch_ingredients && plan.batch_ingredients.length > 0 ? `
                            <div class="portions-section">
                                <h3><span>üõí</span> Batch Ingredients (${plan.num_days} days)</h3>
                                ${plan.batch_ingredients.map(p => `
                                    <div class="portion-item glass-dark">
                                        <span class="name">${p.ingredient_name} <span class="category-badge category-${p.category || 'other'}">${p.category || 'other'}</span></span>
                                        <div class="portion-amounts">
                                            <div class="portion-amount" style="background: rgba(138, 43, 226, 0.3);">
                                                <div class="value">${p.total_grams_batch?.toFixed(0)}g</div>
                                                <div class="label">TOTAL BATCH</div>
                                            </div>
                                            <div class="portion-amount">
                                                <div class="value">${p.grams_per_day?.toFixed(1)}g</div>
                                                <div class="label">per day</div>
                                            </div>
                                            <div class="portion-amount">
                                                <div class="value">${p.grams_per_meal?.toFixed(1)}g</div>
                                                <div class="label">per meal</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : plan.ingredient_portions && plan.ingredient_portions.length > 0 ? `
                            <div class="portions-section">
                                <h3><span>üõí</span> Batch Ingredients (${plan.num_days} days)</h3>
                                ${plan.ingredient_portions.filter(p => p.ingredient_type === 'food' || !p.ingredient_type).map(p => `
                                    <div class="portion-item glass-dark">
                                        <span class="name">${p.ingredient_name}</span>
                                        <div class="portion-amounts">
                                            <div class="portion-amount" style="background: rgba(138, 43, 226, 0.3);">
                                                <div class="value">${p.total_grams_batch?.toFixed(0)}g</div>
                                                <div class="label">TOTAL BATCH</div>
                                            </div>
                                            <div class="portion-amount">
                                                <div class="value">${p.grams_per_day?.toFixed(1)}g</div>
                                                <div class="label">per day</div>
                                            </div>
                                            <div class="portion-amount">
                                                <div class="value">${p.grams_per_meal?.toFixed(1)}g</div>
                                                <div class="label">per meal</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <!-- GIVEN SEPARATELY Section (Oils, Supplements, Treats) -->
                        ${(plan.oils && plan.oils.length > 0) || (plan.supplements && plan.supplements.length > 0) || (plan.treats && plan.treats.length > 0) ? `
                            <div class="portions-section" style="margin-top: 20px;">
                                <h3><span>üîî</span> Given Separately (at mealtime)</h3>

                                ${plan.oils && plan.oils.length > 0 ? `
                                    <div style="margin-bottom: 15px;">
                                        <h4 style="color: var(--text-primary); margin-bottom: 10px;">ü´í Oils</h4>
                                        ${plan.oils.map(o => `
                                            <div class="portion-item glass-dark">
                                                <span class="name">${o.ingredient_name}</span>
                                                <div class="portion-amounts">
                                                    <div class="portion-amount" style="background: rgba(234, 179, 8, 0.3);">
                                                        <div class="value">${o.tsp_per_meal?.toFixed(1)} tsp</div>
                                                        <div class="label">PER MEAL</div>
                                                    </div>
                                                    <div class="portion-amount">
                                                        <div class="value">${o.ml_per_meal?.toFixed(1)}ml</div>
                                                        <div class="label">per meal</div>
                                                    </div>
                                                    <div class="portion-amount">
                                                        <div class="value">${o.kcal_per_day?.toFixed(0)}</div>
                                                        <div class="label">kcal/day</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}

                                ${plan.supplements && plan.supplements.length > 0 ? `
                                    <div style="margin-bottom: 15px;">
                                        <h4 style="color: var(--text-primary); margin-bottom: 10px;">üíä Supplements</h4>
                                        ${plan.supplements.map(s => `
                                            <div class="portion-item glass-dark">
                                                <span class="name">${s.ingredient_name}</span>
                                                <div class="portion-amounts">
                                                    <div class="portion-amount" style="background: rgba(16, 185, 129, 0.3);">
                                                        <div class="value">${s.units_per_day?.toFixed(0)}</div>
                                                        <div class="label">UNITS/DAY</div>
                                                    </div>
                                                    ${s.kcal_from_supplement > 0 ? `
                                                        <div class="portion-amount">
                                                            <div class="value">${s.kcal_from_supplement?.toFixed(0)}</div>
                                                            <div class="label">kcal/day</div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}

                                ${plan.treats && plan.treats.length > 0 ? `
                                    <div>
                                        <h4 style="color: var(--text-primary); margin-bottom: 10px;">ü¶¥ Treats</h4>
                                        ${plan.treats.map(t => `
                                            <div class="portion-item glass-dark">
                                                <span class="name">${t.ingredient_name}</span>
                                                <div class="portion-amounts">
                                                    <div class="portion-amount" style="background: rgba(249, 115, 22, 0.3);">
                                                        <div class="value">${t.units_per_day?.toFixed(0)}</div>
                                                        <div class="label">MAX/DAY</div>
                                                    </div>
                                                    ${t.treat_kcal_budget > 0 ? `
                                                        <div class="portion-amount">
                                                            <div class="value">${t.treat_kcal_budget?.toFixed(0)}</div>
                                                            <div class="label">kcal budget</div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        <!-- Nutrition Summary - Total, Per Day, Per Meal -->
                        ${plan.nutrient_totals ? `
                            <div class="form-card glass-dark" style="margin-top: 20px; padding: 20px;">
                                <h3 style="color: var(--text-primary); margin-bottom: 20px;">üìä Nutrition Breakdown</h3>

                                <!-- Nutrition Table -->
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse; color: var(--text-primary);">
                                        <thead>
                                            <tr style="border-bottom: 2px solid var(--border-divider);">
                                                <th style="text-align: left; padding: 12px 8px; font-weight: 600;">Nutrient</th>
                                                <th style="text-align: center; padding: 12px 8px; font-weight: 600; background: rgba(138, 43, 226, 0.2);">Total (${plan.num_days} days)</th>
                                                <th style="text-align: center; padding: 12px 8px; font-weight: 600; background: rgba(16, 185, 129, 0.2);">Per Day</th>
                                                <th style="text-align: center; padding: 12px 8px; font-weight: 600; background: rgba(234, 179, 8, 0.2);">Per Meal</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="border-bottom: 1px solid var(--border-divider);">
                                                <td style="padding: 10px 8px;">üî• Calories</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(138, 43, 226, 0.1); font-weight: bold;">${(plan.nutrient_totals.kcal * plan.num_days)?.toFixed(0) || (plan.target_kcal * plan.num_days)?.toFixed(0)} kcal</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(16, 185, 129, 0.1); font-weight: bold;">${plan.nutrient_totals.kcal?.toFixed(0) || plan.target_kcal?.toFixed(0)} kcal</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(234, 179, 8, 0.1); font-weight: bold;">${plan.per_meal_kcal?.toFixed(0)} kcal</td>
                                            </tr>
                                            <tr style="border-bottom: 1px solid var(--border-divider);">
                                                <td style="padding: 10px 8px;">ü•© Protein</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(138, 43, 226, 0.1);">${(plan.nutrient_totals.protein_g * plan.num_days)?.toFixed(1)}g</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(16, 185, 129, 0.1);">${plan.nutrient_totals.protein_g?.toFixed(1)}g</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(234, 179, 8, 0.1);">${(plan.nutrient_totals.protein_g / plan.meals_per_day)?.toFixed(1)}g</td>
                                            </tr>
                                            <tr style="border-bottom: 1px solid var(--border-divider);">
                                                <td style="padding: 10px 8px;">üßà Fat</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(138, 43, 226, 0.1);">${(plan.nutrient_totals.fat_g * plan.num_days)?.toFixed(1)}g</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(16, 185, 129, 0.1);">${plan.nutrient_totals.fat_g?.toFixed(1)}g</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(234, 179, 8, 0.1);">${(plan.nutrient_totals.fat_g / plan.meals_per_day)?.toFixed(1)}g</td>
                                            </tr>
                                            <tr style="border-bottom: 1px solid var(--border-divider);">
                                                <td style="padding: 10px 8px;">üçö Carbs</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(138, 43, 226, 0.1);">${(plan.nutrient_totals.carbs_g * plan.num_days)?.toFixed(1)}g</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(16, 185, 129, 0.1);">${plan.nutrient_totals.carbs_g?.toFixed(1)}g</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(234, 179, 8, 0.1);">${(plan.nutrient_totals.carbs_g / plan.meals_per_day)?.toFixed(1)}g</td>
                                            </tr>
                                            <tr style="border-bottom: 1px solid var(--border-divider);">
                                                <td style="padding: 10px 8px;">ü¶¥ Calcium</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(138, 43, 226, 0.1);">${(plan.nutrient_totals.calcium_mg * plan.num_days)?.toFixed(0)}mg</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(16, 185, 129, 0.1);">${plan.nutrient_totals.calcium_mg?.toFixed(0)}mg</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(234, 179, 8, 0.1);">${(plan.nutrient_totals.calcium_mg / plan.meals_per_day)?.toFixed(0)}mg</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 10px 8px;">‚ö° Phosphorus</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(138, 43, 226, 0.1);">${(plan.nutrient_totals.phosphorus_mg * plan.num_days)?.toFixed(0)}mg</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(16, 185, 129, 0.1);">${plan.nutrient_totals.phosphorus_mg?.toFixed(0)}mg</td>
                                                <td style="text-align: center; padding: 10px 8px; background: rgba(234, 179, 8, 0.1);">${(plan.nutrient_totals.phosphorus_mg / plan.meals_per_day)?.toFixed(0)}mg</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Food Pyramid Visualization -->
                        ${plan.batch_ingredients && plan.batch_ingredients.length > 0 ? `
                            <div class="form-card glass-dark" style="margin-top: 20px; padding: 20px;">
                                <h3 style="color: var(--text-primary); margin-bottom: 15px; text-align: center;">üî∫ Recipe Food Pyramid</h3>
                                <div class="food-pyramid">
                                    ${(() => {
                                        // Group by category and calculate percentages
                                        const categoryTotals = {};
                                        let totalGrams = 0;
                                        plan.batch_ingredients.forEach(ing => {
                                            const cat = ing.category || 'other';
                                            categoryTotals[cat] = (categoryTotals[cat] || 0) + (ing.grams_per_day || 0);
                                            totalGrams += ing.grams_per_day || 0;
                                        });

                                        const categoryEmojis = {
                                            protein: 'ü•©',
                                            carbs: 'üçö',
                                            vegetables: 'ü•¶',
                                            fruits: 'üçé',
                                            fats: 'ü´í',
                                            seeds: 'üåª',
                                            supplements: 'üíä',
                                            other: 'üì¶'
                                        };

                                        const categoryLabels = {
                                            protein: 'Protein',
                                            carbs: 'Carbs',
                                            vegetables: 'Vegetables',
                                            fruits: 'Fruits',
                                            fats: 'Fats/Oils',
                                            seeds: 'Seeds',
                                            supplements: 'Supplements',
                                            other: 'Other'
                                        };

                                        // Sort by percentage (largest first)
                                        const sortedCategories = Object.entries(categoryTotals)
                                            .map(([cat, grams]) => ({
                                                category: cat,
                                                grams,
                                                percent: totalGrams > 0 ? (grams / totalGrams * 100) : 0
                                            }))
                                            .filter(c => c.percent > 0)
                                            .sort((a, b) => b.percent - a.percent);

                                        return sortedCategories.map(c => `
                                            <div class="pyramid-level pyramid-${c.category}">
                                                <span class="emoji">${categoryEmojis[c.category] || 'üì¶'}</span>
                                                <span class="label">${categoryLabels[c.category] || c.category}</span>
                                                <span class="percent">${c.percent.toFixed(0)}%</span>
                                            </div>
                                        `).join('');
                                    })()}
                                </div>
                                <p style="color: var(--text-muted); font-size: 0.8em; text-align: center; margin-top: 10px;">
                                    Ideal: 50% protein, 20% carbs, 20% veggies, 5% fruits, 3% fats, 2% supplements
                                </p>
                            </div>
                        ` : ''}

                        ${plan.warnings && plan.warnings.length > 0 ? `
                            <div class="warnings-section has-warnings">
                                <h4>‚ö†Ô∏è AAFCO Warnings</h4>
                                <ul>
                                    ${plan.warnings.map(w => `<li>${w}</li>`).join('')}
                                </ul>
                                <p style="color: var(--text-secondary); font-size: 0.9em; margin-top: 10px;">Consider adding supplements to address deficiencies.</p>
                            </div>
                        ` : `
                            <div class="warnings-section success">
                                <h4>‚úì Nutritionally Complete</h4>
                                <p style="color: var(--text-primary);">This meal plan meets AAFCO nutritional guidelines for adult dogs.</p>
                            </div>
                        `}
                    `;
                    showToast('Batch meal plan calculated!', 'success');
                } else {
                    resultDiv.innerHTML = `<div class="warnings-section has-warnings"><h4>‚ö†Ô∏è Error</h4><p style="color: var(--text-primary);">${plan.detail || 'Could not calculate plan. Make sure you have a dog, recipe, and ingredients set up.'}</p></div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="warnings-section has-warnings"><h4>‚ö†Ô∏è Error</h4><p style="color: var(--text-primary);">Connection error. Please try again.</p></div>`;
            }
        });

        // Enter key for search
        document.getElementById('ingredient-search').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchIngredients();
            }
        });

        // ==================== Tracking Functions ====================

        async function loadTrackingData() {
            const dogId = document.getElementById('tracking-dog-select').value;
            if (!dogId) {
                document.getElementById('daily-summary').style.display = 'none';
                document.getElementById('todays-meals-list').innerHTML = '<p style="color: var(--text-muted);">Select a dog to view tracking data</p>';
                document.getElementById('weight-history-list').innerHTML = '';
                return;
            }

            // Load daily summary
            try {
                const dog = await db.getDog(dogId);
                const todayLogs = await db.getTodayFeedingLogs(dogId);
                const totalKcalFed = todayLogs.reduce((sum, log) => sum + (log.kcal_fed || 0), 0);
                const targetKcal = dog?.effective_daily_kcal || dog?.mer || 0;
                const remainingKcal = targetKcal - totalKcalFed;
                const onTrack = totalKcalFed <= targetKcal;

                document.getElementById('daily-summary').style.display = 'block';
                document.getElementById('summary-target').textContent = targetKcal.toFixed(0);
                document.getElementById('summary-fed').textContent = totalKcalFed.toFixed(0);
                document.getElementById('summary-remaining').textContent = Math.abs(remainingKcal).toFixed(0);

                const statusEl = document.getElementById('summary-status');
                if (onTrack) {
                    statusEl.style.background = 'rgba(16, 185, 129, 0.2)';
                    statusEl.style.color = '#10b981';
                    statusEl.innerHTML = '‚úì On track! ' + (remainingKcal > 0 ? `${remainingKcal.toFixed(0)} kcal remaining` : 'Daily target reached');
                } else {
                    statusEl.style.background = 'rgba(245, 158, 11, 0.2)';
                    statusEl.style.color = '#f59e0b';
                    statusEl.innerHTML = '‚ö†Ô∏è Over daily target by ' + Math.abs(remainingKcal).toFixed(0) + ' kcal';
                }
            } catch (err) {
                console.error('Error loading summary:', err);
            }

            // Load today's meals
            try {
                const meals = await db.getTodayFeedingLogs(dogId);
                const mealsList = document.getElementById('todays-meals-list');
                if (meals.length === 0) {
                    mealsList.innerHTML = '<p style="color: var(--text-muted);">No meals logged today</p>';
                } else {
                    mealsList.innerHTML = meals.map(meal => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                            <div>
                                <strong style="color: var(--text-primary);">${meal.meal_type || 'Meal'}</strong>
                                <span style="color: var(--text-secondary); margin-left: 12px;">${meal.kcal_fed} kcal</span>
                                ${meal.recipes?.name ? `<span style="color: var(--text-muted); margin-left: 8px;">(${meal.recipes.name})</span>` : ''}
                            </div>
                            <button class="btn btn-sm btn-delete" onclick="deleteFeedingLog(${meal.id})">‚úï</button>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error loading meals:', err);
            }

            // Load weight history
            try {
                const weights = await db.listWeightLogs(dogId, 10);
                const weightList = document.getElementById('weight-history-list');
                if (weights.length === 0) {
                    weightList.innerHTML = '<p style="color: var(--text-muted);">No weight history</p>';
                } else {
                    weightList.innerHTML = weights.map(w => {
                        const date = new Date(w.logged_at).toLocaleDateString();
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                            <div>
                                <strong style="color: var(--text-primary);">${displayWeight(w.weight_kg)}</strong>
                                <span style="color: var(--text-muted); margin-left: 12px;">${date}</span>
                                ${w.notes ? `<span style="color: var(--text-muted); margin-left: 8px;">- ${w.notes}</span>` : ''}
                            </div>
                        </div>
                    `}).join('');
                }
            } catch (err) {
                console.error('Error loading weight history:', err);
            }

            // Populate recipe select for logging
            try {
                const recipes = await db.listRecipes();
                document.getElementById('log-recipe').innerHTML = '<option value="">No recipe</option>' +
                    recipes.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            } catch (err) {
                console.error('Error loading recipes:', err);
            }
        }

        // Feeding log form
        document.getElementById('feeding-log-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dogId = document.getElementById('tracking-dog-select').value;
            if (!dogId) {
                showToast('Please select a dog first', 'error');
                return;
            }

            const recipeId = document.getElementById('log-recipe').value;
            const data = {
                dog_id: parseInt(dogId),
                recipe_id: recipeId ? parseInt(recipeId) : null,
                meal_type: document.getElementById('log-meal-type').value,
                kcal_fed: parseFloat(document.getElementById('log-kcal').value),
                notes: document.getElementById('log-notes').value || null
            };

            try {
                await db.createFeedingLog(data);
                document.getElementById('log-kcal').value = '';
                document.getElementById('log-notes').value = '';
                loadTrackingData();
                showToast('Meal logged successfully!', 'success');
            } catch (err) {
                showToast(err.message || 'Error logging meal', 'error');
            }
        });

        // Weight log form
        document.getElementById('weight-log-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const dogId = document.getElementById('tracking-dog-select').value;
            if (!dogId) {
                showToast('Please select a dog first', 'error');
                return;
            }

            const weightInput = parseFloat(document.getElementById('log-weight').value);
            const data = {
                dog_id: parseInt(dogId),
                weight_kg: inputToKg(weightInput),
                notes: document.getElementById('weight-log-notes').value || null
            };

            try {
                await db.createWeightLog(data);
                document.getElementById('log-weight').value = '';
                document.getElementById('weight-log-notes').value = '';
                loadTrackingData();
                loadDogs(); // Refresh dog list as weight is updated
                showToast('Weight logged successfully!', 'success');
            } catch (err) {
                showToast(err.message || 'Error logging weight', 'error');
            }
        });

        async function deleteFeedingLog(logId) {
            try {
                await db.deleteFeedingLog(logId);
                loadTrackingData();
                showToast('Meal log deleted', 'success');
            } catch (err) {
                showToast(err.message || 'Error deleting log', 'error');
            }
        }

        // ==================== Ingredient Guide Functions ====================

        function toggleCategory(header) {
            header.classList.toggle('expanded');
            const content = header.nextElementSibling;
            content.classList.toggle('show');
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const category = btn.dataset.category;
                document.querySelectorAll('.ingredient-category').forEach(cat => {
                    if (category === 'all' || cat.dataset.category === category) {
                        cat.style.display = 'block';
                    } else {
                        cat.style.display = 'none';
                    }
                });
            });
        });

        // Add to recipe modal
        let selectedIngredientName = '';

        function openAddToRecipeModal(ingredientName) {
            selectedIngredientName = ingredientName;
            document.getElementById('add-ingredient-name').textContent = ingredientName;
            document.getElementById('add-to-recipe-modal').classList.add('active');
            loadRecipesForModal();
        }

        function closeAddToRecipeModal() {
            document.getElementById('add-to-recipe-modal').classList.remove('active');
        }

        async function loadRecipesForModal() {
            try {
                const recipes = await db.listRecipes();
                const select = document.getElementById('modal-recipe-select');
                select.innerHTML = recipes.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            } catch (err) {
                console.error('Error loading recipes:', err);
            }
        }

        async function addIngredientToRecipe() {
            const recipeId = document.getElementById('modal-recipe-select').value;
            const grams = parseFloat(document.getElementById('modal-ingredient-grams').value);

            if (!recipeId || !grams) {
                showToast('Please select a recipe and enter amount', 'error');
                return;
            }

            // Search local database first, then USDA
            try {
                showToast('Searching for ingredient...', 'info');
                const localResults = await db.searchIngredients(selectedIngredientName);

                if (localResults.length > 0) {
                    // Use existing local ingredient
                    await db.addIngredientToRecipe(recipeId, localResults[0].id, grams);
                    showToast(`Added ${selectedIngredientName} to recipe!`, 'success');
                    closeAddToRecipeModal();
                    loadRecipes();
                } else {
                    // Search USDA and import
                    const usdaRes = await fetch(`${USDA_API_BASE}/foods/search?api_key=${USDA_API_KEY}&query=${encodeURIComponent(selectedIngredientName)}&pageSize=1`);
                    const usdaData = await usdaRes.json();

                    if (usdaData.foods && usdaData.foods.length > 0) {
                        await importFromUSDA(usdaData.foods[0].fdcId, usdaData.foods[0].description);
                        // Get the newly imported ingredient
                        const newIngredients = await db.searchIngredients(selectedIngredientName);
                        if (newIngredients.length > 0) {
                            await db.addIngredientToRecipe(recipeId, newIngredients[0].id, grams);
                            showToast(`Added ${selectedIngredientName} to recipe!`, 'success');
                            closeAddToRecipeModal();
                            loadRecipes();
                        }
                    } else {
                        showToast('Ingredient not found in USDA database', 'error');
                    }
                }
            } catch (err) {
                showToast(err.message || 'Error adding ingredient', 'error');
            }
        }

        // ==================== What If Simulator Functions ====================

        let simulatorData = {
            dog: null,
            recipe: null,
            originalAmounts: {},
            currentAmounts: {}
        };

        let macroChart = null;

        // Populate simulator dropdowns
        async function populateSimulatorDropdowns() {
            try {
                const [rawDogs, recipes] = await Promise.all([
                    db.listDogs(),
                    db.listRecipes()
                ]);
                const dogs = rawDogs.map(d => calculateDogNutrition(d));

                const dogSelect = document.getElementById('sim-dog');
                const recipeSelect = document.getElementById('sim-recipe');

                dogSelect.innerHTML = '<option value="">Select a dog...</option>' +
                    dogs.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

                recipeSelect.innerHTML = '<option value="">Select a recipe...</option>' +
                    recipes.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            } catch (err) {
                console.error('Error loading simulator data:', err);
            }
        }

        async function loadSimulatorRecipe() {
            const dogId = document.getElementById('sim-dog').value;
            const recipeId = document.getElementById('sim-recipe').value;

            if (!dogId || !recipeId) {
                document.getElementById('simulator-content').style.display = 'none';
                return;
            }

            try {
                const [dog, recipe] = await Promise.all([
                    db.getDog(dogId),
                    db.getRecipe(recipeId)
                ]);

                simulatorData.dog = dog;
                simulatorData.recipe = recipe;

                // Build adjustment inputs
                const adjustmentsDiv = document.getElementById('ingredient-adjustments');
                simulatorData.originalAmounts = {};
                simulatorData.currentAmounts = {};

                if (simulatorData.recipe.ingredients.length === 0) {
                    adjustmentsDiv.innerHTML = '<p style="color: var(--text-secondary);">This recipe has no ingredients. Add some first!</p>';
                    document.getElementById('simulator-content').style.display = 'block';
                    return;
                }

                adjustmentsDiv.innerHTML = simulatorData.recipe.ingredients.map(ing => {
                    simulatorData.originalAmounts[ing.ingredient_id] = ing.percentage;
                    simulatorData.currentAmounts[ing.ingredient_id] = ing.percentage;
                    return `
                        <div class="adjustment-row">
                            <label>${ing.ingredient_name}</label>
                            <span class="current-value">Current: ${ing.percentage}%</span>
                            <input type="number" id="adj-${ing.ingredient_id}" value="${ing.percentage}" min="0" max="100" step="0.5">
                            <span>%</span>
                        </div>
                    `;
                }).join('');

                document.getElementById('simulator-content').style.display = 'block';
                document.getElementById('simulation-results').style.display = 'none';

                // Show current nutrition
                await showCurrentNutrition();

            } catch (err) {
                console.error('Error loading recipe:', err);
                showToast('Error loading data', 'error');
            }
        }

        async function showCurrentNutrition() {
            // Calculate nutrition using frontend function
            try {
                const plan = await computeBatchPlan(simulatorData.dog.id, simulatorData.recipe.id, 0, 0, 1);

                const display = document.getElementById('current-nutrition-display');
                display.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                        <div style="text-align: center; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--primary);">${plan.target_kcal?.toFixed(0)}</div>
                            <div style="font-size: 0.8em; color: var(--text-secondary);">Target kcal</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--primary);">${plan.nutrients?.protein_g?.toFixed(1) || 0}g</div>
                            <div style="font-size: 0.8em; color: var(--text-secondary);">Protein</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--primary);">${plan.nutrients?.fat_g?.toFixed(1) || 0}g</div>
                            <div style="font-size: 0.8em; color: var(--text-secondary);">Fat</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 1.2em; font-weight: bold; color: var(--primary);">${plan.nutrients?.carbs_g?.toFixed(1) || 0}g</div>
                            <div style="font-size: 0.8em; color: var(--text-secondary);">Carbs</div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('Error showing current nutrition:', err);
            }
        }

        // Toggle kibble input section
        function toggleKibbleSection() {
            const toggle = document.getElementById('kibble-toggle');
            const inputs = document.getElementById('kibble-inputs');
            inputs.style.display = toggle.checked ? 'block' : 'none';
        }

        // Preview kibble carbs (NFE) in real-time
        function previewKibbleCarbs() {
            const protein = parseFloat(document.getElementById('kibble-protein').value) || 0;
            const fat = parseFloat(document.getElementById('kibble-fat').value) || 0;
            const fiber = parseFloat(document.getElementById('kibble-fiber').value) || 0;
            const moisture = parseFloat(document.getElementById('kibble-moisture').value) || 10;
            const ash = parseFloat(document.getElementById('kibble-ash').value) || 7;

            const nfe = 100 - (protein + fat + fiber + moisture + ash);
            const carbPct = Math.max(0, nfe);

            // Show NFE display
            const nfeDisplay = document.getElementById('kibble-nfe-display');
            document.getElementById('kibble-nfe-value').textContent = carbPct.toFixed(1) + '%';
            nfeDisplay.style.display = (protein || fat || fiber) ? 'block' : 'none';

            // High filler warning
            const warningDiv = document.getElementById('high-filler-warning');
            if (carbPct > 40) {
                document.getElementById('kibble-carb-display').textContent = carbPct.toFixed(0);
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        }

        async function runSimulation() {
            // Collect current percentage amounts
            const adjustments = [];
            simulatorData.recipe.ingredients.forEach(ing => {
                const input = document.getElementById(`adj-${ing.ingredient_id}`);
                const newPercentage = parseFloat(input.value) || 0;
                simulatorData.currentAmounts[ing.ingredient_id] = newPercentage;
                adjustments.push({
                    ingredient_id: ing.ingredient_id,
                    new_percentage: newPercentage
                });
            });

            // Build request body
            const requestBody = {
                dog_id: simulatorData.dog.id,
                recipe_id: simulatorData.recipe.id,
                ingredient_adjustments: adjustments
            };

            // Add kibble data if enabled
            const kibbleToggle = document.getElementById('kibble-toggle');
            if (kibbleToggle && kibbleToggle.checked) {
                const protein = parseFloat(document.getElementById('kibble-protein').value);
                const fat = parseFloat(document.getElementById('kibble-fat').value);
                const fiber = parseFloat(document.getElementById('kibble-fiber').value);
                const amount = parseFloat(document.getElementById('kibble-amount').value);

                if (protein && fat && fiber && amount) {
                    requestBody.kibble = {
                        protein_pct: protein,
                        fat_pct: fat,
                        fiber_pct: fiber,
                        moisture_pct: parseFloat(document.getElementById('kibble-moisture').value) || 10,
                        ash_pct: parseFloat(document.getElementById('kibble-ash').value) || 7,
                        amount_grams: amount,
                        calcium_pct: parseFloat(document.getElementById('kibble-calcium').value) || null,
                        phosphorus_pct: parseFloat(document.getElementById('kibble-phosphorus').value) || null
                    };
                } else {
                    showToast('Fill in Protein%, Fat%, Fiber%, and Amount for kibble', 'error');
                    return;
                }
            }

            try {
                // Perform simulation with adjusted percentages
                const result = await simulateNutrition(requestBody);
                displaySimulationResults(result);
            } catch (err) {
                showToast(err.message || 'Simulation failed', 'error');
            }
        }

        /**
         * Simulate nutrition changes (replaces /plan/simulate endpoint)
         */
        async function simulateNutrition(request) {
            const dog = await db.getDog(request.dog_id);
            const recipe = await db.getRecipe(request.recipe_id);

            if (!dog || !recipe) {
                throw new Error('Dog or recipe not found');
            }

            const targetKcal = dog.effective_daily_kcal || dog.mer;

            // Calculate "before" nutrition using original recipe
            const beforeIngredients = recipe.ingredients.map(i => ({
                ...i,
                percentage: i.percentage
            }));
            const beforeNutrients = aggregateNutrients(beforeIngredients, targetKcal);

            // Calculate "after" nutrition using adjusted percentages
            const adjustmentMap = {};
            request.ingredient_adjustments.forEach(adj => {
                adjustmentMap[adj.ingredient_id] = adj.new_percentage;
            });

            const afterIngredients = recipe.ingredients.map(i => ({
                ...i,
                percentage: adjustmentMap[i.ingredient_id] ?? i.percentage
            }));

            let freshNutrients = aggregateNutrients(afterIngredients, targetKcal);
            let kibbleNutrients = null;
            let combinedNutrients = { ...freshNutrients };

            // Add kibble if provided
            if (request.kibble) {
                kibbleNutrients = calculateKibbleNutrients(
                    request.kibble.protein_pct,
                    request.kibble.fat_pct,
                    request.kibble.fiber_pct,
                    request.kibble.moisture_pct,
                    request.kibble.ash_pct,
                    request.kibble.amount_grams,
                    request.kibble.calcium_pct,
                    request.kibble.phosphorus_pct
                );

                // Reduce fresh food by kibble calories
                const remainingKcal = Math.max(0, targetKcal - kibbleNutrients.kcal);
                freshNutrients = aggregateNutrients(afterIngredients, remainingKcal);

                combinedNutrients = combineNutrientTotals(kibbleNutrients, freshNutrients);
            }

            // Check AAFCO compliance
            const nutrientStatus = [];
            const warnings = [];
            const recommendations = [];

            const nutrientMap = {
                protein: combinedNutrients.protein_g,
                fat: combinedNutrients.fat_g,
                calcium: combinedNutrients.calcium_mg,
                phosphorus: combinedNutrients.phosphorus_mg,
                iron: combinedNutrients.iron_mg,
                zinc: combinedNutrients.zinc_mg,
                vitamin_a: combinedNutrients.vitamin_a_mcg,
                vitamin_d: combinedNutrients.vitamin_d_mcg,
                vitamin_e: combinedNutrients.vitamin_e_mg,
            };

            let overallStatus = 'excellent';

            for (const [nutrient, amount] of Object.entries(nutrientMap)) {
                const req = AAFCO_REQUIREMENTS[nutrient];
                if (req) {
                    const per1000 = nutrientPer1000kcal(amount, combinedNutrients.kcal || targetKcal);
                    const check = checkAAFCOCompliance(nutrient, per1000, req.min, req.max);
                    nutrientStatus.push(check);

                    if (check.status === 'deficient') {
                        warnings.push(check.warning);
                        overallStatus = overallStatus === 'dangerous' ? 'dangerous' : 'bad';
                    } else if (check.status === 'excess') {
                        warnings.push(check.warning);
                        overallStatus = 'dangerous';
                    }
                }
            }

            if (warnings.length === 0 && overallStatus !== 'dangerous') {
                overallStatus = 'excellent';
            } else if (overallStatus !== 'dangerous' && overallStatus !== 'bad') {
                overallStatus = 'good';
            }

            // Ca:P ratio analysis
            const caPAnalysis = analyzeCaPRatio(combinedNutrients.calcium_mg, combinedNutrients.phosphorus_mg);
            if (caPAnalysis.status === 'low') {
                recommendations.push(caPAnalysis.message);
            }

            // Format nutrients for response
            const formatNutrients = (n) => ({
                kcal: n.kcal || 0,
                protein_g: n.protein_g || 0,
                fat_g: n.fat_g || 0,
                carbs_g: n.carbs_g || 0,
                calcium_mg: n.calcium_mg || 0,
                phosphorus_mg: n.phosphorus_mg || 0,
                iron_mg: n.iron_mg || 0,
                zinc_mg: n.zinc_mg || 0,
                vitamin_a_mcg: n.vitamin_a_mcg || 0,
                vitamin_d_mcg: n.vitamin_d_mcg || 0,
                vitamin_e_mg: n.vitamin_e_mg || 0,
            });

            return {
                before: formatNutrients(beforeNutrients),
                after: {
                    kibble: kibbleNutrients ? formatNutrients(kibbleNutrients) : null,
                    fresh: formatNutrients(freshNutrients),
                    combined: formatNutrients(combinedNutrients),
                },
                nutrient_status: nutrientStatus,
                overall_status: overallStatus,
                warnings,
                recommendations,
                ca_p_analysis: caPAnalysis,
                kibble_analysis: kibbleNutrients ? {
                    carb_pct: kibbleNutrients.nfe_pct,
                    high_filler: kibbleNutrients.nfe_pct > 40
                } : null,
            };
        }

        let sourceBreakdownChart = null;

        function displaySimulationResults(result) {
            document.getElementById('simulation-results').style.display = 'block';

            // Overall status card
            const statusIcons = {
                excellent: 'üåü',
                good: '‚úÖ',
                caution: '‚ö†Ô∏è',
                bad: '‚ö†Ô∏è',
                dangerous: 'üö®'
            };
            const statusMessages = {
                excellent: 'Excellent! This meal is well-balanced and meets all nutritional requirements.',
                good: 'Good! This meal meets minimum requirements.',
                caution: 'Caution: Some nutrients are approaching limits.',
                bad: 'Warning: Some nutrients are deficient.',
                dangerous: 'DANGER: Some nutrients exceed safe limits!'
            };

            document.getElementById('overall-status-card').innerHTML = `
                <div class="status-card-large">
                    <div class="status-icon">${statusIcons[result.overall_status]}</div>
                    <h3>Overall Status: <span class="status-badge ${result.overall_status}">${result.overall_status.toUpperCase()}</span></h3>
                    <p>${statusMessages[result.overall_status]}</p>
                </div>
            `;

            // Source breakdown stacked bar chart (Kibble vs Fresh)
            const ctx = document.getElementById('source-breakdown-chart').getContext('2d');
            if (sourceBreakdownChart) sourceBreakdownChart.destroy();
            if (macroChart) macroChart.destroy();

            const hasKibble = result.after.kibble !== null;
            const kibble = result.after.kibble || { protein_g: 0, fat_g: 0, carbs_g: 0, kcal: 0 };
            const fresh = result.after.fresh;
            const combined = result.after.combined;

            sourceBreakdownChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Calories (kcal)', 'Protein (g)', 'Fat (g)', 'Carbs (g)'],
                    datasets: [
                        {
                            label: 'Kibble',
                            data: [kibble.kcal, kibble.protein_g, kibble.fat_g, kibble.carbs_g],
                            backgroundColor: '#f59e0b',
                        },
                        {
                            label: 'Fresh',
                            data: [fresh.kcal, fresh.protein_g, fresh.fat_g, fresh.carbs_g],
                            backgroundColor: '#10b981',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { stacked: true, ticks: { color: 'rgba(255,255,255,0.7)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { stacked: true, ticks: { color: 'rgba(255,255,255,0.7)' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    },
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.dataset.label;
                                    const value = context.raw;
                                    return `${label}: ${value.toFixed(1)}`;
                                }
                            }
                        }
                    }
                }
            });

            // Show/hide legend based on kibble presence
            document.getElementById('source-legend').style.display = hasKibble ? 'flex' : 'none';

            // Ca:P Ratio display
            if (result.ca_p_analysis) {
                const caP = result.ca_p_analysis;
                const caPCard = document.getElementById('ca-p-card');
                caPCard.style.display = 'block';

                const statusColors = {
                    optimal: '#10b981',
                    acceptable: '#22c55e',
                    low: '#f97316',
                    high: '#eab308',
                    unknown: '#6b7280'
                };

                document.getElementById('ca-p-display').innerHTML = `
                    <div style="display: flex; justify-content: space-around; text-align: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <div style="font-size: 2rem; color: var(--text-primary); font-weight: 700;">${caP.ca_p_ratio.toFixed(2)}:1</div>
                            <div style="color: var(--text-secondary);">Ca:P Ratio</div>
                        </div>
                        <div>
                            <div style="font-size: 1.2rem; color: var(--text-primary);">${caP.total_calcium_mg.toFixed(0)}mg</div>
                            <div style="color: var(--text-secondary);">Total Calcium</div>
                        </div>
                        <div>
                            <div style="font-size: 1.2rem; color: var(--text-primary);">${caP.total_phosphorus_mg.toFixed(0)}mg</div>
                            <div style="color: var(--text-secondary);">Total Phosphorus</div>
                        </div>
                    </div>
                    <div style="padding: 12px; background: rgba(${caP.status === 'low' ? '249, 115, 22' : caP.status === 'high' ? '234, 179, 8' : '16, 185, 129'}, 0.2); border-radius: 8px; border-left: 4px solid ${statusColors[caP.status]};">
                        <p style="color: var(--text-primary); margin: 0;">${caP.message}</p>
                        ${caP.eggshell_recommendation_g ? `
                            <p style="color: var(--text-secondary); margin: 8px 0 0 0; font-size: 0.9rem;">
                                <strong>Recommendation:</strong> Add ${caP.eggshell_recommendation_g.toFixed(1)}g eggshell powder (${(caP.eggshell_recommendation_g / 5).toFixed(1)} tsp)
                            </p>
                        ` : ''}
                    </div>
                `;
            } else {
                document.getElementById('ca-p-card').style.display = 'none';
            }

            // Nutrient bars (using combined totals)
            const barsHtml = result.nutrient_status.map(ns => {
                const displayPct = ns.percent_of_min > 100 ? Math.min(ns.percent_of_min, 150) : ns.percent_of_min;
                return `
                    <div class="nutrient-bar-container">
                        <div class="nutrient-bar-label">
                            <span>${ns.nutrient}</span>
                            <span class="status-badge ${ns.status}">${ns.status}</span>
                        </div>
                        <div class="nutrient-bar-track">
                            <div class="nutrient-bar-fill ${ns.status}" style="width: ${Math.min(displayPct, 100)}%">
                                ${ns.percent_of_min.toFixed(0)}%
                            </div>
                            <div class="nutrient-bar-marker" style="left: 100%;" title="100% of minimum"></div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('nutrient-bars').innerHTML = barsHtml;

            // Change summary (comparing before fresh to combined after)
            const changes = [];
            const before = result.before;
            const after = result.after.combined;

            if (Math.abs(after.kcal - before.kcal) > 1) {
                const diff = after.kcal - before.kcal;
                changes.push(`Calories: ${diff > 0 ? '+' : ''}${diff.toFixed(0)} kcal (now ${after.kcal.toFixed(0)} kcal)`);
            }
            if (Math.abs(after.protein_g - before.protein_g) > 0.5) {
                const diff = after.protein_g - before.protein_g;
                changes.push(`Protein: ${diff > 0 ? '+' : ''}${diff.toFixed(1)}g (now ${after.protein_g.toFixed(1)}g)`);
            }
            if (Math.abs(after.fat_g - before.fat_g) > 0.5) {
                const diff = after.fat_g - before.fat_g;
                changes.push(`Fat: ${diff > 0 ? '+' : ''}${diff.toFixed(1)}g (now ${after.fat_g.toFixed(1)}g)`);
            }

            // Add kibble analysis info if present
            if (result.kibble_analysis) {
                const ka = result.kibble_analysis;
                changes.push(`Kibble contributes: ${ka.kcal_from_kibble.toFixed(0)} kcal, ${ka.protein_g.toFixed(1)}g protein, ${ka.fat_g.toFixed(1)}g fat, ${ka.carbs_g.toFixed(1)}g carbs`);
            }

            document.getElementById('change-summary').innerHTML = `
                <h3 style="color: var(--text-primary); margin-bottom: 15px;">üìä What Changed</h3>
                ${changes.length > 0 ? `
                    <ul style="color: var(--text-primary); margin: 0; padding-left: 20px;">
                        ${changes.map(c => `<li style="margin-bottom: 8px;">${c}</li>`).join('')}
                    </ul>
                ` : '<p style="color: var(--text-secondary);">No significant changes detected.</p>'}
                ${result.warnings.length > 0 ? `
                    <div style="margin-top: 15px; padding: 10px; background: rgba(239, 68, 68, 0.2); border-radius: 8px;">
                        <strong style="color: #ef4444;">Warnings:</strong>
                        <ul style="color: #fca5a5; margin: 5px 0 0 0; padding-left: 20px;">
                            ${result.warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                ${result.recommendations.length > 0 ? `
                    <div style="margin-top: 15px; padding: 10px; background: rgba(16, 185, 129, 0.2); border-radius: 8px;">
                        <strong style="color: #10b981;">Recommendations:</strong>
                        <ul style="color: #6ee7b7; margin: 5px 0 0 0; padding-left: 20px;">
                            ${result.recommendations.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            `;
        }

        function resetSimulator() {
            simulatorData.recipe.ingredients.forEach(ing => {
                const input = document.getElementById(`adj-${ing.ingredient_id}`);
                input.value = simulatorData.originalAmounts[ing.ingredient_id];
            });
            document.getElementById('simulation-results').style.display = 'none';
            // Also reset kibble inputs
            document.getElementById('kibble-toggle').checked = false;
            toggleKibbleSection();
            document.getElementById('kibble-protein').value = '';
            document.getElementById('kibble-fat').value = '';
            document.getElementById('kibble-fiber').value = '';
            document.getElementById('kibble-moisture').value = '10';
            document.getElementById('kibble-ash').value = '7';
            document.getElementById('kibble-amount').value = '';
            document.getElementById('kibble-calcium').value = '';
            document.getElementById('kibble-phosphorus').value = '';
            document.getElementById('kibble-nfe-display').style.display = 'none';
            document.getElementById('high-filler-warning').style.display = 'none';
            showToast('Reset to original amounts', 'info');
        }

        // Initialize simulator dropdowns when tab is shown
        const simulatorTab = document.querySelector('[data-tab="simulator"]');
        if (simulatorTab) {
            simulatorTab.addEventListener('click', populateSimulatorDropdowns);
        }
    </script>
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase JS Client for Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Sticky Disclaimer -->
    <div class="sticky-disclaimer">
        <strong>Disclaimer:</strong> Not a substitute for actual veterinary advice. Consult with your trusted veterinarian before making any dietary changes to your pet's feeding routine.
    </div>
</body>
</html>
